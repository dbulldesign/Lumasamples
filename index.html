<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LumaSamples ‚Äî Fixture Library</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
:root {
  --bg: #0a0a0c;
  --surface: #111114;
  --surface2: #18181c;
  --surface3: #202025;
  --accent: #f5c842;
  --accent-dim: rgba(245,200,66,0.12);
  --accent2: #ff6b35;
  --text: #eeeee8;
  --text2: #8a8880;
  --text3: #44443e;
  --border: #222228;
  --border2: #2e2e35;
  --green: #4ade80;
  --green-dim: rgba(74,222,128,0.1);
  --red: #f87171;
  --red-dim: rgba(248,113,113,0.1);
  --blue: #60a5fa;
  --radius: 14px;
  --radius-sm: 9px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ LOGIN CHECKED-OUT BOARD ‚îÄ‚îÄ */
.login-co-row {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--red);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  margin-bottom: 6px;
  transition: border-color 0.15s, background 0.15s;
}
.login-co-row:hover { background: var(--surface2); border-color: var(--border2); }
.login-co-id   { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--accent); background: var(--accent-dim); padding: 2px 6px; border-radius: 4px; white-space: nowrap; }
.login-co-name { font-size: 13px; font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.login-co-user { font-size: 11px; color: var(--text2); white-space: nowrap; }
.login-co-time { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text3); white-space: nowrap; }

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
#login-screen {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
  background: var(--bg);
  position: relative;
  overflow: hidden;
}
#login-screen::before {
  content: '';
  position: absolute;
  top: -200px; left: 50%; transform: translateX(-50%);
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(245,200,66,0.06) 0%, transparent 70%);
  pointer-events: none;
}
.login-logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 52px;
  letter-spacing: 4px;
  color: var(--accent);
  margin-bottom: 4px;
  text-align: center;
}
.login-sub {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  letter-spacing: 3px;
  color: var(--text3);
  text-transform: uppercase;
  margin-bottom: 40px;
  text-align: center;
}
.user-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 12px;
  width: 100%;
  max-width: 560px;
  margin-bottom: 16px;
}
.user-login-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 12px 16px;
  cursor: pointer;
  text-align: center;
  transition: all 0.18s;
  position: relative;
  overflow: hidden;
}
.user-login-card:hover {
  border-color: var(--accent);
  background: var(--surface2);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(245,200,66,0.08);
}
.user-login-card.admin-card { border-color: rgba(96,165,250,0.25); }
.user-login-card.admin-card:hover { border-color: var(--blue); box-shadow: 0 8px 24px rgba(96,165,250,0.1); }
.ulc-avatar { font-size: 30px; margin-bottom: 10px; display: block; }
.ulc-name { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.ulc-role {
  font-size: 10px;
  font-family: 'DM Mono', monospace;
  padding: 2px 7px;
  border-radius: 10px;
  display: inline-block;
}
.ulc-role.admin { background: rgba(96,165,250,0.15); color: var(--blue); }
.ulc-role.user { background: var(--surface3); color: var(--text3); }

/* PIN PAD */
.pin-screen {
  width: 100%;
  max-width: 320px;
  animation: fadeSlideUp 0.25s ease;
}
@keyframes fadeSlideUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:none; } }
.pin-header {
  text-align: center;
  margin-bottom: 28px;
}
.pin-avatar { font-size: 40px; margin-bottom: 8px; }
.pin-name { font-size: 20px; font-weight: 600; }
.pin-hint { font-size: 12px; color: var(--text2); margin-top: 4px; }
.pin-dots {
  display: flex;
  gap: 14px;
  justify-content: center;
  margin-bottom: 28px;
}
.pin-dot {
  width: 14px; height: 14px;
  border-radius: 50%;
  border: 2px solid var(--border2);
  transition: all 0.15s;
}
.pin-dot.filled { background: var(--accent); border-color: var(--accent); }
.pin-dot.error { background: var(--red); border-color: var(--red); animation: shake 0.4s ease; }
@keyframes shake { 0%,100%{transform:none} 20%{transform:translateX(-4px)} 40%{transform:translateX(4px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
.pin-pad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 16px;
}
.pin-key {
  aspect-ratio: 1;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 22px;
  font-weight: 600;
  color: var(--text);
  cursor: pointer;
  transition: all 0.12s;
  display: flex; align-items: center; justify-content: center;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}
.pin-key:hover { background: var(--surface3); border-color: var(--border2); }
.pin-key:active { transform: scale(0.93); background: var(--surface3); }
.pin-key.del { font-size: 18px; color: var(--text2); }
.pin-back-btn {
  width: 100%;
  background: none;
  border: none;
  color: var(--text3);
  font-size: 13px;
  cursor: pointer;
  padding: 8px;
  font-family: 'DM Sans', sans-serif;
  transition: color 0.15s;
}
.pin-back-btn:hover { color: var(--text2); }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  height: 58px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}
.logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 24px;
  letter-spacing: 2px;
  color: var(--accent);
}
.logo-sub { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text3); letter-spacing: 2px; margin-left: 8px; text-transform: uppercase; }
.header-right { display: flex; align-items: center; gap: 10px; }
.user-chip {
  background: var(--surface3);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 5px 12px 5px 8px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  display: flex; align-items: center; gap: 6px;
  transition: all 0.15s;
}
.user-chip:hover { border-color: var(--text3); color: var(--text); }
.user-chip .chip-avatar { font-size: 16px; }
.role-badge {
  font-size: 9px;
  font-family: 'DM Mono', monospace;
  padding: 1px 6px;
  border-radius: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.role-badge.admin { background: rgba(96,165,250,0.15); color: var(--blue); }
.role-badge.user { background: var(--surface2); color: var(--text3); }

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.nav-tabs {
  display: flex;
  gap: 0;
  padding: 0 24px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  overflow-x: auto;
  scrollbar-width: none;
}
.nav-tabs::-webkit-scrollbar { display: none; }
.nav-tab {
  padding: 14px 18px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text3);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  white-space: nowrap;
  transition: all 0.2s;
  display: flex; align-items: center; gap: 6px;
}
.nav-tab:hover { color: var(--text2); }
.nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.nav-tab .tab-icon { font-size: 14px; }
.nav-tab.admin-tab { color: rgba(96,165,250,0.5); }
.nav-tab.admin-tab.active { color: var(--blue); border-bottom-color: var(--blue); }
.nav-tab.admin-tab:hover { color: var(--blue); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main { padding: 24px; max-width: 1400px; margin: 0 auto; }
.page { display: none; }
.page.active { display: block; }

/* ‚îÄ‚îÄ HOMEPAGE: CURRENTLY OUT ‚îÄ‚îÄ */
.home-hero {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 28px;
}
@media (max-width: 640px) { .home-hero { grid-template-columns: 1fr 1fr; } }
.hero-stat {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 22px;
}
.hero-stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text3); font-family: 'DM Mono', monospace; margin-bottom: 6px; }
.hero-stat-val { font-size: 42px; font-family: 'Bebas Neue', sans-serif; line-height: 1; }
.hero-stat-val.accent { color: var(--accent); }
.hero-stat-val.green { color: var(--green); }
.hero-stat-val.red { color: var(--red); }
.hero-stat-val.blue { color: var(--blue); }

.section-heading {
  font-size: 11px;
  font-family: 'DM Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text3);
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 10px;
}
.section-heading::after { content:''; flex:1; height:1px; background:var(--border); }

/* CHECKED OUT LIST */
.checked-out-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 32px; }
.co-row {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--red);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  display: grid;
  grid-template-columns: auto 1fr auto auto;
  align-items: center;
  gap: 14px;
  transition: border-color 0.2s;
}
.co-row:hover { border-color: var(--border2); border-left-color: var(--red); }
.co-id { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--accent); background: var(--accent-dim); padding: 3px 8px; border-radius: 5px; white-space: nowrap; }
.co-info { min-width: 0; }
.co-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.co-meta { font-size: 11px; color: var(--text2); margin-top: 2px; }
.co-user {
  display: flex; align-items: center; gap: 6px;
  background: var(--surface2);
  border-radius: 20px;
  padding: 4px 10px 4px 6px;
  font-size: 12px;
  white-space: nowrap;
}
.co-user .avatar { font-size: 14px; }
.co-time { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text3); white-space: nowrap; }

/* My checkouts widget on home */
.my-co-strip {
  background: linear-gradient(135deg, rgba(245,200,66,0.06), rgba(245,200,66,0.02));
  border: 1px solid rgba(245,200,66,0.15);
  border-radius: var(--radius);
  padding: 16px 20px;
  margin-bottom: 28px;
}
.my-co-strip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.my-co-strip-title { font-size: 13px; font-weight: 600; color: var(--accent); }
.my-co-items { display: flex; flex-wrap: wrap; gap: 8px; }
.my-co-pill {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 12px;
  display: flex; align-items: center; gap: 6px;
  cursor: pointer;
  transition: all 0.15s;
}
.my-co-pill:hover { border-color: var(--red); color: var(--red); }
.my-co-pill .pill-id { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text3); }

/* ‚îÄ‚îÄ STATS BAR ‚îÄ‚îÄ */
.stats-bar {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 10px;
  margin-bottom: 22px;
}
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 18px;
}
.stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); font-family: 'DM Mono', monospace; }
.stat-value { font-size: 26px; font-family: 'Bebas Neue', sans-serif; margin-top: 2px; }

/* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
.toolbar { display: flex; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
.search-box {
  flex: 1; min-width: 200px;
  display: flex; align-items: center;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0 14px; gap: 8px;
}
.search-box input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-size: 14px; padding: 10px 0;
  font-family: 'DM Sans', sans-serif;
}
.search-box input::placeholder { color: var(--text3); }
.filter-select {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 12px;
  color: var(--text2); font-size: 13px;
  font-family: 'DM Sans', sans-serif; outline: none; cursor: pointer;
}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  padding: 9px 16px; border-radius: var(--radius-sm); border: none;
  font-size: 13px; font-weight: 600; cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  display: inline-flex; align-items: center; gap: 6px;
  transition: all 0.15s; white-space: nowrap;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-primary:hover { background: #ffd84a; }
.btn-secondary { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
.btn-secondary:hover { color: var(--text); border-color: var(--border2); }
.btn-danger { background: var(--red-dim); color: var(--red); border: 1px solid rgba(248,113,113,0.2); }
.btn-danger:hover { background: rgba(248,113,113,0.18); }
.btn-success { background: var(--green-dim); color: var(--green); border: 1px solid rgba(74,222,128,0.2); }
.btn-success:hover { background: rgba(74,222,128,0.18); }
.btn-scan { background: var(--accent2); color: #fff; }
.btn-scan:hover { background: #ff7c47; }
.btn-blue { background: rgba(96,165,250,0.12); color: var(--blue); border: 1px solid rgba(96,165,250,0.2); }
.btn-blue:hover { background: rgba(96,165,250,0.2); }
.btn-sm { padding: 6px 11px; font-size: 12px; }
.btn-icon { padding: 8px; aspect-ratio:1; justify-content:center; }

/* ‚îÄ‚îÄ FIXTURE GRID ‚îÄ‚îÄ */
.fixture-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
  gap: 14px;
}
.fixture-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color 0.2s, transform 0.15s, box-shadow 0.15s;
  cursor: pointer;
}
.fixture-card:hover { border-color: var(--border2); transform: translateY(-2px); box-shadow: var(--shadow); }
.fixture-card.out { border-left: 3px solid rgba(248,113,113,0.4); }
.fixture-card.available { border-left: 3px solid rgba(74,222,128,0.25); }
.card-top {
  padding: 13px 14px 10px;
  display: flex; justify-content: space-between; align-items: flex-start;
}
.fid { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--accent); background: var(--accent-dim); padding: 2px 7px; border-radius: 4px; }
.sbadge {
  font-size: 9px; font-weight: 700; padding: 3px 8px;
  border-radius: 10px; text-transform: uppercase; letter-spacing: 0.5px;
}
.sbadge.available { background: var(--green-dim); color: var(--green); }
.sbadge.out { background: var(--red-dim); color: var(--red); }
.card-body { padding: 0 14px 12px; }
.card-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
.card-meta { font-size: 11px; color: var(--text2); display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }
.card-loc { font-size: 10px; color: var(--text3); font-family: 'DM Mono', monospace; }
.card-co-info {
  background: var(--red-dim); border-radius: 6px;
  padding: 7px 10px; font-size: 11px; color: var(--text2); margin-top: 8px;
}
.card-co-info strong { color: var(--red); }
.card-footer {
  padding: 9px 14px; border-top: 1px solid var(--border);
  display: flex; gap: 7px;
}
.card-footer .btn { flex: 1; justify-content: center; font-size: 11px; padding: 7px 8px; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.75);
  display: none; align-items: center; justify-content: center;
  z-index: 1000; padding: 20px;
  backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 18px;
  width: 100%; max-width: 500px;
  max-height: 92vh; overflow-y: auto;
  animation: modalIn 0.2s ease;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
}
@keyframes modalIn { from { opacity:0; transform:scale(0.94) translateY(12px); } to { opacity:1; transform:none; } }
.modal-header {
  padding: 18px 22px 14px;
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; background: var(--surface); border-radius: 18px 18px 0 0;
}
.modal-title { font-size: 16px; font-weight: 600; }
.modal-close { background: none; border: none; color: var(--text3); font-size: 22px; cursor: pointer; line-height: 1; padding: 2px 6px; border-radius: 6px; }
.modal-close:hover { color: var(--text); background: var(--surface3); }
.modal-body { padding: 18px 22px; }
.modal-footer { padding: 14px 22px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-group { margin-bottom: 14px; }
.form-label { display: block; font-size: 11px; font-weight: 500; color: var(--text2); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'DM Mono', monospace; }
.form-input {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 12px;
  color: var(--text); font-size: 14px; font-family: 'DM Sans', sans-serif;
  outline: none; transition: border-color 0.2s;
}
.form-input:focus { border-color: var(--accent); }
.form-input::placeholder { color: var(--text3); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* ‚îÄ‚îÄ QR ‚îÄ‚îÄ */
.qr-print-block { background: white; border-radius: 10px; padding: 18px; display: inline-flex; flex-direction: column; align-items: center; gap: 8px; }
.qr-print-id { font-family: 'DM Mono', monospace; font-size: 16px; font-weight: 700; color: #111; letter-spacing: 2px; }
.qr-print-name { font-size: 12px; color: #444; text-align: center; max-width: 160px; }

/* ‚îÄ‚îÄ SCANNER ‚îÄ‚îÄ */
#qr-reader { width: 100% !important; }

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap { overflow-x: auto; border-radius: var(--radius-sm); border: 1px solid var(--border); }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead { background: var(--surface2); }
th { text-align: left; padding: 10px 14px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); font-family: 'DM Mono', monospace; white-space: nowrap; }
td { padding: 11px 14px; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text2); }
tr:last-child td { border-bottom: none; }
tr:hover td { background: var(--surface2); }
.mono { font-family: 'DM Mono', monospace; color: var(--accent); font-size: 11px; }

/* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ */
.admin-section { margin-bottom: 32px; }
.admin-section-title {
  font-size: 14px; font-weight: 600; margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px; color: var(--blue);
}

/* USER MANAGEMENT TABLE */
.user-row {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
}
.ur-avatar { font-size: 22px; }
.ur-info { flex: 1; }
.ur-name { font-size: 14px; font-weight: 500; }
.ur-pin { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text3); }
.ur-actions { display: flex; gap: 6px; }

/* ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ */
.print-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
.print-card { background: white; border-radius: 10px; padding: 18px; text-align: center; }
.print-card .pname { font-size: 13px; font-weight: 700; color: #111; margin-top: 8px; font-family: 'DM Sans', sans-serif; }
.print-card .pid { font-family: 'DM Mono', monospace; font-size: 11px; color: #555; }
.print-card .pbrand { font-size: 10px; color: #888; }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state { text-align: center; padding: 50px 20px; color: var(--text3); }
.empty-state .icon { font-size: 40px; margin-bottom: 12px; }
.empty-state p { font-size: 14px; }

/* ‚îÄ‚îÄ SETUP PAGE ‚îÄ‚îÄ */
.setup-card {
  display: flex;
  gap: 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 14px;
  align-items: flex-start;
  transition: border-color 0.2s;
}
.setup-card:hover { border-color: var(--border2); }
.setup-card-num {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--accent); color: #000;
  font-weight: 700; font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-top: 2px;
}
.setup-card-body { flex: 1; min-width: 0; }
.setup-card-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
.setup-card-desc  { font-size: 13px; color: var(--text2); line-height: 1.7; }

/* ‚îÄ‚îÄ SYNC STATUS ‚îÄ‚îÄ */
#sync-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 500;
  background: var(--surface2); border-top: 1px solid var(--border);
  padding: 6px 16px; display: flex; align-items: center; gap: 8px;
  font-size: 11px; font-family: 'DM Mono', monospace; color: var(--text3);
  transform: translateY(100%); transition: transform 0.3s ease;
}
#sync-bar.show { transform: translateY(0); }
#sync-bar.syncing { color: var(--accent); border-top-color: rgba(245,200,66,0.3); }
#sync-bar.synced  { color: var(--green);  border-top-color: rgba(74,222,128,0.3); }
#sync-bar.error   { color: var(--red);    border-top-color: rgba(248,113,113,0.3); }
#sync-bar.offline { color: var(--text3);  }
.sync-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
.sync-dot.pulse { animation: syncPulse 1s infinite; }
@keyframes syncPulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* ‚îÄ‚îÄ SETUP MODAL ‚îÄ‚îÄ */
.setup-step { display:flex; gap:12px; margin-bottom:20px; }
.setup-num  { width:28px; height:28px; border-radius:50%; background:var(--accent); color:#000; font-weight:700; font-size:13px; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:2px; }
.setup-content { flex:1; }
.setup-title { font-size:14px; font-weight:600; margin-bottom:4px; }
.setup-desc  { font-size:12px; color:var(--text2); line-height:1.6; }
.code-block  { background:var(--surface3); border:1px solid var(--border2); border-radius:6px; padding:10px 12px; font-family:'DM Mono',monospace; font-size:11px; color:var(--accent); margin-top:8px; word-break:break-all; }

/* ‚îÄ‚îÄ SYNC STATUS ‚îÄ‚îÄ */
#sync-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 500;
  background: var(--surface2); border-top: 1px solid var(--border);
  padding: 6px 16px; display: flex; align-items: center; gap: 8px;
  font-size: 11px; font-family: 'DM Mono', monospace; color: var(--text3);
  transform: translateY(100%); transition: transform 0.3s ease;
}
#sync-bar.show { transform: translateY(0); }
#sync-bar.syncing { color: var(--accent); border-top-color: rgba(245,200,66,0.3); }
#sync-bar.synced  { color: var(--green);  border-top-color: rgba(74,222,128,0.3); }
#sync-bar.error   { color: var(--red);    border-top-color: rgba(248,113,113,0.3); }
#sync-bar.offline { color: var(--text3);  }
.sync-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
.sync-dot.pulse { animation: syncPulse 1s infinite; }
@keyframes syncPulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
.setup-step { display:flex; gap:12px; margin-bottom:20px; }
.setup-num  { width:28px; height:28px; border-radius:50%; background:var(--accent); color:#000; font-weight:700; font-size:13px; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:2px; }
.setup-content { flex:1; }
.setup-title { font-size:14px; font-weight:600; margin-bottom:4px; }
.setup-desc  { font-size:12px; color:var(--text2); line-height:1.6; }
.code-block  { background:var(--surface3); border:1px solid var(--border2); border-radius:6px; padding:10px 12px; font-family:'DM Mono',monospace; font-size:11px; color:var(--accent); margin-top:8px; word-break:break-all; cursor:pointer; }
.code-block:hover { border-color:var(--accent); }

/* ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ */
.notif {
  position: fixed; bottom: 20px; right: 20px;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: var(--radius); padding: 12px 16px;
  font-size: 13px; max-width: 300px; z-index: 3000;
  display: none; animation: slideUp 0.25s ease;
  box-shadow: var(--shadow);
}
.notif.show { display: block; }
.notif.success { border-color: rgba(74,222,128,0.4); background: rgba(74,222,128,0.08); color: var(--green); }
.notif.error { border-color: rgba(248,113,113,0.4); background: rgba(248,113,113,0.08); color: var(--red); }
.notif.info { border-color: rgba(96,165,250,0.3); background: rgba(96,165,250,0.06); color: var(--blue); }
@keyframes slideUp { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:none; } }

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media (max-width: 580px) {
  main { padding: 14px; }
  .form-row { grid-template-columns: 1fr; }
  .co-row { grid-template-columns: auto 1fr; gap: 10px; }
  .co-user, .co-time { display: none; }
  header { padding: 0 14px; }
  .nav-tabs { padding: 0 14px; }
  .stats-bar { grid-template-columns: 1fr 1fr; }
  .home-hero { grid-template-columns: 1fr 1fr; }
}

@media print {
  body { background: white !important; }
  #login-screen, header, .nav-tabs, .toolbar, .stats-bar, .home-hero,
  .card-footer, .btn, .notif, .modal-overlay { display: none !important; }
  .print-grid { display: grid !important; }
  .fixture-grid { display: none; }
  #page-print { display: block !important; }
}

/* ‚îÄ‚îÄ CONFIRM DIALOG ‚îÄ‚îÄ */
.confirm-box {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 20px;
  margin-top: 16px;
}
.confirm-box p { font-size: 14px; color: var(--text2); margin-bottom: 14px; }

/* Section divider */
.divider { height: 1px; background: var(--border); margin: 24px 0; }

/* ‚îÄ‚îÄ LOCATION COMBO ‚îÄ‚îÄ */
.loc-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 200;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: var(--radius-sm); max-height: 200px; overflow-y: auto;
  box-shadow: var(--shadow); margin-top: 4px;
}
.loc-option {
  padding: 9px 14px; font-size: 13px; cursor: pointer;
  color: var(--text2); transition: background 0.1s;
  border-bottom: 1px solid var(--border);
}
.loc-option:last-child { border-bottom: none; }
.loc-option:hover { background: var(--surface3); color: var(--text); }
.loc-option.add-new { color: var(--accent); font-style: italic; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-logo" onclick="adminQuickLogin()" style="cursor:pointer;user-select:none;" title="Admin access">LumaSamples</div>
  <div class="login-sub">Lighting Fixture Library</div>

  <!-- Checked out board -->
  <div id="login-co-board" style="width:100%;max-width:560px;margin-bottom:28px;display:none;">
    <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:8px;">
      <span>Currently Checked Out</span>
      <span style="flex:1;height:1px;background:var(--border);display:inline-block;"></span>
      <span id="login-co-count" style="background:var(--red-dim);color:var(--red);padding:1px 7px;border-radius:8px;font-size:9px;"></span>
    </div>
    <div id="login-co-list"></div>
  </div>

  <!-- User selection -->
  <div id="login-user-grid" class="user-cards"></div>
  <div id="pin-entry" style="display:none;" class="pin-screen">
    <div class="pin-header">
      <div class="pin-avatar" id="pin-avatar"></div>
      <div class="pin-name" id="pin-name"></div>
      <div class="pin-hint">Enter your PIN</div>
    </div>
    <div class="pin-dots" id="pin-dots">
      <div class="pin-dot" id="d0"></div>
      <div class="pin-dot" id="d1"></div>
      <div class="pin-dot" id="d2"></div>
      <div class="pin-dot" id="d3"></div>
    </div>
    <div class="pin-pad">
      <button class="pin-key" onclick="pinPress('1')">1</button>
      <button class="pin-key" onclick="pinPress('2')">2</button>
      <button class="pin-key" onclick="pinPress('3')">3</button>
      <button class="pin-key" onclick="pinPress('4')">4</button>
      <button class="pin-key" onclick="pinPress('5')">5</button>
      <button class="pin-key" onclick="pinPress('6')">6</button>
      <button class="pin-key" onclick="pinPress('7')">7</button>
      <button class="pin-key" onclick="pinPress('8')">8</button>
      <button class="pin-key" onclick="pinPress('9')">9</button>
      <button class="pin-key" onclick="pinPress('')" style="visibility:hidden;"></button>
      <button class="pin-key" onclick="pinPress('0')">0</button>
      <button class="pin-key del" onclick="pinBackspace()">‚å´</button>
    </div>
    <button class="pin-back-btn" onclick="showUserSelect()">‚Üê Back</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app" style="display:none;">
  <header>
    <div style="display:flex;align-items:center;">
      <div class="logo" onclick="showPage('home', document.querySelector('[data-page=home]'))" style="cursor:pointer;">LumaSamples</div>
      <span class="logo-sub">Sample DB</span>
    </div>
    <div class="header-right">
      <div class="user-chip" id="user-chip" onclick="logOut()">
        <span class="chip-avatar" id="chip-avatar"></span>
        <span id="chip-name"></span>
        <span class="role-badge" id="chip-role"></span>
      </div>
      <button class="btn btn-scan" onclick="openScanModal()">üì∑ Scan</button>
    </div>
  </header>

  <div class="nav-tabs" id="nav-tabs">
    <div class="nav-tab active" data-page="home" onclick="showPage('home',this)"><span class="tab-icon">üè†</span> Home</div>
    <div class="nav-tab" data-page="library" onclick="showPage('library',this)"><span class="tab-icon">üì¶</span> Library</div>
    <div class="nav-tab" data-page="history" onclick="showPage('history',this)"><span class="tab-icon">üìã</span> History</div>
    <div class="nav-tab admin-tab" id="tab-add" data-page="add" onclick="showPage('add',this)" style="display:none;"><span class="tab-icon">‚ûï</span> Add Fixture</div>
    <div class="nav-tab admin-tab" id="tab-print" data-page="print" onclick="showPage('print',this)" style="display:none;"><span class="tab-icon">üñ®</span> Print QR</div>
    <div class="nav-tab admin-tab" id="tab-admin" data-page="admin" onclick="showPage('admin',this)" style="display:none;"><span class="tab-icon">‚öôÔ∏è</span> Admin</div>
    <div class="nav-tab" id="tab-setup" data-page="setup" onclick="showPage('setup',this)"><span class="tab-icon">üîó</span> Sync Setup</div>
  </div>

  <main>
    <!-- HOME PAGE -->
    <div class="page active" id="page-home">
      <div class="home-hero" id="home-hero"></div>
      <div id="my-checkouts-strip"></div>
      <div class="section-heading">Currently Checked Out</div>
      <div class="checked-out-list" id="checked-out-list"></div>
      <div class="section-heading">Recently Returned</div>
      <div id="recent-returns"></div>
    </div>

    <!-- LIBRARY PAGE -->
    <div class="page" id="page-library">
      <div class="stats-bar" id="stats-bar"></div>
      <div class="toolbar">
        <div class="search-box">
          <span style="color:var(--text3);">üîç</span>
          <input type="text" id="search-input" placeholder="Search fixtures..." oninput="renderLibrary()">
        </div>
        <select class="filter-select" id="filter-status" onchange="renderLibrary()">
          <option value="">All Status</option>
          <option value="available">Available</option>
          <option value="out">Checked Out</option>
        </select>
        <select class="filter-select" id="filter-category" onchange="renderLibrary()">
          <option value="">All Types</option>
        </select>
      </div>
      <div class="fixture-grid" id="fixture-grid"></div>
    </div>

    <!-- HISTORY PAGE -->
    <div class="page" id="page-history">
      <div class="toolbar" style="margin-bottom:18px;">
        <h2 style="font-size:16px;font-weight:600;flex:1;">Transaction History</h2>
        <select class="filter-select" id="hist-user-filter" onchange="renderHistory()">
          <option value="">All Users</option>
        </select>
        <select class="filter-select" id="hist-type-filter" onchange="renderHistory()">
          <option value="">All Actions</option>
          <option value="checkout">Checkouts</option>
          <option value="return">Returns</option>
          <option value="added">Added</option>
          <option value="deleted">Deleted</option>
        </select>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Date / Time</th><th>Fixture ID</th><th>Name</th><th>User</th><th>Action</th></tr></thead>
          <tbody id="history-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ADD FIXTURE PAGE (admin only) -->
    <div class="page" id="page-add">
      <div style="max-width:580px;margin:0 auto;">
        <h2 style="font-size:16px;font-weight:600;margin-bottom:6px;">Add New Fixture</h2>
        <p style="color:var(--text2);font-size:13px;margin-bottom:22px;">A unique QR code is auto-generated with each entry.</p>
        <div class="form-group">
          <label class="form-label">Auto-Generated ID</label>
          <input class="form-input" id="new-fixture-id" readonly style="font-family:'DM Mono',monospace;color:var(--accent);background:var(--accent-dim);">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Fixture Name *</label>
            <input class="form-input" id="new-name" placeholder="e.g. Arco Pendant LED">
          </div>
          <div class="form-group">
            <label class="form-label">Brand</label>
            <input class="form-input" id="new-brand" placeholder="e.g. Flos">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Category / Type</label>
            <input class="form-input" id="new-category" placeholder="e.g. Pendant">
          </div>
          <div class="form-group">
            <label class="form-label">Wattage</label>
            <input class="form-input" id="new-wattage" placeholder="e.g. 18W">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Finish / Color</label>
            <input class="form-input" id="new-finish" placeholder="e.g. Matte Black">
          </div>
          <div class="form-group">
            <label class="form-label">Shelf / Location</label>
            <div style="position:relative;">
              <input class="form-input" id="new-location" placeholder="Type or select location..." autocomplete="off" oninput="filterLocDropdown('new-location','loc-drop-add')" onfocus="showLocDropdown('new-location','loc-drop-add')" onblur="setTimeout(()=>hideLocDropdown('loc-drop-add'),180)" style="padding-right:32px;">
              <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none;font-size:12px;">‚ñæ</span>
              <div id="loc-drop-add" class="loc-dropdown" style="display:none;"></div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <input class="form-input" id="new-notes" placeholder="Additional details...">
        </div>
        <div class="form-group">
          <label class="form-label">Spec Sheet URL</label>
          <input class="form-input" id="new-specsheet" placeholder="https://‚Ä¶ (link to PDF or product page)" type="url">
        </div>
        <button class="btn btn-primary" onclick="addFixture()" style="width:100%;justify-content:center;padding:13px;">
          ‚ú¶ Add Fixture &amp; Generate QR
        </button>
        <div id="new-qr-section" style="display:none;margin-top:22px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="font-size:14px;font-weight:600;">‚úì QR Code Ready</h3>
            <button class="btn btn-secondary btn-sm" onclick="window.print()">üñ® Print Label</button>
          </div>
          <div style="display:flex;justify-content:center;">
            <div class="qr-print-block" id="new-qr-display">
              <div id="new-qr-code"></div>
              <div class="qr-print-id" id="new-qr-id-text"></div>
              <div class="qr-print-name" id="new-qr-name-text"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PRINT QR PAGE (admin only) -->
    <div class="page" id="page-print">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
        <h2 style="font-size:16px;font-weight:600;">Print QR Labels</h2>
        <button class="btn btn-primary" onclick="window.print()">üñ® Print All Labels</button>
      </div>
      <div class="print-grid" id="print-grid"></div>
    </div>

    <!-- ADMIN PAGE (admin only) -->
    <div class="page" id="page-admin">
      <!-- Google Sheets Connection -->
      <div class="admin-section">
        <div class="admin-section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>üîó Google Sheets Sync</span>
          <div style="display:flex;gap:8px;" id="gs-action-btns"></div>
        </div>
        <div id="gs-status-block" style="font-size:13px;color:var(--text2);margin-top:4px;"></div>
      </div>
      <div class="divider"></div>
      <!-- User Management -->
      <div class="admin-section">
        <div class="admin-section-title">üë• User Management</div>
        <div id="user-list"></div>
        <button class="btn btn-blue btn-sm" style="margin-top:10px;" onclick="openAddUserModal()">+ Add User</button>
      </div>
      <div class="divider"></div>
      <!-- Location Management -->
      <div class="admin-section">
        <div class="admin-section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>üìç Shelf / Location List</span>
          <button class="btn btn-blue btn-sm" onclick="openLocationsModal()">Manage Locations</button>
        </div>
        <div id="location-preview" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;"></div>
      </div>
      <div class="divider"></div>
      <!-- Fixture Management -->
      <div class="admin-section">
        <div class="admin-section-title">üì¶ Fixture Management</div>
        <div class="toolbar">
          <div class="search-box" style="flex:1;">
            <span style="color:var(--text3);">üîç</span>
            <input type="text" id="admin-search" placeholder="Search fixtures to manage..." oninput="renderAdminFixtures()">
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>ID</th><th>Name</th><th>Brand</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="admin-fixture-tbody"></tbody>
          </table>
        </div>
      </div>
      <div class="divider"></div>
      <!-- Force Return -->
      <div class="admin-section">
        <div class="admin-section-title">üîÅ Force Return</div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:14px;">Return a fixture on behalf of any user.</p>
        <div id="force-return-list"></div>
      </div>
    </div>
    <!-- SETUP PAGE (admin only) -->
    <div class="page" id="page-setup">
      <div style="max-width:700px;margin:0 auto;">

        <!-- Status banner -->
        <div id="setup-status-banner" style="border-radius:var(--radius);padding:16px 20px;margin-bottom:24px;display:flex;align-items:center;gap:14px;"></div>

        <h2 style="font-size:20px;font-weight:700;margin-bottom:6px;">Google Sheets Sync</h2>
        <p style="color:var(--text2);font-size:13px;margin-bottom:28px;line-height:1.7;">Connect LumaSamples to a Google Sheet so every device stays in sync automatically. All checkouts, returns, and changes appear live across all users within 15 seconds.</p>

        <!-- Step 1 -->
        <div class="setup-card">
          <div class="setup-card-num">1</div>
          <div class="setup-card-body">
            <div class="setup-card-title">Create a Google Sheet</div>
            <div class="setup-card-desc">Go to <a href="https://sheets.google.com" target="_blank" style="color:var(--accent);">sheets.google.com</a> and create a new blank spreadsheet. Name it <strong>LumaSamples</strong>.</div>
            <a href="https://sheets.google.com" target="_blank" class="btn btn-secondary btn-sm" style="margin-top:12px;display:inline-flex;">Open Google Sheets ‚Üó</a>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="setup-card">
          <div class="setup-card-num">2</div>
          <div class="setup-card-body">
            <div class="setup-card-title">Open Apps Script Editor</div>
            <div class="setup-card-desc">In your Google Sheet, click <strong>Extensions ‚Üí Apps Script</strong>. Delete all existing code in the editor, then paste the code below.</div>
            <div style="position:relative;margin-top:14px;">
              <div style="background:var(--surface3);border:1px solid var(--border2);border-radius:var(--radius-sm);overflow:hidden;">
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border2);background:var(--surface2);">
                  <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);">LumaSamples_AppScript.gs</span>
                  <button class="btn btn-primary btn-sm" onclick="copyAppScript(this)" style="gap:6px;">
                    <span>üìã</span> <span id="copy-btn-label">Copy Code</span>
                  </button>
                </div>
                <pre id="appscript-preview" style="margin:0;padding:14px;font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);overflow-x:auto;max-height:260px;overflow-y:auto;line-height:1.6;white-space:pre;"></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="setup-card">
          <div class="setup-card-num">3</div>
          <div class="setup-card-body">
            <div class="setup-card-title">Deploy as Web App</div>
            <div class="setup-card-desc">
              In the Apps Script editor, click <strong>Save</strong> (Ctrl+S), then:
              <ol style="margin-top:10px;padding-left:18px;line-height:2;font-size:13px;color:var(--text2);">
                <li>Click <strong style="color:var(--text);">Deploy ‚Üí New deployment</strong></li>
                <li>Click the gear icon ‚öô ‚Üí select <strong style="color:var(--text);">Web app</strong></li>
                <li>Set <strong style="color:var(--text);">Execute as: Me</strong></li>
                <li>Set <strong style="color:var(--text);">Who has access: Anyone</strong></li>
                <li>Click <strong style="color:var(--text);">Deploy</strong> ‚Üí authorize when prompted</li>
                <li>Copy the <strong style="color:var(--accent);">Web App URL</strong> (ends in <code style="font-family:'DM Mono',monospace;font-size:11px;background:var(--surface3);padding:1px 5px;border-radius:3px;">/exec</code>)</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Step 4 ‚Äî Paste URL & Connect -->
        <div class="setup-card" id="setup-connect-card">
          <div class="setup-card-num">4</div>
          <div class="setup-card-body">
            <div class="setup-card-title">Paste URL &amp; Connect</div>
            <div class="setup-card-desc">Paste the Web App URL from step 3. It should look like:<br>
              <code style="font-family:'DM Mono',monospace;font-size:11px;color:var(--accent);background:var(--surface3);padding:3px 8px;border-radius:4px;display:inline-block;margin-top:6px;">https://script.google.com/macros/s/‚Ä¶/exec</code>
            </div>
            <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;">
              <input class="form-input" id="setup-url-input" placeholder="https://script.google.com/macros/s/‚Ä¶/exec" style="flex:1;min-width:260px;">
              <button class="btn btn-primary" onclick="connectFromSetup()">Connect &amp; Sync ‚Üí</button>
            </div>
            <div id="setup-connect-feedback" style="margin-top:10px;font-size:12px;display:none;"></div>
          </div>
        </div>

        <!-- Connected state (shown when connected) -->
        <div id="setup-connected-block" style="display:none;">
          <div class="setup-card" style="border-color:rgba(74,222,128,0.3);background:rgba(74,222,128,0.04);">
            <div style="font-size:22px;">‚úÖ</div>
            <div class="setup-card-body">
              <div class="setup-card-title" style="color:var(--green);">Connected to Google Sheets</div>
              <div id="setup-connected-url" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);margin-top:4px;word-break:break-all;"></div>
              <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;">
                <button class="btn btn-secondary btn-sm" onclick="gsPullAll()">‚Üª Sync Now</button>
                <button class="btn btn-danger btn-sm" onclick="disconnectFromSetup()">Disconnect</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN DETAIL MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="login-detail-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title">Fixture Details</div>
      <button class="modal-close" onclick="closeModal('login-detail-modal')">√ó</button>
    </div>
    <div class="modal-body" id="login-detail-body"></div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('login-detail-modal')">Close</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCAN MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="scan-modal">
  <div class="modal" style="max-width:380px;">
    <div class="modal-header">
      <div class="modal-title">üì∑ Scan QR Code</div>
      <button class="modal-close" onclick="closeScanModal()">√ó</button>
    </div>
    <div class="modal-body">
      <p style="font-size:12px;color:var(--text2);margin-bottom:14px;">Point camera at a fixture QR code.</p>
      <div id="qr-reader" style="border-radius:var(--radius-sm);overflow:hidden;background:#000;min-height:200px;"></div>
      <div id="scan-result" style="display:none;margin-top:14px;padding:14px;background:var(--surface2);border-radius:var(--radius-sm);"></div>
      <div style="margin-top:14px;">
        <label class="form-label">Or Enter ID Manually</label>
        <div style="display:flex;gap:8px;">
          <input class="form-input" id="manual-id-input" placeholder="e.g. LUM-0042" style="flex:1;">
          <button class="btn btn-secondary" onclick="processManualId()">Go</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Fixture Details</div>
      <button class="modal-close" onclick="closeModal('detail-modal')">√ó</button>
    </div>
    <div class="modal-body" id="detail-body"></div>
    <div class="modal-footer" id="detail-footer"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD USER MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="add-user-modal">
  <div class="modal" style="max-width:360px;">
    <div class="modal-header">
      <div class="modal-title">Add New User</div>
      <button class="modal-close" onclick="closeModal('add-user-modal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input class="form-input" id="nu-name" placeholder="e.g. Jane Smith">
      </div>
      <div class="form-group">
        <label class="form-label">4-Digit PIN</label>
        <input class="form-input" id="nu-pin" type="password" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="form-group">
        <label class="form-label">Role</label>
        <select class="form-input" id="nu-role">
          <option value="user">User ‚Äî checkout/return only</option>
          <option value="admin">Admin ‚Äî full access</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Avatar</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;" id="avatar-picker">
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">üí°</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">üî¶</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">üåü</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">‚ö°</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">üé®</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">üèóÔ∏è</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">üéØ</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">üåô</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">üîß</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">üè†</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('add-user-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="addUser()">Add User</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDIT USER MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="edit-user-modal">
  <div class="modal" style="max-width:360px;">
    <div class="modal-header">
      <div class="modal-title">Edit User</div>
      <button class="modal-close" onclick="closeModal('edit-user-modal')">√ó</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="eu-id">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input class="form-input" id="eu-name">
      </div>
      <div class="form-group">
        <label class="form-label">Change PIN (leave blank to keep)</label>
        <input class="form-input" id="eu-pin" type="password" maxlength="4" inputmode="numeric" placeholder="New PIN">
      </div>
      <div class="form-group">
        <label class="form-label">Role</label>
        <select class="form-input" id="eu-role">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('edit-user-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditUser()">Save Changes</button>
    </div>
  </div>
</div>

<div class="notif" id="notif"></div>
<div id="sync-bar">
  <div class="sync-dot" id="sync-dot"></div>
  <span id="sync-msg">Not connected</span>
  <span style="margin-left:auto;cursor:pointer;color:var(--text3);" onclick="hideSyncBar()">‚úï</span>
</div>

<div id="sync-bar">
  <div class="sync-dot" id="sync-dot"></div>
  <span id="sync-msg">Not connected to Google Sheets</span>
  <span style="margin-left:auto;cursor:pointer;" onclick="hideSyncBar()">‚úï</span>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GOOGLE SHEETS SETUP MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="gs-setup-modal">
  <div class="modal" style="max-width:520px;">
    <div class="modal-header">
      <div class="modal-title">üîó Connect to Google Sheets</div>
      <button class="modal-close" onclick="closeModal('gs-setup-modal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="setup-step">
        <div class="setup-num">1</div>
        <div class="setup-content">
          <div class="setup-title">Create a Google Sheet</div>
          <div class="setup-desc">Go to <strong>sheets.google.com</strong> ‚Üí create a new blank spreadsheet. Name it "LumaSamples".</div>
        </div>
      </div>
      <div class="setup-step">
        <div class="setup-num">2</div>
        <div class="setup-content">
          <div class="setup-title">Open Apps Script</div>
          <div class="setup-desc">In the sheet: <strong>Extensions ‚Üí Apps Script</strong>. Delete any existing code, paste in the entire contents of the <strong>LumaSamples_AppScript.js</strong> file you downloaded, then click <strong>Save</strong> (Ctrl+S).</div>
        </div>
      </div>
      <div class="setup-step">
        <div class="setup-num">3</div>
        <div class="setup-content">
          <div class="setup-title">Deploy as Web App</div>
          <div class="setup-desc">Click <strong>Deploy ‚Üí New deployment</strong> ‚Üí type: <em>Web app</em>.<br>
          Set <strong>"Execute as: Me"</strong> and <strong>"Who has access: Anyone"</strong>.<br>
          Click <strong>Deploy</strong> ‚Üí authorize ‚Üí copy the Web App URL.</div>
        </div>
      </div>
      <div class="setup-step">
        <div class="setup-num">4</div>
        <div class="setup-content">
          <div class="setup-title">Paste the URL below</div>
          <div class="setup-desc">The URL looks like:<br>
          <div class="code-block" onclick="this.select?.()">https://script.google.com/macros/s/‚Ä¶/exec</div>
          </div>
        </div>
      </div>
      <div class="form-group" style="margin-top:8px;">
        <label class="form-label">Apps Script Web App URL</label>
        <input class="form-input" id="gs-url-input" placeholder="https://script.google.com/macros/s/‚Ä¶/exec">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('gs-setup-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="connectGoogleSheets(document.getElementById('gs-url-input').value)">Connect &amp; Sync</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDIT FIXTURE MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="edit-fixture-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Edit Fixture</div>
      <button class="modal-close" onclick="closeModal('edit-fixture-modal')">√ó</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="ef-id">
      <div class="form-group">
        <label class="form-label">Fixture ID</label>
        <input class="form-input" id="ef-fid" readonly style="font-family:'DM Mono',monospace;color:var(--accent);background:var(--accent-dim);">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Fixture Name *</label>
          <input class="form-input" id="ef-name" placeholder="e.g. Arco Pendant LED">
        </div>
        <div class="form-group">
          <label class="form-label">Brand</label>
          <input class="form-input" id="ef-brand" placeholder="e.g. Flos">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Category / Type</label>
          <input class="form-input" id="ef-category" placeholder="e.g. Pendant">
        </div>
        <div class="form-group">
          <label class="form-label">Wattage</label>
          <input class="form-input" id="ef-wattage" placeholder="e.g. 18W">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Finish / Color</label>
          <input class="form-input" id="ef-finish" placeholder="e.g. Matte Black">
        </div>
        <div class="form-group">
          <label class="form-label">Shelf / Location</label>
          <div style="position:relative;">
            <input class="form-input" id="ef-location" placeholder="Type or select..." autocomplete="off"
              oninput="filterLocDropdown('ef-location','loc-drop-edit')"
              onfocus="showLocDropdown('ef-location','loc-drop-edit')"
              onblur="setTimeout(()=>hideLocDropdown('loc-drop-edit'),180)"
              style="padding-right:32px;">
            <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none;font-size:12px;">‚ñæ</span>
            <div id="loc-drop-edit" class="loc-dropdown" style="display:none;"></div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <input class="form-input" id="ef-notes" placeholder="Additional details...">
      </div>
      <div class="form-group">
        <label class="form-label">Spec Sheet URL</label>
        <input class="form-input" id="ef-specsheet" placeholder="https://‚Ä¶ (link to PDF or product page)" type="url">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('edit-fixture-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditFixture()">Save Changes</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MANAGE LOCATIONS MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="locations-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title">üìç Manage Locations</div>
      <button class="modal-close" onclick="closeModal('locations-modal')">√ó</button>
    </div>
    <div class="modal-body">
      <p style="font-size:12px;color:var(--text2);margin-bottom:14px;">These appear in the Location dropdown when adding or editing fixtures.</p>
      <div id="locations-list" style="margin-bottom:14px;"></div>
      <div style="display:flex;gap:8px;">
        <input class="form-input" id="new-location-input" placeholder="New location name..." style="flex:1;">
        <button class="btn btn-primary" onclick="addLocation()">Add</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('locations-modal')">Done</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const KEY_FIXTURES  = 'luma:fixtures';
const KEY_USERS     = 'luma:users';
const KEY_HISTORY   = 'luma:history';
const KEY_COUNTER   = 'luma:counter';
const KEY_LOCATIONS = 'luma:locations';
const KEY_GS_URL    = 'luma:gsUrl';

const DEFAULT_LOCATIONS = ['Shelf A-1','Shelf A-2','Shelf B-1','Shelf B-2','Shelf B-3','Shelf C-1','Shelf C-2','Storage Room','Display Floor','Front Desk','Back Office'];

let fixtures  = [];
let users     = [];
let history   = [];
let locations = [];
let fixtureCounter = 42;
let currentUser    = null;
let pinTarget      = null;
let pinBuffer      = '';
let selectedAvatar = 'üí°';
let scannerInstance = null;
let gsUrl = '';            // Google Apps Script Web App URL
let gsSyncTimer = null;    // polling interval handle
let gsSyncing   = false;   // prevent overlapping syncs

const ADMIN_DEFAULTS = [
  { id: 'admin-1', name: 'Admin', pin: '4116', role: 'admin', avatar: '‚öôÔ∏è' }
];
const SAMPLE_FIXTURES = [
  { id:'LUM-0001', name:'Arco Pendant LED', brand:'Flos', category:'Pendant', wattage:'18W', finish:'Polished Chrome', location:'Shelf A-1', notes:'Dimmable 0-10V', status:'available', checkedOutBy:null, checkedOutAt:null },
  { id:'LUM-0002', name:'Zuma Recessed Trim', brand:'Halo', category:'Recessed', wattage:'9W', finish:'Matte White', location:'Shelf A-2', notes:'4" aperture', status:'available', checkedOutBy:null, checkedOutAt:null },
  { id:'LUM-0003', name:'Volta Wall Sconce', brand:'Visual Comfort', category:'Wall', wattage:'12W', finish:'Aged Brass', location:'Shelf B-1', notes:'Up/down light', status:'available', checkedOutBy:null, checkedOutAt:null },
  { id:'LUM-0004', name:'Nova Track Head', brand:'Juno', category:'Track', wattage:'15W', finish:'Matte Black', location:'Shelf B-2', notes:'Adjustable beam', status:'available', checkedOutBy:null, checkedOutAt:null },
  { id:'LUM-0005', name:'Serene Strip Light', brand:'Lutron', category:'Linear', wattage:'20W/m', finish:'N/A', location:'Shelf C-1', notes:'Color tunable 2700-6500K', status:'available', checkedOutBy:null, checkedOutAt:null },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOCAL STORAGE (cache layer)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function localLoad() {
  try { const r = await window.storage.get(KEY_FIXTURES);   fixtures  = r ? JSON.parse(r.value) : [...SAMPLE_FIXTURES]; } catch { fixtures = [...SAMPLE_FIXTURES]; }
  try { const r = await window.storage.get(KEY_USERS);      users     = r ? JSON.parse(r.value) : [...ADMIN_DEFAULTS]; } catch { users = [...ADMIN_DEFAULTS]; }
  try { const r = await window.storage.get(KEY_HISTORY);    history   = r ? JSON.parse(r.value) : []; } catch { history = []; }
  try { const r = await window.storage.get(KEY_COUNTER);    fixtureCounter = r ? parseInt(r.value) : 42; } catch { fixtureCounter = 42; }
  try { const r = await window.storage.get(KEY_LOCATIONS);  locations = r ? JSON.parse(r.value) : [...DEFAULT_LOCATIONS]; } catch { locations = [...DEFAULT_LOCATIONS]; }
  try { const r = await window.storage.get(KEY_GS_URL);     gsUrl = r ? r.value : ''; } catch { gsUrl = ''; }
}

async function localSave() {
  try {
    await window.storage.set(KEY_FIXTURES,  JSON.stringify(fixtures));
    await window.storage.set(KEY_USERS,     JSON.stringify(users));
    await window.storage.set(KEY_HISTORY,   JSON.stringify(history));
    await window.storage.set(KEY_COUNTER,   String(fixtureCounter));
    await window.storage.set(KEY_LOCATIONS, JSON.stringify(locations));
  } catch(e) { console.error('Local save failed', e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GOOGLE SHEETS SYNC LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function gsGet(params = {}) {
  if (!gsUrl) return null;
  const url = gsUrl + '?' + new URLSearchParams(params).toString();
  const res  = await fetch(url);
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data;
}

async function gsPost(body) {
  if (!gsUrl) return null;
  const res  = await fetch(gsUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' }, // Apps Script requires text/plain for POST
    body: JSON.stringify(body),
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data;
}

// Pull all data from Google Sheets and update local state + cache
async function gsPullAll(quiet = false) {
  if (!gsUrl || gsSyncing) return;
  gsSyncing = true;
  if (!quiet) setSyncStatus('syncing', 'Syncing with Google Sheets‚Ä¶');
  try {
    const data = await gsGet({ action: 'all' });
    if (!data) return;

    // Merge remote data into local state
    if (data.fixtures)  fixtures  = data.fixtures.map(normalizeFixture);
    if (data.users)     users     = data.users.map(normalizeUser);
    if (data.history)   history   = data.history;
    if (data.locations) locations = data.locations;
    if (data.config && data.config.fixtureCounter) {
      const rc = parseInt(data.config.fixtureCounter);
      if (!isNaN(rc) && rc > fixtureCounter) fixtureCounter = rc;
    }

    ensureAdmin();
    bumpCounter();
    await localSave();
    await window.storage.set(KEY_GS_URL, gsUrl).catch(()=>{});

    if (!quiet) setSyncStatus('synced', 'Synced ¬∑ ' + new Date().toLocaleTimeString());
    refreshCurrentPage();
    renderLoginScreen();
  } catch(e) {
    setSyncStatus('error', 'Sync error: ' + e.message);
    console.error('GS pull error:', e);
  } finally {
    gsSyncing = false;
  }
}

// Push a single fixture change to Google Sheets
async function gsPushFixture(f) {
  if (!gsUrl) return;
  try {
    setSyncStatus('syncing','Saving‚Ä¶');
    await gsPost({ action: 'upsertFixture', data: f });
    setSyncStatus('synced', 'Saved ¬∑ ' + new Date().toLocaleTimeString());
  } catch(e) { setSyncStatus('error','Save error: '+e.message); }
}

async function gsDeleteFixture(fid) {
  if (!gsUrl) return;
  try { await gsPost({ action: 'deleteFixture', id: fid }); } catch(e) {}
}

async function gsPushUser(u) {
  if (!gsUrl) return;
  try { await gsPost({ action: 'upsertUser', data: u }); } catch(e) {}
}

async function gsDeleteUser(uid) {
  if (!gsUrl) return;
  try { await gsPost({ action: 'deleteUser', id: uid }); } catch(e) {}
}

async function gsPushHistory(h) {
  if (!gsUrl) return;
  try { await gsPost({ action: 'addHistory', data: h }); } catch(e) {}
}

async function gsPushLocation(name) {
  if (!gsUrl) return;
  try { await gsPost({ action: 'addLocation', name }); } catch(e) {}
}

async function gsDeleteLocation(name) {
  if (!gsUrl) return;
  try { await gsPost({ action: 'deleteLocation', name }); } catch(e) {}
}

async function gsPushCounter() {
  if (!gsUrl) return;
  try { await gsPost({ action: 'setConfig', key: 'fixtureCounter', value: String(fixtureCounter) }); } catch(e) {}
}

// ‚îÄ‚îÄ Normalize row shapes coming from Sheets ‚îÄ‚îÄ
function normalizeFixture(f) {
  return {
    id:           f.id          || '',
    name:         f.name        || '',
    brand:        f.brand       || '',
    category:     f.category    || '',
    wattage:      f.wattage     || '',
    finish:       f.finish      || '',
    location:     f.location    || '',
    notes:        f.notes       || '',
    specSheet:    f.specSheet    || f.spec_sheet || '',
    status:       f.status      || 'available',
    checkedOutBy: f.checkedOutBy || f.checked_out_by || null,
    checkedOutAt: f.checkedOutAt || f.checked_out_at || null,
  };
}

function normalizeUser(u) {
  return { id: u.id||'', name: u.name||'', pin: u.pin||'', role: u.role||'user', avatar: u.avatar||'üí°' };
}

// ‚îÄ‚îÄ Sync status bar ‚îÄ‚îÄ
let syncHideTimer = null;
function setSyncStatus(state, msg) {
  const bar = document.getElementById('sync-bar');
  const dot = document.getElementById('sync-dot');
  const txt = document.getElementById('sync-msg');
  if (!bar) return;
  bar.className = 'show ' + state;
  dot.className = 'sync-dot' + (state === 'syncing' ? ' pulse' : '');
  txt.textContent = msg;
  clearTimeout(syncHideTimer);
  if (state === 'synced') syncHideTimer = setTimeout(hideSyncBar, 3000);
}

function hideSyncBar() {
  const bar = document.getElementById('sync-bar');
  if (bar) bar.className = bar.className.replace('show','').trim();
}

// ‚îÄ‚îÄ Start auto-polling every 15 seconds ‚îÄ‚îÄ
function startAutoSync() {
  if (gsSyncTimer) clearInterval(gsSyncTimer);
  gsSyncTimer = setInterval(() => gsPullAll(true), 15000);
}

// ‚îÄ‚îÄ Connect / Disconnect ‚îÄ‚îÄ
async function connectGoogleSheets(url) {
  if (!url || !url.includes('script.google.com')) {
    notify('Please paste a valid Google Apps Script URL', 'error'); return;
  }
  gsUrl = url.trim();
  await window.storage.set(KEY_GS_URL, gsUrl).catch(()=>{});
  notify('Connecting to Google Sheets‚Ä¶', 'info');
  // First run setup on the sheet
  try {
    setSyncStatus('syncing', 'Setting up Google Sheets‚Ä¶');
    await gsGet({ action: 'setup' });
    // Push all existing local data up to the sheet
    await pushAllToSheets();
    await gsPullAll();
    startAutoSync();
    closeModal('gs-setup-modal');
    notify('‚úì Connected to Google Sheets!', 'success');
  } catch(e) {
    setSyncStatus('error', 'Connection failed: ' + e.message);
    notify('Connection failed. Check your URL.', 'error');
  }
}

async function pushAllToSheets() {
  if (!gsUrl) return;
  setSyncStatus('syncing', 'Uploading data to Google Sheets‚Ä¶');
  for (const f of fixtures) { await gsPushFixture(f); }
  for (const u of users)    { await gsPushUser(u); }
  for (const l of locations) { await gsPushLocation(l); }
  await gsPushCounter();
}

function disconnectGoogleSheets() {
  gsUrl = '';
  window.storage.set(KEY_GS_URL, '').catch(()=>{});
  if (gsSyncTimer) { clearInterval(gsSyncTimer); gsSyncTimer = null; }
  hideSyncBar();
  notify('Disconnected from Google Sheets', 'info');
  renderGsStatus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UNIFIED SAVE (local + Google Sheets)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveData(options = {}) {
  await localSave();
  // options: { fixture, user, historyEntry, location, deletedFixtureId, deletedUserId, deletedLocation }
  if (!gsUrl) return;
  if (options.fixture)         await gsPushFixture(options.fixture);
  if (options.user)            await gsPushUser(options.user);
  if (options.historyEntry)    await gsPushHistory(options.historyEntry);
  if (options.location)        await gsPushLocation(options.location);
  if (options.deletedFixtureId) await gsDeleteFixture(options.deletedFixtureId);
  if (options.deletedUserId)   await gsDeleteUser(options.deletedUserId);
  if (options.deletedLocation) await gsDeleteLocation(options.deletedLocation);
  if (options.counter)         await gsPushCounter();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT / LOAD DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadData() {
  await localLoad();
  ensureAdmin();
  bumpCounter();
  await localSave();
  // If Google Sheets URL is configured, sync immediately
  if (gsUrl) {
    startAutoSync();
    gsPullAll();   // async, don't await ‚Äî show UI immediately from cache
  }
}

function ensureAdmin() {
  users = users.filter(u => u.id === 'admin-1' || u.role === 'admin' || !(['Alex Rivera','Jordan Kim','Sam Chen'].includes(u.name)));
  const a = users.find(u => u.id === 'admin-1');
  if (!a) users.unshift({ id:'admin-1', name:'Admin', pin:'4116', role:'admin', avatar:'‚öôÔ∏è' });
  else { a.role = 'admin'; a.pin = '4116'; }
}

function bumpCounter() {
  fixtures.forEach(f => {
    const n = parseInt((f.id||'').split('-')[1]);
    if (!isNaN(n) && n >= fixtureCounter) fixtureCounter = n + 1;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOGIN / PIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLoginScreen() {
  const grid = document.getElementById('login-user-grid');
  grid.innerHTML = users.map(u => `
    <div class="user-login-card ${u.role==='admin'?'admin-card':''}" onclick="startPinEntry('${u.id}')">
      <span class="ulc-avatar">${u.avatar}</span>
      <div class="ulc-name">${u.name}</div>
      <span class="ulc-role ${u.role}">${u.role}</span>
    </div>
  `).join('');
  renderLoginCheckedOut();
}

function openLoginDetail(fid) {
  const f = fixtures.find(x => x.id === fid);
  if (!f) return;
  const u = f.checkedOutBy ? users.find(x => x.id === f.checkedOutBy) : null;
  document.getElementById('login-detail-body').innerHTML = `
    <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;">
      <div style="flex:1;min-width:180px;">
        <div style="margin-bottom:10px;">
          <span class="fid">${f.id}</span>
          <span class="sbadge out" style="margin-left:8px;">Checked Out</span>
        </div>
        <div style="font-size:18px;font-weight:700;margin-bottom:14px;">${f.name}</div>
        <table style="font-size:13px;border-collapse:collapse;width:100%;">
          ${f.brand    ? `<tr><td style="padding:5px 0;color:var(--text3);width:90px;">Brand</td><td style="padding:5px 0;">${f.brand}</td></tr>` : ''}
          ${f.category ? `<tr><td style="padding:5px 0;color:var(--text3);">Type</td><td style="padding:5px 0;">${f.category}</td></tr>` : ''}
          ${f.wattage  ? `<tr><td style="padding:5px 0;color:var(--text3);">Wattage</td><td style="padding:5px 0;">${f.wattage}</td></tr>` : ''}
          ${f.finish   ? `<tr><td style="padding:5px 0;color:var(--text3);">Finish</td><td style="padding:5px 0;">${f.finish}</td></tr>` : ''}
          ${f.location ? `<tr><td style="padding:5px 0;color:var(--text3);">Location</td><td style="padding:5px 0;">${f.location}</td></tr>` : ''}
          ${f.notes    ? `<tr><td style="padding:5px 0;color:var(--text3);">Notes</td><td style="padding:5px 0;">${f.notes}</td></tr>` : ''}
          ${f.specSheet ? `<tr><td style="padding:5px 0;color:var(--text3);">Spec Sheet</td><td style="padding:5px 0;"><a href="${f.specSheet}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;">üìÑ View ‚Üó</a></td></tr>` : ''}
          ${u ? `<tr><td style="padding:8px 0 0;color:var(--text3);">With</td><td style="padding:8px 0 0;color:var(--red);font-weight:600;">${u.avatar} ${u.name} ¬∑ ${timeAgo(f.checkedOutAt)}</td></tr>` : ''}
        </table>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
        <div id="ldm-qr-${f.id}" style="background:white;border-radius:8px;padding:12px;"></div>
        <div style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;">${f.id}</div>
      </div>
    </div>
  `;
  openModal('login-detail-modal');
  setTimeout(() => {
    const el = document.getElementById('ldm-qr-' + f.id);
    if (el && !el.querySelector('canvas')) {
      new QRCode(el, { text: f.id, width: 100, height: 100, colorDark: '#111', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
    }
  }, 60);
}

function renderLoginCheckedOut() {
  const board   = document.getElementById('login-co-board');
  const listEl  = document.getElementById('login-co-list');
  const countEl = document.getElementById('login-co-count');
  if (!board || !listEl) return;
  const coList = fixtures.filter(f => f.status === 'out').sort((a,b) => new Date(b.checkedOutAt) - new Date(a.checkedOutAt));
  if (!coList.length) { board.style.display = 'none'; return; }
  board.style.display = 'block';
  if (countEl) countEl.textContent = coList.length + ' out';
  listEl.innerHTML = coList.map(f => {
    const u = users.find(x => x.id === f.checkedOutBy);
    return `<div class="login-co-row" onclick="openLoginDetail('${f.id}')" style="cursor:pointer;">
      <span class="login-co-id">${f.id}</span>
      <span class="login-co-name">${f.name}</span>
      <span class="login-co-user">${u ? u.avatar + ' ' + u.name : '‚Äî'}</span>
      <span class="login-co-time">${timeAgo(f.checkedOutAt)}</span>
    </div>`;
  }).join('');
}

function startPinEntry(uid) {
  pinTarget = users.find(u => u.id === uid);
  pinBuffer = '';
  document.getElementById('pin-avatar').textContent = pinTarget.avatar;
  document.getElementById('pin-name').textContent = pinTarget.name;
  updatePinDots();
  document.getElementById('login-user-grid').style.display = 'none';
  document.getElementById('pin-entry').style.display = 'block';
}

function showUserSelect() {
  pinBuffer = '';
  pinTarget = null;
  document.getElementById('pin-entry').style.display = 'none';
  document.getElementById('login-user-grid').style.display = 'grid';
}

function pinPress(digit) {
  if (!digit) return;
  if (pinBuffer.length >= 4) return;
  pinBuffer += digit;
  updatePinDots();
  if (pinBuffer.length === 4) {
    setTimeout(checkPin, 120);
  }
}

function pinBackspace() {
  pinBuffer = pinBuffer.slice(0, -1);
  updatePinDots();
}

function updatePinDots() {
  for (let i = 0; i < 4; i++) {
    const d = document.getElementById('d' + i);
    d.classList.toggle('filled', i < pinBuffer.length);
    d.classList.remove('error');
  }
}

function checkPin() {
  if (pinBuffer === pinTarget.pin) {
    loginSuccess(pinTarget);
  } else {
    // Shake dots
    for (let i = 0; i < 4; i++) document.getElementById('d' + i).classList.add('error');
    setTimeout(() => { pinBuffer = ''; updatePinDots(); }, 800);
  }
}

function adminQuickLogin() {
  // Find admin by id first, then fall back to any admin role
  const admin = users.find(u => u.id === 'admin-1') || users.find(u => u.role === 'admin');
  if (!admin) { notify('No admin account found.', 'error'); return; }
  loginSuccess(admin);
}

function loginSuccess(user) {
  currentUser = user;
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  // Header
  document.getElementById('chip-avatar').textContent = user.avatar;
  document.getElementById('chip-name').textContent = user.name;
  const roleEl = document.getElementById('chip-role');
  roleEl.textContent = user.role;
  roleEl.className = 'role-badge ' + user.role;
  // Show/hide admin tabs
  const isAdmin = user.role === 'admin';
  ['tab-add','tab-print','tab-admin'].forEach(id => {
    document.getElementById(id).style.display = isAdmin ? '' : 'none';
  });
  showPage('home', document.querySelector('[data-page="home"]'));
}

function logOut() {
  currentUser = null;
  pinBuffer = '';
  pinTarget = null;
  stopScanner();
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-screen').style.display = '';
  document.getElementById('pin-entry').style.display = 'none';
  document.getElementById('login-user-grid').style.display = 'grid';
  renderLoginScreen();
  notify('Signed out', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(name, tabEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (tabEl) tabEl.classList.add('active');
  if (name === 'home')    renderHome();
  if (name === 'library') { renderStats(); renderLibrary(); populateFilters(); }
  if (name === 'history') { populateHistFilters(); renderHistory(); }
  if (name === 'add')     refreshAddId();
  if (name === 'print')   renderPrintPage();
  if (name === 'admin')   { renderUserList(); renderAdminFixtures(); renderForceReturn(); renderLocationPreview(); renderGsStatus(); }
  if (name === 'setup')   { renderSetupPage(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HOME PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHome() {
  const total  = fixtures.length;
  const out    = fixtures.filter(f => f.status === 'out').length;
  const avail  = total - out;
  const myOut  = fixtures.filter(f => f.checkedOutBy === currentUser?.id).length;

  document.getElementById('home-hero').innerHTML = `
    <div class="hero-stat"><div class="hero-stat-label">Available</div><div class="hero-stat-val green">${avail}</div></div>
    <div class="hero-stat"><div class="hero-stat-label">Checked Out</div><div class="hero-stat-val red">${out}</div></div>
    <div class="hero-stat"><div class="hero-stat-label">Total Fixtures</div><div class="hero-stat-val accent">${total}</div></div>
    <div class="hero-stat"><div class="hero-stat-label">My Checkouts</div><div class="hero-stat-val blue">${myOut}</div></div>
  `;

  // My checkouts strip
  const mine = fixtures.filter(f => f.checkedOutBy === currentUser?.id);
  const strip = document.getElementById('my-checkouts-strip');
  if (mine.length) {
    strip.innerHTML = `
      <div class="my-co-strip">
        <div class="my-co-strip-header">
          <div class="my-co-strip-title">üì§ Your Checked Out Fixtures (${mine.length})</div>
          <button class="btn btn-danger btn-sm" onclick="showPage('library', document.querySelector('[data-page=library]'))">View All</button>
        </div>
        <div class="my-co-items">
          ${mine.map(f => `
            <div class="my-co-pill" onclick="openDetailModal('${f.id}')">
              <span class="pill-id">${f.id}</span>
              <span>${f.name}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  } else {
    strip.innerHTML = '';
  }

  // All checked out list
  const coList = fixtures.filter(f => f.status === 'out').sort((a,b) => new Date(b.checkedOutAt) - new Date(a.checkedOutAt));
  const coEl = document.getElementById('checked-out-list');
  if (!coList.length) {
    coEl.innerHTML = '<div class="empty-state"><div class="icon">‚úÖ</div><p>All fixtures are currently available.</p></div>';
  } else {
    coEl.innerHTML = coList.map(f => {
      const u = users.find(x => x.id === f.checkedOutBy);
      return `
        <div class="co-row" onclick="openDetailModal('${f.id}')">
          <div class="co-id">${f.id}</div>
          <div class="co-info">
            <div class="co-name">${f.name}</div>
            <div class="co-meta">${f.brand || ''} ${f.category ? '¬∑ ' + f.category : ''} ${f.location ? '¬∑ üìç' + f.location : ''}</div>
          </div>
          ${u ? `<div class="co-user"><span class="avatar">${u.avatar}</span><span>${u.name}</span></div>` : ''}
          <div class="co-time">${timeAgo(f.checkedOutAt)}</div>
        </div>
      `;
    }).join('');
  }

  // Recent returns (last 5 return events)
  const returns = history.filter(h => h.action === 'return').slice(0, 5);
  const rrEl = document.getElementById('recent-returns');
  if (!returns.length) {
    rrEl.innerHTML = '<div style="color:var(--text3);font-size:13px;padding:12px 0;">No returns recorded yet.</div>';
  } else {
    rrEl.innerHTML = `<div class="table-wrap"><table>
      <thead><tr><th>Fixture</th><th>Returned By</th><th>When</th></tr></thead>
      <tbody>${returns.map(h => `
        <tr>
          <td><span class="mono">${h.fixtureId}</span> <span style="color:var(--text2);margin-left:8px;">${h.fixtureName}</span></td>
          <td>${h.userName}</td>
          <td style="color:var(--text3);font-family:'DM Mono',monospace;font-size:11px;">${new Date(h.ts).toLocaleString()}</td>
        </tr>
      `).join('')}</tbody>
    </table></div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStats() {
  const total = fixtures.length;
  const out   = fixtures.filter(f => f.status === 'out').length;
  document.getElementById('stats-bar').innerHTML = `
    <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value accent">${total}</div></div>
    <div class="stat-card"><div class="stat-label">Available</div><div class="stat-value green">${total-out}</div></div>
    <div class="stat-card"><div class="stat-label">Checked Out</div><div class="stat-value red">${out}</div></div>
    <div class="stat-card"><div class="stat-label">My Checkouts</div><div class="stat-value" style="color:var(--blue);">${fixtures.filter(f=>f.checkedOutBy===currentUser?.id).length}</div></div>
  `;
}

function populateFilters() {
  const cats = [...new Set(fixtures.map(f=>f.category).filter(Boolean))];
  const sel = document.getElementById('filter-category');
  const cur = sel.value;
  sel.innerHTML = '<option value="">All Types</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  sel.value = cur;
}

function renderLibrary() {
  const q    = (document.getElementById('search-input').value||'').toLowerCase();
  const sf   = document.getElementById('filter-status').value;
  const cf   = document.getElementById('filter-category').value;
  const list = fixtures.filter(f => {
    const txt = [f.id,f.name,f.brand,f.category,f.finish,f.location].join(' ').toLowerCase();
    return txt.includes(q) && (!sf || f.status===sf) && (!cf || f.category===cf);
  });
  const grid = document.getElementById('fixture-grid');
  if (!list.length) { grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="icon">üî¶</div><p>No fixtures found.</p></div>'; return; }
  grid.innerHTML = list.map(f => fixtureCardHTML(f)).join('');
}

function fixtureCardHTML(f) {
  const u = f.checkedOutBy ? users.find(x=>x.id===f.checkedOutBy) : null;
  const isMe = f.checkedOutBy === currentUser?.id;
  const isAdmin = currentUser?.role === 'admin';
  return `
    <div class="fixture-card ${f.status}" onclick="openDetailModal('${f.id}')">
      <div class="card-top">
        <div class="fid">${f.id}</div>
        <div class="sbadge ${f.status==='available'?'available':'out'}">${f.status==='available'?'Available':'Out'}</div>
      </div>
      <div class="card-body">
        <div class="card-name">${f.name}</div>
        <div class="card-meta">
          ${f.brand?`<span>üè∑ ${f.brand}</span>`:''}
          ${f.category?`<span>üì¶ ${f.category}</span>`:''}
          ${f.wattage?`<span>‚ö° ${f.wattage}</span>`:''}
        </div>
        ${f.location?`<div class="card-loc">üìç ${f.location}</div>`:''}
        ${f.specSheet?`<a href="${f.specSheet}" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center;gap:4px;font-size:10px;color:var(--accent);text-decoration:none;margin-top:5px;opacity:0.8;">üìÑ Spec Sheet ‚Üó</a>`:''}
        ${u?`<div class="card-co-info">With <strong>${u.name}</strong> ¬∑ ${timeAgo(f.checkedOutAt)}</div>`:''}
      </div>
      <div class="card-footer" onclick="event.stopPropagation()">
        ${f.status==='available'
          ? `<button class="btn btn-success" onclick="quickCheckout('${f.id}')">‚Üó Check Out</button>`
          : isMe || isAdmin
          ? `<button class="btn btn-danger" onclick="quickReturn('${f.id}')">‚Üô Return</button>`
          : `<button class="btn btn-secondary" disabled style="opacity:.4;cursor:not-allowed;">Unavailable</button>`}
        <button class="btn btn-secondary" onclick="openDetailModal('${f.id}');event.stopPropagation()">Details</button>
        ${isAdmin ? `<button class="btn btn-blue btn-sm" onclick="openEditFixture('${f.id}');event.stopPropagation()" title="Edit fixture">‚úèÔ∏è</button>` : ''}
      </div>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHECKOUT / RETURN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function quickCheckout(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f || f.status!=='available') return;
  f.status = 'out';
  f.checkedOutBy = currentUser.id;
  f.checkedOutAt = new Date().toISOString();
  const hco = logEvent(f, 'checkout');
  await saveData({ fixture: f, historyEntry: hco });
  refreshCurrentPage();
  notify(`‚úì Checked out: ${f.name}`, 'success');
}

async function quickReturn(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  const isAdmin = currentUser?.role === 'admin';
  if (!isAdmin && f.checkedOutBy !== currentUser.id) { notify('You can only return your own fixtures.', 'error'); return; }
  f.status = 'available';
  f.checkedOutBy = null;
  f.checkedOutAt = null;
  const hret = logEvent(f, 'return');
  await saveData({ fixture: f, historyEntry: hret });
  refreshCurrentPage();
  notify(`‚úì Returned: ${f.name}`, 'success');
}

function logEvent(f, action) {
  const entry = { ts: new Date().toISOString(), fixtureId: f.id, fixtureName: f.name, userId: currentUser.id, userName: currentUser.name, action };
  history.unshift(entry);
  return entry;
}

function refreshCurrentPage() {
  const active = document.querySelector('.page.active');
  if (!active) return;
  const id = active.id.replace('page-','');
  if (id==='home') renderHome();
  if (id==='library') { renderStats(); renderLibrary(); }
  if (id==='admin') { renderAdminFixtures(); renderForceReturn(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetailModal(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  const u = f.checkedOutBy ? users.find(x=>x.id===f.checkedOutBy) : null;
  const isMe = f.checkedOutBy === currentUser?.id;
  const isAdmin = currentUser?.role === 'admin';
  document.getElementById('detail-body').innerHTML = `
    <div style="display:flex;gap:20px;flex-wrap:wrap;">
      <div style="flex:1;min-width:180px;">
        <div style="margin-bottom:10px;"><span class="fid">${f.id}</span> <span class="sbadge ${f.status==='available'?'available':'out'}" style="margin-left:8px;">${f.status==='available'?'Available':'Checked Out'}</span></div>
        <div style="font-size:18px;font-weight:700;margin-bottom:12px;">${f.name}</div>
        <table style="font-size:13px;border-collapse:collapse;">
          ${drow('Brand',f.brand)}${drow('Type',f.category)}${drow('Wattage',f.wattage)}${drow('Finish',f.finish)}${drow('Location',f.location)}${drow('Notes',f.notes)}${drowLink('Spec Sheet',f.specSheet)}
          ${u?`<tr><td style="padding:5px 0;color:var(--text3);width:80px;">With</td><td style="padding:5px 0;color:var(--red);">${u.avatar} ${u.name} ¬∑ ${timeAgo(f.checkedOutAt)}</td></tr>`:''}
        </table>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
        <div id="detail-qr-${f.id}" class="qr-print-block" style="padding:14px;"></div>
        <div style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;">${f.id}</div>
      </div>
    </div>
  `;
  document.getElementById('detail-footer').innerHTML = `
    <button class="btn btn-secondary" onclick="closeModal('detail-modal')">Close</button>
    ${isAdmin ? `<button class="btn btn-blue" onclick="closeModal('detail-modal');openEditFixture('${f.id}')">‚úèÔ∏è Edit</button>` : ''}
    ${f.status==='available' ? `<button class="btn btn-success" onclick="quickCheckout('${f.id}');closeModal('detail-modal')">‚Üó Check Out</button>` : ''}
    ${(isMe||isAdmin) && f.status==='out' ? `<button class="btn btn-danger" onclick="quickReturn('${f.id}');closeModal('detail-modal')">‚Üô Return</button>` : ''}
  `;
  openModal('detail-modal');
  setTimeout(() => {
    const el = document.getElementById('detail-qr-'+f.id);
    if (el && !el.querySelector('canvas')) {
      new QRCode(el, { text:f.id, width:110, height:110, colorDark:'#111', colorLight:'#fff', correctLevel:QRCode.CorrectLevel.H });
    }
  }, 60);
}

function drow(l,v) { return v ? `<tr><td style="padding:5px 0;color:var(--text3);width:80px;">${l}</td><td style="padding:5px 0;">${v}</td></tr>` : ''; }
function drowLink(l,v) { return v ? `<tr><td style="padding:5px 0;color:var(--text3);width:80px;">${l}</td><td style="padding:5px 0;"><a href="${v}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:5px;font-size:13px;">üìÑ View Spec Sheet <span style="font-size:10px;opacity:0.7;">‚Üó</span></a></td></tr>` : ''; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateHistFilters() {
  const sel = document.getElementById('hist-user-filter');
  sel.innerHTML = '<option value="">All Users</option>' + users.map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
}

function renderHistory() {
  const uf = document.getElementById('hist-user-filter').value;
  const tf = document.getElementById('hist-type-filter').value;
  const list = history.filter(h => (!uf||h.userId===uf) && (!tf||h.action===tf));
  const tbody = document.getElementById('history-tbody');
  if (!list.length) { tbody.innerHTML=`<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text3);">No records found.</td></tr>`; return; }
  const actionColors = { checkout:'out', return:'available', added:'available', deleted:'out', edited:'available' };
  tbody.innerHTML = list.map(h=>`
    <tr>
      <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);">${new Date(h.ts).toLocaleString()}</td>
      <td class="mono">${h.fixtureId}</td>
      <td>${h.fixtureName}</td>
      <td>${h.userName}</td>
      <td><span class="sbadge ${actionColors[h.action]||'available'}">${h.action}</span></td>
    </tr>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADD FIXTURE (admin)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genId() { return 'LUM-' + String(fixtureCounter).padStart(4,'0'); }

function refreshAddId() {
  document.getElementById('new-fixture-id').value = genId();
  document.getElementById('new-qr-section').style.display = 'none';
}

async function addFixture() {
  const name = document.getElementById('new-name').value.trim();
  if (!name) { notify('Fixture name is required.','error'); return; }
  const f = {
    id: genId(), name,
    brand:    document.getElementById('new-brand').value.trim(),
    category: document.getElementById('new-category').value.trim(),
    wattage:  document.getElementById('new-wattage').value.trim(),
    finish:   document.getElementById('new-finish').value.trim(),
    location: document.getElementById('new-location').value.trim(),
    notes:    document.getElementById('new-notes').value.trim(),
    specSheet: document.getElementById('new-specsheet').value.trim(),
    status: 'available', checkedOutBy: null, checkedOutAt: null,
  };
  fixtures.push(f);
  fixtureCounter++;
  const hadd = logEvent(f, 'added');
  await saveData({ fixture: f, historyEntry: hadd, counter: true });
  populateFilters();
  notify(`‚úì Added ${f.id}: ${f.name}`, 'success');
  // Show QR
  document.getElementById('new-qr-section').style.display = 'block';
  document.getElementById('new-qr-id-text').textContent = f.id;
  document.getElementById('new-qr-name-text').textContent = f.name;
  const qrEl = document.getElementById('new-qr-code');
  qrEl.innerHTML = '';
  new QRCode(qrEl, { text:f.id, width:150, height:150, colorDark:'#111', colorLight:'#fff', correctLevel:QRCode.CorrectLevel.H });
  // Reset form
  ['new-name','new-brand','new-category','new-wattage','new-finish','new-location','new-notes','new-specsheet'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('new-fixture-id').value = genId();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRINT PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPrintPage() {
  const grid = document.getElementById('print-grid');
  grid.innerHTML = fixtures.map(f=>`
    <div class="print-card">
      <div id="pqr-${f.id}"></div>
      <div class="pid">${f.id}</div>
      <div class="pname">${f.name}</div>
      <div class="pbrand">${f.brand||''} ${f.category||''}</div>
    </div>
  `).join('');
  fixtures.forEach(f=>{
    setTimeout(()=>{
      const el = document.getElementById('pqr-'+f.id);
      if (el && !el.querySelector('canvas')) {
        new QRCode(el,{text:f.id,width:130,height:130,colorDark:'#111',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.H});
      }
    },50);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN ‚Äî USER MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedAv = 'üí°';

function renderUserList() {
  const el = document.getElementById('user-list');
  el.innerHTML = users.map(u=>`
    <div class="user-row">
      <div class="ur-avatar">${u.avatar}</div>
      <div class="ur-info">
        <div class="ur-name">${u.name} <span class="role-badge ${u.role}" style="margin-left:6px;">${u.role}</span></div>
        <div class="ur-pin">PIN: ${'‚Ä¢'.repeat(u.pin.length)} &nbsp;|&nbsp; ID: ${u.id}</div>
      </div>
      <div class="ur-actions">
        <button class="btn btn-blue btn-sm" onclick="openEditUser('${u.id}')">Edit</button>
        ${u.id !== currentUser?.id ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">Delete</button>` : `<span style="font-size:11px;color:var(--text3);padding:0 8px;">(you)</span>`}
      </div>
    </div>
  `).join('');
}

function openAddUserModal() {
  document.getElementById('nu-name').value = '';
  document.getElementById('nu-pin').value = '';
  document.getElementById('nu-role').value = 'user';
  selectedAv = 'üí°';
  document.querySelectorAll('.av-opt').forEach((el,i) => { el.style.border = i===0?'2px solid var(--accent)':'2px solid transparent'; });
  openModal('add-user-modal');
}

function pickAvatar(el) {
  document.querySelectorAll('.av-opt').forEach(a=>a.style.border='2px solid transparent');
  el.style.border = '2px solid var(--accent)';
  selectedAv = el.textContent;
}

async function addUser() {
  const name = document.getElementById('nu-name').value.trim();
  const pin  = document.getElementById('nu-pin').value.trim();
  const role = document.getElementById('nu-role').value;
  if (!name) { notify('Name required','error'); return; }
  if (!/^\d{4}$/.test(pin)) { notify('PIN must be exactly 4 digits','error'); return; }
  const newUser = { id:'u'+Date.now(), name, pin, role, avatar: selectedAv };
  users.push(newUser);
  await saveData({ user: newUser });
  closeModal('add-user-modal');
  renderUserList();
  renderLoginScreen();
  notify('User added!', 'success');
}

function openEditUser(uid) {
  const u = users.find(x=>x.id===uid);
  if (!u) return;
  document.getElementById('eu-id').value   = u.id;
  document.getElementById('eu-name').value = u.name;
  document.getElementById('eu-pin').value  = '';
  document.getElementById('eu-role').value = u.role;
  openModal('edit-user-modal');
}

async function saveEditUser() {
  const uid  = document.getElementById('eu-id').value;
  const name = document.getElementById('eu-name').value.trim();
  const pin  = document.getElementById('eu-pin').value.trim();
  const role = document.getElementById('eu-role').value;
  if (!name) { notify('Name required','error'); return; }
  if (pin && !/^\d{4}$/.test(pin)) { notify('PIN must be 4 digits','error'); return; }
  const u = users.find(x=>x.id===uid);
  if (!u) return;
  u.name = name;
  u.role = role;
  if (pin) u.pin = pin;
  await saveData({ user: u });
  closeModal('edit-user-modal');
  renderUserList();
  renderLoginScreen();
  notify('User updated!','success');
}

async function deleteUser(uid) {
  const u = users.find(x=>x.id===uid);
  if (!u) return;
  if (!confirm(`Delete user "${u.name}"? This cannot be undone.`)) return;
  users = users.filter(x=>x.id!==uid);
  await saveData({ deletedUserId: uid });
  renderUserList();
  renderLoginScreen();
  notify('User deleted.','info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN ‚Äî FIXTURE MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAdminFixtures() {
  const q = (document.getElementById('admin-search').value||'').toLowerCase();
  const list = fixtures.filter(f=>[f.id,f.name,f.brand,f.category].join(' ').toLowerCase().includes(q));
  const tbody = document.getElementById('admin-fixture-tbody');
  if (!list.length) { tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text3);">No fixtures.</td></tr>`; return; }
  tbody.innerHTML = list.map(f=>`
    <tr>
      <td class="mono">${f.id}</td>
      <td>${f.name}</td>
      <td style="color:var(--text2);">${f.brand||'‚Äî'}</td>
      <td style="color:var(--text2);font-size:11px;font-family:'DM Mono',monospace;">${f.location||'‚Äî'}</td>
      <td><span class="sbadge ${f.status==='available'?'available':'out'}">${f.status==='available'?'Available':'Out'}</span></td>
      <td style="white-space:nowrap;">
        <button class="btn btn-blue btn-sm" onclick="openEditFixture('${f.id}')">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteFixture('${f.id}')">Delete</button>
      </td>
    </tr>
  `).join('');
}

async function deleteFixture(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  if (f.status==='out') { notify('Return fixture before deleting.','error'); return; }
  if (!confirm(`Delete "${f.name}" (${f.id})? This cannot be undone.`)) return;
  fixtures = fixtures.filter(x=>x.id!==fid);
  const hdel = logEvent(f,'deleted');
  await saveData({ deletedFixtureId: fid, historyEntry: hdel });
  renderAdminFixtures();
  notify(`Deleted ${f.id}`,'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN ‚Äî FORCE RETURN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderForceReturn() {
  const coList = fixtures.filter(f=>f.status==='out');
  const el = document.getElementById('force-return-list');
  if (!coList.length) { el.innerHTML='<div style="color:var(--text3);font-size:13px;">Nothing currently checked out.</div>'; return; }
  el.innerHTML = coList.map(f=>{
    const u = users.find(x=>x.id===f.checkedOutBy);
    return `
      <div class="user-row" style="margin-bottom:8px;">
        <div style="flex:1;">
          <span class="fid">${f.id}</span>
          <span style="margin-left:10px;font-weight:500;">${f.name}</span>
          <span style="margin-left:10px;font-size:12px;color:var(--text2);">${u?u.avatar+' '+u.name:'Unknown'}</span>
          <span style="margin-left:8px;font-size:11px;color:var(--text3);">${timeAgo(f.checkedOutAt)}</span>
        </div>
        <button class="btn btn-danger btn-sm" onclick="forceReturn('${f.id}')">Force Return</button>
      </div>
    `;
  }).join('');
}

async function forceReturn(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  f.status = 'available';
  f.checkedOutBy = null;
  f.checkedOutAt = null;
  const hfr = logEvent(f,'return');
  await saveData({ fixture: f, historyEntry: hfr });
  renderForceReturn();
  renderAdminFixtures();
  notify(`Force returned: ${f.name}`,'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QR SCANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openScanModal() {
  openModal('scan-modal');
  document.getElementById('scan-result').style.display = 'none';
  document.getElementById('manual-id-input').value = '';
  startScanner();
}

function closeScanModal() {
  closeModal('scan-modal');
  stopScanner();
}

function startScanner() {
  stopScanner();
  scannerInstance = new Html5Qrcode('qr-reader');
  scannerInstance.start(
    {facingMode:'environment'},
    {fps:10, qrbox:{width:200,height:200}},
    (decoded) => { stopScanner(); processScannedId(decoded.trim()); },
    () => {}
  ).catch(() => {
    document.getElementById('qr-reader').innerHTML = '<div style="text-align:center;padding:30px;color:var(--text3);font-size:13px;">Camera unavailable.<br>Use manual ID entry below.</div>';
  });
}

function stopScanner() {
  if (scannerInstance) { scannerInstance.stop().catch(()=>{}); scannerInstance = null; }
}

function processManualId() {
  const id = document.getElementById('manual-id-input').value.trim().toUpperCase();
  if (!id) return;
  processScannedId(id);
}

function processScannedId(id) {
  const f = fixtures.find(x=>x.id===id);
  const el = document.getElementById('scan-result');
  el.style.display = 'block';
  if (!f) { el.innerHTML=`<div style="color:var(--red);">‚ùå Fixture "${id}" not found.</div>`; return; }
  const u = f.checkedOutBy ? users.find(x=>x.id===f.checkedOutBy) : null;
  const isMe = f.checkedOutBy === currentUser?.id;
  const isAdmin = currentUser?.role === 'admin';
  el.innerHTML = `
    <div style="margin-bottom:12px;">
      <span class="fid">${f.id}</span>
      <div style="font-size:15px;font-weight:600;margin-top:6px;">${f.name}</div>
      <div style="font-size:12px;color:var(--text2);margin-top:2px;">${f.brand||''} ${f.category||''}</div>
      <div style="margin-top:8px;">
        <span class="sbadge ${f.status==='available'?'available':'out'}">${f.status==='available'?'Available':'Checked Out'}</span>
        ${u?`<span style="font-size:12px;color:var(--text2);margin-left:8px;">${u.avatar} ${u.name}</span>`:''}
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      ${f.status==='available'
        ? `<button class="btn btn-success" onclick="quickCheckout('${f.id}');closeScanModal();">‚Üó Check Out</button>`
        : (isMe||isAdmin)
        ? `<button class="btn btn-danger" onclick="quickReturn('${f.id}');closeScanModal();">‚Üô Return</button>`
        : `<span style="font-size:12px;color:var(--red);">Only ${u?.name||'the owner'} can return this.</span>`}
      <button class="btn btn-secondary" onclick="closeScanModal();openDetailModal('${f.id}')">Details</button>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EDIT FIXTURE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openEditFixture(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  document.getElementById('ef-id').value       = f.id;
  document.getElementById('ef-fid').value      = f.id;
  document.getElementById('ef-name').value     = f.name;
  document.getElementById('ef-brand').value    = f.brand    || '';
  document.getElementById('ef-category').value = f.category || '';
  document.getElementById('ef-wattage').value  = f.wattage  || '';
  document.getElementById('ef-finish').value   = f.finish   || '';
  document.getElementById('ef-location').value = f.location || '';
  document.getElementById('ef-notes').value    = f.notes    || '';
  document.getElementById('ef-specsheet').value = f.specSheet || '';
  openModal('edit-fixture-modal');
}

async function saveEditFixture() {
  const fid = document.getElementById('ef-id').value;
  const f   = fixtures.find(x=>x.id===fid);
  if (!f) return;
  const name = document.getElementById('ef-name').value.trim();
  if (!name) { notify('Fixture name is required.','error'); return; }
  f.name     = name;
  f.brand    = document.getElementById('ef-brand').value.trim();
  f.category = document.getElementById('ef-category').value.trim();
  f.wattage  = document.getElementById('ef-wattage').value.trim();
  f.finish   = document.getElementById('ef-finish').value.trim();
  f.location = document.getElementById('ef-location').value.trim();
  f.notes    = document.getElementById('ef-notes').value.trim();
  f.specSheet = document.getElementById('ef-specsheet').value.trim();
  // Auto-add new location to list if not already there
  if (f.location && !locations.includes(f.location)) {
    locations.push(f.location);
    locations.sort();
  }
  const hedit = logEvent(f,'edited');
  await saveData({ fixture: f, historyEntry: hedit });
  closeModal('edit-fixture-modal');
  refreshCurrentPage();
  populateFilters();
  notify(`‚úì Updated: ${f.name}`,'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOCATION COMBO DROPDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showLocDropdown(inputId, dropId) {
  filterLocDropdown(inputId, dropId);
  document.getElementById(dropId).style.display = 'block';
}

function hideLocDropdown(dropId) {
  const el = document.getElementById(dropId);
  if (el) el.style.display = 'none';
}

function filterLocDropdown(inputId, dropId) {
  const q   = (document.getElementById(inputId).value||'').toLowerCase();
  const drop = document.getElementById(dropId);
  if (!drop) return;
  const filtered = locations.filter(l => l.toLowerCase().includes(q));
  const showAdd  = q && !locations.some(l=>l.toLowerCase()===q);
  drop.innerHTML = filtered.map(l =>
    `<div class="loc-option" onmousedown="pickLocation('${inputId}','${dropId}','${l.replace(/'/g,"\'")}')">üìç ${l}</div>`
  ).join('') + (showAdd ? `<div class="loc-option add-new" onmousedown="addAndPickLocation('${inputId}','${dropId}')">Ôºã Add "${document.getElementById(inputId).value}"</div>` : '');
  drop.style.display = 'block';
}

function pickLocation(inputId, dropId, val) {
  document.getElementById(inputId).value = val;
  hideLocDropdown(dropId);
}

async function addAndPickLocation(inputId, dropId) {
  const val = document.getElementById(inputId).value.trim();
  if (!val || locations.includes(val)) return;
  locations.push(val);
  locations.sort();
  await saveData({ location: val });
  hideLocDropdown(dropId);
  renderLocationPreview();
  notify(`Location "${val}" added`,'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOCATION MANAGEMENT (admin)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLocationsModal() {
  renderLocationsList();
  openModal('locations-modal');
}

function renderLocationsList() {
  const el = document.getElementById('locations-list');
  if (!el) return;
  el.innerHTML = locations.map((l,i) => `
    <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);">
      <span style="flex:1;font-size:13px;">üìç ${l}</span>
      <button class="btn btn-danger btn-sm" onclick="removeLocation(${i})">Remove</button>
    </div>
  `).join('');
}

async function addLocation() {
  const val = document.getElementById('new-location-input').value.trim();
  if (!val) return;
  if (locations.includes(val)) { notify('Already exists','error'); return; }
  locations.push(val);
  locations.sort();
  document.getElementById('new-location-input').value = '';
  await saveData({ location: val });
  renderLocationsList();
  renderLocationPreview();
  notify(`‚úì Added location: ${val}`,'success');
}

async function removeLocation(idx) {
  const removed = locations[idx];
  locations.splice(idx,1);
  await saveData({ deletedLocation: removed });
  renderLocationsList();
  renderLocationPreview();
}

function renderLocationPreview() {
  const el = document.getElementById('location-preview');
  if (!el) return;
  el.innerHTML = locations.map(l =>
    `<span style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 10px;font-size:11px;font-family:'DM Mono',monospace;color:var(--text2);">üìç ${l}</span>`
  ).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EMBEDDED APPS SCRIPT CODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const APPS_SCRIPT_CODE = `// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LumaSamples ‚Äî Google Apps Script Backend
//  Paste this entire file into:
//    Google Sheets ‚Üí Extensions ‚Üí Apps Script ‚Üí Replace all code ‚Üí Save
//  Then: Deploy ‚Üí New deployment ‚Üí Web app
//        Execute as: Me | Who has access: Anyone ‚Üí Deploy ‚Üí Copy URL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const SHEET_NAME_FIXTURES  = 'Fixtures';
const SHEET_NAME_USERS     = 'Users';
const SHEET_NAME_HISTORY   = 'History';
const SHEET_NAME_LOCATIONS = 'Locations';
const SHEET_NAME_CONFIG    = 'Config';

// ‚îÄ‚îÄ Bootstrap: create all sheets with headers if missing ‚îÄ‚îÄ
function setupSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const sheets = {
    [SHEET_NAME_FIXTURES]:  ['id','name','brand','category','wattage','finish','location','notes','specSheet','status','checkedOutBy','checkedOutAt','updatedAt'],
    [SHEET_NAME_USERS]:     ['id','name','pin','role','avatar'],
    [SHEET_NAME_HISTORY]:   ['ts','fixtureId','fixtureName','userId','userName','action'],
    [SHEET_NAME_LOCATIONS]: ['name'],
    [SHEET_NAME_CONFIG]:    ['key','value'],
  };

  for (const [name, headers] of Object.entries(sheets)) {
    let sheet = ss.getSheetByName(name);
    if (!sheet) {
      sheet = ss.insertSheet(name);
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      sheet.getRange(1, 1, 1, headers.length)
        .setBackground('#1a1a2e').setFontColor('#f5c842')
        .setFontWeight('bold').setFrozenRows(1);
      sheet.setColumnWidths(1, headers.length, 160);
    }
  }

  // Seed admin user if Users sheet is empty
  const usersSheet = ss.getSheetByName(SHEET_NAME_USERS);
  if (usersSheet.getLastRow() <= 1) {
    usersSheet.appendRow(['admin-1','Admin','4116','admin','‚öôÔ∏è']);
  }

  // Seed default locations if empty
  const locSheet = ss.getSheetByName(SHEET_NAME_LOCATIONS);
  if (locSheet.getLastRow() <= 1) {
    const defaults = ['Shelf A-1','Shelf A-2','Shelf B-1','Shelf B-2','Shelf B-3',
                      'Shelf C-1','Shelf C-2','Storage Room','Display Floor','Front Desk','Back Office'];
    defaults.forEach(l => locSheet.appendRow([l]));
  }

  // Seed counter in config
  const cfg = ss.getSheetByName(SHEET_NAME_CONFIG);
  if (cfg.getLastRow() <= 1) {
    cfg.appendRow(['fixtureCounter','42']);
  }

  SpreadsheetApp.flush();
  return { status: 'ok', message: 'Sheets ready' };
}

// ‚îÄ‚îÄ CORS helper ‚îÄ‚îÄ
function corsResponse(data) {
  const output = ContentService.createTextOutput(JSON.stringify(data));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

// ‚îÄ‚îÄ GET handler ‚Äî fetch all data ‚îÄ‚îÄ
function doGet(e) {
  try {
    const action = e.parameter.action || 'all';
    if (action === 'all')       return corsResponse(getAllData());
    if (action === 'fixtures')  return corsResponse(getSheet(SHEET_NAME_FIXTURES));
    if (action === 'users')     return corsResponse(getSheet(SHEET_NAME_USERS));
    if (action === 'history')   return corsResponse(getHistory());
    if (action === 'locations') return corsResponse(getSheet(SHEET_NAME_LOCATIONS));
    if (action === 'config')    return corsResponse(getConfig());
    if (action === 'setup')     return corsResponse(setupSheets());
    return corsResponse({ error: 'Unknown action' });
  } catch(err) {
    return corsResponse({ error: err.toString() });
  }
}

// ‚îÄ‚îÄ POST handler ‚Äî write data ‚îÄ‚îÄ
function doPost(e) {
  try {
    const body   = JSON.parse(e.postData.contents);
    const action = body.action;

    if (action === 'upsertFixture')   return corsResponse(upsertFixture(body.data));
    if (action === 'deleteFixture')   return corsResponse(deleteRow(SHEET_NAME_FIXTURES, 'id', body.id));
    if (action === 'upsertUser')      return corsResponse(upsertUser(body.data));
    if (action === 'deleteUser')      return corsResponse(deleteRow(SHEET_NAME_USERS, 'id', body.id));
    if (action === 'addHistory')      return corsResponse(addHistoryRow(body.data));
    if (action === 'addLocation')     return corsResponse(addLocation(body.name));
    if (action === 'deleteLocation')  return corsResponse(deleteRow(SHEET_NAME_LOCATIONS, 'name', body.name));
    if (action === 'setConfig')       return corsResponse(setConfig(body.key, body.value));
    if (action === 'syncAll')         return corsResponse(syncAll(body.data));

    return corsResponse({ error: 'Unknown action: ' + action });
  } catch(err) {
    return corsResponse({ error: err.toString() });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  READ HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getAllData() {
  return {
    fixtures:  getSheet(SHEET_NAME_FIXTURES),
    users:     getSheet(SHEET_NAME_USERS),
    history:   getHistory(),
    locations: getSheet(SHEET_NAME_LOCATIONS).map(r => r.name),
    config:    getConfig(),
    ts:        new Date().toISOString(),
  };
}

function getSheet(name) {
  const ss    = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(name);
  if (!sheet || sheet.getLastRow() <= 1) return [];
  const [headers, ...rows] = sheet.getDataRange().getValues();
  return rows.filter(r => r[0] !== '').map(row => {
    const obj = {};
    headers.forEach((h, i) => { obj[h] = row[i] === '' ? null : row[i]; });
    return obj;
  });
}

function getHistory() {
  const rows = getSheet(SHEET_NAME_HISTORY);
  // Return newest first, max 500 rows
  return rows.reverse().slice(0, 500);
}

function getConfig() {
  const rows = getSheet(SHEET_NAME_CONFIG);
  const cfg  = {};
  rows.forEach(r => { cfg[r.key] = r.value; });
  return cfg;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WRITE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function upsertFixture(f) {
  const ss    = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_FIXTURES);
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const row     = headers.map(h => f[h] !== undefined ? (f[h] === null ? '' : f[h]) : '');
  row[headers.indexOf('updatedAt')] = new Date().toISOString();

  const idCol  = headers.indexOf('id') + 1;
  const data   = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][idCol - 1] === f.id) {
      sheet.getRange(i + 1, 1, 1, row.length).setValues([row]);
      SpreadsheetApp.flush();
      return { status: 'updated', id: f.id };
    }
  }
  sheet.appendRow(row);
  SpreadsheetApp.flush();
  return { status: 'inserted', id: f.id };
}

function upsertUser(u) {
  const ss    = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_USERS);
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const row     = headers.map(h => u[h] !== undefined ? (u[h] === null ? '' : u[h]) : '');

  const idCol = headers.indexOf('id') + 1;
  const data  = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][idCol - 1] === u.id) {
      sheet.getRange(i + 1, 1, 1, row.length).setValues([row]);
      SpreadsheetApp.flush();
      return { status: 'updated', id: u.id };
    }
  }
  sheet.appendRow(row);
  SpreadsheetApp.flush();
  return { status: 'inserted', id: u.id };
}

function addHistoryRow(h) {
  const ss    = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_HISTORY);
  sheet.appendRow([h.ts || new Date().toISOString(), h.fixtureId, h.fixtureName, h.userId, h.userName, h.action]);
  SpreadsheetApp.flush();
  return { status: 'ok' };
}

function addLocation(name) {
  const ss    = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_LOCATIONS);
  const existing = sheet.getDataRange().getValues().flat();
  if (existing.includes(name)) return { status: 'exists' };
  sheet.appendRow([name]);
  SpreadsheetApp.flush();
  return { status: 'ok' };
}

function deleteRow(sheetName, colName, value) {
  const ss    = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet || sheet.getLastRow() <= 1) return { status: 'not_found' };
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const colIdx  = headers.indexOf(colName);
  if (colIdx < 0) return { status: 'col_not_found' };
  const data = sheet.getDataRange().getValues();
  for (let i = data.length - 1; i >= 1; i--) {
    if (String(data[i][colIdx]) === String(value)) {
      sheet.deleteRow(i + 1);
      SpreadsheetApp.flush();
      return { status: 'deleted' };
    }
  }
  return { status: 'not_found' };
}

function setConfig(key, value) {
  const ss    = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_CONFIG);
  const data  = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === key) {
      sheet.getRange(i + 1, 2).setValue(value);
      SpreadsheetApp.flush();
      return { status: 'updated' };
    }
  }
  sheet.appendRow([key, value]);
  SpreadsheetApp.flush();
  return { status: 'inserted' };
}

// Full sync ‚Äî replaces entire fixtures + users + locations sheets
function syncAll(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  if (data.fixtures) {
    const sheet = ss.getSheetByName(SHEET_NAME_FIXTURES);
    const headers = ['id','name','brand','category','wattage','finish','location','notes','specSheet','status','checkedOutBy','checkedOutAt','updatedAt'];
    if (sheet.getLastRow() > 1) sheet.getRange(2, 1, sheet.getMaxRows() - 1, headers.length).clearContent();
    if (data.fixtures.length) {
      const rows = data.fixtures.map(f => headers.map(h => f[h] !== undefined ? (f[h] === null ? '' : f[h]) : ''));
      sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
    }
  }

  SpreadsheetApp.flush();
  return { status: 'ok' };
}
`;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETUP PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSetupPage() {
  // Fill code preview
  const pre = document.getElementById('appscript-preview');
  if (pre) pre.textContent = APPS_SCRIPT_CODE;

  // Show status banner
  const banner = document.getElementById('setup-status-banner');
  if (banner) {
    if (gsUrl) {
      banner.style.background = 'rgba(74,222,128,0.06)';
      banner.style.border = '1px solid rgba(74,222,128,0.25)';
      banner.innerHTML = `<span style="font-size:22px;">‚úÖ</span><div><div style="font-weight:600;color:var(--green);">Syncing with Google Sheets</div><div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:2px;word-break:break-all;">${gsUrl}</div></div>`;
    } else {
      banner.style.background = 'rgba(245,200,66,0.06)';
      banner.style.border = '1px solid rgba(245,200,66,0.2)';
      banner.innerHTML = `<span style="font-size:22px;">‚ö†Ô∏è</span><div><div style="font-weight:600;color:var(--accent);">Not connected</div><div style="font-size:12px;color:var(--text2);margin-top:2px;">Follow the steps below to connect LumaSamples to Google Sheets.</div></div>`;
    }
  }

  // Show/hide connect vs connected block
  const connectCard = document.getElementById('setup-connect-card');
  const connectedBlock = document.getElementById('setup-connected-block');
  const urlEl = document.getElementById('setup-connected-url');
  if (gsUrl) {
    if (connectCard)    connectCard.style.display = 'none';
    if (connectedBlock) connectedBlock.style.display = 'block';
    if (urlEl)          urlEl.textContent = gsUrl;
  } else {
    if (connectCard)    connectCard.style.display = 'flex';
    if (connectedBlock) connectedBlock.style.display = 'none';
    // Pre-fill URL input if there was a previous value
    const input = document.getElementById('setup-url-input');
    if (input && !input.value) input.value = '';
  }
}

function copyAppScript(btn) {
  navigator.clipboard.writeText(APPS_SCRIPT_CODE).then(() => {
    const label = document.getElementById('copy-btn-label');
    if (label) { label.textContent = 'Copied!'; setTimeout(() => label.textContent = 'Copy Code', 2500); }
  }).catch(() => {
    // Fallback: select the pre text
    const pre = document.getElementById('appscript-preview');
    if (pre) {
      const range = document.createRange();
      range.selectNodeContents(pre);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }
    notify('Code selected ‚Äî press Ctrl+C to copy', 'info');
  });
}

async function connectFromSetup() {
  const url = document.getElementById('setup-url-input').value.trim();
  const fb  = document.getElementById('setup-connect-feedback');
  if (!url || !url.includes('script.google.com')) {
    if (fb) { fb.style.display='block'; fb.style.color='var(--red)'; fb.textContent='‚ö† Please paste a valid Google Apps Script URL (should contain script.google.com)'; }
    return;
  }
  if (fb) { fb.style.display='block'; fb.style.color='var(--accent)'; fb.textContent='Connecting‚Ä¶'; }
  await connectGoogleSheets(url);
  renderSetupPage();
  if (fb) fb.style.display = 'none';
}

function disconnectFromSetup() {
  disconnectGoogleSheets();
  renderSetupPage();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GOOGLE SHEETS STATUS (admin panel)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGsStatus() {
  const btns  = document.getElementById('gs-action-btns');
  const block = document.getElementById('gs-status-block');
  if (!btns || !block) return;
  if (gsUrl) {
    btns.innerHTML = `
      <button class="btn btn-secondary btn-sm" onclick="gsPullAll()">‚Üª Sync Now</button>
      <button class="btn btn-danger btn-sm" onclick="disconnectGoogleSheets()">Disconnect</button>
    `;
    block.innerHTML = `<span style="color:var(--green);">‚úì Connected</span> <span style="color:var(--text3);margin-left:8px;font-size:11px;font-family:'DM Mono',monospace;">${gsUrl.substring(0,60)}‚Ä¶</span>`;
  } else {
    btns.innerHTML = `<button class="btn btn-primary btn-sm" onclick="openModal('gs-setup-modal')">Connect Google Sheets</button>`;
    block.innerHTML = `<span style="color:var(--text3);">Not connected ‚Äî data is stored locally only.</span>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function timeAgo(ts) {
  if (!ts) return '';
  const d = Math.floor((Date.now()-new Date(ts))/1000);
  if (d<60) return `${d}s ago`;
  if (d<3600) return `${Math.floor(d/60)}m ago`;
  if (d<86400) return `${Math.floor(d/3600)}h ago`;
  return `${Math.floor(d/86400)}d ago`;
}

function notify(msg, type='success') {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.className = 'notif show ' + type;
  setTimeout(()=>{el.className='notif';},3000);
}

// Keyboard PIN support
document.addEventListener('keydown', e => {
  if (document.getElementById('pin-entry').style.display!=='none') {
    if (e.key>='0'&&e.key<='9') pinPress(e.key);
    if (e.key==='Backspace') pinBackspace();
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  await loadData();
  renderLoginScreen();
}

init();
</script>
</body>
</html>
