<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="LumaSamples">
<meta name="theme-color" content="#0a0a0c">
<title>LumaSamples â€” Fixture Library</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’¡</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<!-- Firebase compat SDK (v9) â€” loads as globals, works on all hosts including GitHub Pages -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
:root {
  --bg: #0a0a0c;
  --surface: #111114;
  --surface2: #18181c;
  --surface3: #202025;
  --accent: #f5c842;
  --accent-dim: rgba(245,200,66,0.12);
  --accent2: #ff6b35;
  --text: #eeeee8;
  --text2: #8a8880;
  --text3: #44443e;
  --border: #222228;
  --border2: #2e2e35;
  --green: #4ade80;
  --green-dim: rgba(74,222,128,0.1);
  --red: #f87171;
  --red-dim: rgba(248,113,113,0.1);
  --blue: #60a5fa;
  --radius: 14px;
  --radius-sm: 9px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
}
body.light-mode {
  --bg: #f5f5f0;
  --surface: #ffffff;
  --surface2: #eeeee8;
  --surface3: #e4e4dc;
  --accent: #d4a800;
  --accent-dim: rgba(212,168,0,0.12);
  --text: #1a1a18;
  --text2: #555550;
  --text3: #999990;
  --border: #ddddd8;
  --border2: #cccccc;
  --green: #16a34a;
  --green-dim: rgba(22,163,74,0.1);
  --red: #dc2626;
  --red-dim: rgba(220,38,38,0.1);
  --blue: #2563eb;
  --shadow: 0 4px 24px rgba(0,0,0,0.12);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 15px;
  overflow-x: hidden;
}

/* â”€â”€ LOGIN CHECKED-OUT BOARD â”€â”€ */
.login-co-row {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--red);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  margin-bottom: 6px;
  transition: border-color 0.15s, background 0.15s;
}
.login-co-row:hover { background: var(--surface2); border-color: var(--border2); }
.login-co-id   { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--accent); background: var(--accent-dim); padding: 2px 6px; border-radius: 4px; white-space: nowrap; }
.login-co-name { font-size: 13px; font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.login-co-user { font-size: 11px; color: var(--text2); white-space: nowrap; }
.login-co-time { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text3); white-space: nowrap; }

/* â”€â”€ LOGIN SCREEN â”€â”€ */
#login-screen {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
  background: var(--bg);
  position: relative;
}
#login-screen::before { display: none; }
#login-screen::after { display: none; }
#login-halo {
  position: absolute;
  top: -180px; left: 50%; transform: translateX(-50%);
  width: 900px; height: 900px;
  background: radial-gradient(circle, rgba(245,200,66,0.38) 0%, rgba(245,200,66,0.18) 28%, rgba(245,200,66,0.06) 55%, transparent 72%);
  pointer-events: none;
  z-index: 0;
}
.login-logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 52px;
  letter-spacing: 4px;
  color: var(--accent);
  margin-bottom: 4px;
  text-align: center;
}
.login-sub {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  letter-spacing: 3px;
  color: var(--text3);
  text-transform: uppercase;
  margin-bottom: 40px;
  text-align: center;
}
.user-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 12px;
  width: 100%;
  max-width: 560px;
  margin-bottom: 16px;
}
.user-login-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 12px 16px;
  cursor: pointer;
  text-align: center;
  transition: all 0.18s;
  position: relative;
  overflow: hidden;
}
.user-login-card:hover {
  border-color: var(--accent);
  background: var(--surface2);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(245,200,66,0.08);
}
.user-login-card.admin-card { border-color: rgba(96,165,250,0.25); }
.user-login-card.admin-card:hover { border-color: var(--blue); box-shadow: 0 8px 24px rgba(96,165,250,0.1); }
.ulc-avatar { font-size: 30px; margin-bottom: 10px; display: block; }
.ulc-name { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.ulc-role {
  font-size: 10px;
  font-family: 'DM Mono', monospace;
  padding: 2px 7px;
  border-radius: 10px;
  display: inline-block;
}
.ulc-role.admin { background: rgba(96,165,250,0.15); color: var(--blue); }
.ulc-role.user { background: var(--surface3); color: var(--text3); }

/* PIN PAD */
.pin-screen {
  width: 100%;
  max-width: 320px;
  animation: fadeSlideUp 0.25s ease;
}
@keyframes fadeSlideUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:none; } }
.pin-header {
  text-align: center;
  margin-bottom: 28px;
}
.pin-avatar { font-size: 40px; margin-bottom: 8px; }
.pin-name { font-size: 20px; font-weight: 600; }
.pin-hint { font-size: 12px; color: var(--text2); margin-top: 4px; }
.pin-dots {
  display: flex;
  gap: 14px;
  justify-content: center;
  margin-bottom: 28px;
}
.pin-dot {
  width: 14px; height: 14px;
  border-radius: 50%;
  border: 2px solid var(--border2);
  transition: all 0.15s;
}
.pin-dot.filled { background: var(--accent); border-color: var(--accent); }
.pin-dot.error { background: var(--red); border-color: var(--red); animation: shake 0.4s ease; }
@keyframes shake { 0%,100%{transform:none} 20%{transform:translateX(-4px)} 40%{transform:translateX(4px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
.pin-pad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 16px;
}
.pin-key {
  height: 56px;          /* fixed height, no aspect-ratio */
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 22px;
  font-weight: 600;
  color: var(--text);
  cursor: pointer;
  transition: all 0.12s;
  display: flex; align-items: center; justify-content: center;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}
.pin-key:hover { background: var(--surface3); border-color: var(--border2); }
.pin-key:active { transform: scale(0.93); background: var(--surface3); }
.pin-key.del { font-size: 18px; color: var(--text2); }
.pin-back-btn {
  width: 100%;
  background: none;
  border: none;
  color: var(--text3);
  font-size: 13px;
  cursor: pointer;
  padding: 8px;
  font-family: 'DM Sans', sans-serif;
  transition: color 0.15s;
}
.pin-back-btn:hover { color: var(--text2); }

/* â”€â”€ HEADER â”€â”€ */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  height: 58px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  overflow: hidden;
}
header::before {
  content: '';
  position: absolute;
  top: -60px; left: 0;
  width: 340px; height: 200px;
  background: radial-gradient(ellipse at 20% 50%, rgba(245,200,66,0.14) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}
body.light-mode header::before {
  background: radial-gradient(ellipse at 20% 50%, rgba(212,168,0,0.12) 0%, transparent 70%);
}
header > * { position: relative; z-index: 1; }
.logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 24px;
  letter-spacing: 2px;
  color: var(--accent);
}
.logo-sub { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text3); letter-spacing: 2px; margin-left: 8px; text-transform: uppercase; }
.header-right { display: flex; align-items: center; gap: 10px; }
.user-chip {
  background: var(--surface3);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 5px 12px 5px 8px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  display: flex; align-items: center; gap: 6px;
  transition: all 0.15s;
}
.user-chip:hover { border-color: var(--text3); color: var(--text); }
.user-chip .chip-avatar { font-size: 16px; }
.chip-role-hide { display: none !important; }
.role-badge {
  font-size: 9px;
  font-family: 'DM Mono', monospace;
  padding: 1px 6px;
  border-radius: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.role-badge.admin { background: rgba(96,165,250,0.15); color: var(--blue); }
.role-badge.user { background: var(--surface2); color: var(--text3); }

/* â”€â”€ NAV â”€â”€ */
.nav-tabs {
  display: flex;
  gap: 0;
  padding: 0 24px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  overflow-x: auto;
  scrollbar-width: none;
}
.nav-tabs::-webkit-scrollbar { display: none; }
.nav-tab {
  padding: 14px 18px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text3);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  white-space: nowrap;
  transition: all 0.2s;
  display: flex; align-items: center; gap: 6px;
}
.nav-tab:hover { color: var(--text2); }
.nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.nav-tab .tab-icon { font-size: 14px; }
.nav-tab.admin-tab { color: rgba(96,165,250,0.5); }
.nav-tab.admin-tab.active { color: var(--blue); border-bottom-color: var(--blue); }
.nav-tab.admin-tab:hover { color: var(--blue); }

/* â”€â”€ MAIN â”€â”€ */
main { padding: 24px; max-width: 1400px; margin: 0 auto; }
#page-history { height: calc(100vh - 180px); }
/* On mobile, account for bottom tab bar (~64px) */
@media (max-width: 580px) { #page-history { height: calc(100vh - 220px); } }
body.is-mobile #page-history { height: calc(100vh - 220px); }
.page { display: none; }
.page.active { display: block; }
#page-history.active { display: flex; flex-direction: column; }
#page-history .table-wrap { flex: 1; overflow-y: auto; max-height: none !important; }
#page-history table { height: 100%; }

/* â”€â”€ HOMEPAGE: CURRENTLY OUT â”€â”€ */
.home-hero {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 28px;
}
@media (max-width: 640px) { .home-hero { grid-template-columns: 1fr 1fr; } }
.hero-stat {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 22px;
}
.hero-stat.green  { background: rgba(74,222,128,0.06);  border-color: rgba(74,222,128,0.2); }
.hero-stat.red    { background: rgba(248,113,113,0.06); border-color: rgba(248,113,113,0.2); }
.hero-stat.accent { background: rgba(245,200,66,0.06);  border-color: rgba(245,200,66,0.2); }
.hero-stat.blue   { background: rgba(96,165,250,0.06);  border-color: rgba(96,165,250,0.2); }
.hero-stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text3); font-family: 'DM Mono', monospace; margin-bottom: 6px; }
.hero-stat-val { font-size: 42px; font-family: 'Bebas Neue', sans-serif; line-height: 1; }
.hero-stat-val.accent { color: var(--accent); }
.hero-stat-val.green { color: var(--green); }
.hero-stat-val.red { color: var(--red); }
.hero-stat-val.blue { color: var(--blue); }

.section-heading {
  font-size: 11px;
  font-family: 'DM Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text3);
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 10px;
}
.section-heading::after { content:''; flex:1; height:1px; background:var(--border); }

/* CHECKED OUT LIST */
.checked-out-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 32px; }
.co-row {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--red);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  display: grid;
  grid-template-columns: auto 1fr auto auto;
  align-items: center;
  gap: 14px;
  transition: border-color 0.2s;
}
.co-row:hover { border-color: var(--border2); border-left-color: var(--red); }
.co-id { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--accent); background: var(--accent-dim); padding: 3px 8px; border-radius: 5px; white-space: nowrap; }
.co-info { min-width: 0; }
.co-name { font-size: 15px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.co-meta { font-size: 13px; color: var(--text2); margin-top: 2px; }
.co-user {
  display: flex; align-items: center; gap: 6px;
  background: var(--surface2);
  border-radius: 20px;
  padding: 4px 10px 4px 6px;
  font-size: 12px;
  white-space: nowrap;
}
.co-user .avatar { font-size: 14px; }
.co-time { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text3); white-space: nowrap; }

/* My checkouts widget on home */
.my-co-strip {
  background: linear-gradient(135deg, rgba(245,200,66,0.06), rgba(245,200,66,0.02));
  border: 1px solid rgba(245,200,66,0.15);
  border-radius: var(--radius);
  padding: 16px 20px;
  margin-bottom: 28px;
}
.my-co-strip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.my-co-strip-title { font-size: 13px; font-weight: 600; color: var(--accent); }
.my-co-items { display: flex; flex-wrap: wrap; gap: 8px; }
.my-co-pill {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 12px;
  display: flex; align-items: center; gap: 6px;
  cursor: pointer;
  transition: all 0.15s;
}
.my-co-pill:hover { border-color: var(--red); color: var(--red); }
.my-co-pill .pill-id { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text3); }

/* â”€â”€ STATS BAR â”€â”€ */
.stats-bar {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 10px;
  margin-bottom: 22px;
}
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 18px;
}
.stat-card.green  { background: rgba(74,222,128,0.06);  border-color: rgba(74,222,128,0.2); }
.stat-card.red    { background: rgba(248,113,113,0.06); border-color: rgba(248,113,113,0.2); }
.stat-card.accent { background: rgba(245,200,66,0.06);  border-color: rgba(245,200,66,0.2); }
.stat-card.blue   { background: rgba(96,165,250,0.06);  border-color: rgba(96,165,250,0.2); }
.stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); font-family: 'DM Mono', monospace; }
.stat-value { font-size: 28px; font-family: 'Bebas Neue', sans-serif; margin-top: 2px; }
.stat-value.green { color: var(--green); }
.stat-value.red { color: var(--red); }
.stat-value.accent { color: var(--accent); }
.stat-value.blue { color: var(--blue); }

/* â”€â”€ TOOLBAR â”€â”€ */
.toolbar { display: flex; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
.search-box {
  flex: 1; min-width: 200px;
  display: flex; align-items: center;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0 14px; gap: 8px;
}
.search-box input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-size: 14px; padding: 10px 0;
  font-family: 'DM Sans', sans-serif;
}
.search-box input::placeholder { color: var(--text3); }
.filter-select {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 12px;
  color: var(--text2); font-size: 13px;
  font-family: 'DM Sans', sans-serif; outline: none; cursor: pointer;
}

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  padding: 9px 16px; border-radius: var(--radius-sm); border: none;
  font-size: 13px; font-weight: 600; cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  display: inline-flex; align-items: center; gap: 6px;
  transition: all 0.15s; white-space: nowrap;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-primary:hover { background: #ffd84a; }
.btn-secondary { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
.btn-secondary:hover { color: var(--text); border-color: var(--border2); }
.btn-danger { background: var(--red-dim); color: var(--red); border: 1px solid rgba(248,113,113,0.2); }
.btn-danger:hover { background: rgba(248,113,113,0.18); }
.btn-success { background: var(--green-dim); color: var(--green); border: 1px solid rgba(74,222,128,0.2); }
.btn-warning { background: rgba(251,191,36,0.1); color: #fbbf24; border: 1px solid rgba(251,191,36,0.25); }
.btn-warning:hover { background: rgba(251,191,36,0.2); }
.btn-warning { background: rgba(251,191,36,0.12); color: #fbbf24; border: 1px solid rgba(251,191,36,0.25); }
.btn-warning:hover { background: rgba(251,191,36,0.22); }
.btn-success:hover { background: rgba(74,222,128,0.18); }
.btn-scan { background: var(--accent2); color: #fff; padding: 6px 10px; font-size: 18px; min-width: 36px; border-radius: 10px; display:inline-flex; align-items:center; justify-content:center; line-height:1; }
.btn-scan:hover { background: #ff7c47; }
.btn-sync { background: var(--surface3); border: 1px solid var(--border2); color: var(--text2); padding: 5px 10px; font-size: 16px; border-radius: 10px; min-width: 36px; }
.btn-sync:hover { border-color: var(--text3); color: var(--text); }
.btn-sync.syncing { color: var(--accent); border-color: rgba(245,200,66,0.4); animation: syncPulse 1s infinite; }
.btn-blue { background: rgba(96,165,250,0.12); color: var(--blue); border: 1px solid rgba(96,165,250,0.2); }
.btn-blue:hover { background: rgba(96,165,250,0.2); }
.btn-sm { padding: 6px 11px; font-size: 12px; }
.btn-icon { padding: 8px; aspect-ratio:1; justify-content:center; }

/* â”€â”€ FIXTURE GRID â”€â”€ */
.fixture-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
  gap: 14px;
}
.fixture-card {
  contain: layout style;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color 0.2s, transform 0.15s, box-shadow 0.15s;
  cursor: pointer;
}
.fixture-card:hover { border-color: var(--border2); transform: translateY(-2px); box-shadow: var(--shadow); }
.fixture-card.out { border-left: 3px solid rgba(248,113,113,0.4); }
.fixture-card.available { border-left: 3px solid rgba(74,222,128,0.25); }
.card-top {
  padding: 13px 14px 10px;
  display: flex; justify-content: space-between; align-items: flex-start;
}
.fid { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--accent); background: var(--accent-dim); padding: 2px 7px; border-radius: 4px; }
.sbadge {
  font-size: 9px; font-weight: 700; padding: 3px 8px;
  border-radius: 10px; text-transform: uppercase; letter-spacing: 0.5px;
}
.sbadge.available { background: var(--green-dim); color: var(--green); }
.sbadge.out { background: var(--red-dim); color: var(--red); }
.card-body { padding: 0 14px 12px; }
.card-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
.card-meta { font-size: 13px; color: var(--text2); display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }
.card-loc {
  font-size: 11px; font-family: 'DM Mono', monospace;
  display: inline-flex; align-items: center; gap: 4px;
  background: transparent;
  border: 1px solid var(--border2);
  border-radius: 5px;
  padding: 2px 7px;
  color: var(--text2);
  margin-top: 5px;
}
.card-co-info {
  background: var(--red-dim); border-radius: 6px;
  padding: 7px 10px; font-size: 11px; color: var(--text2); margin-top: 8px;
}
.card-co-info strong { color: var(--red); }
.card-footer {
  padding: 9px 14px;
  display: flex; gap: 7px;
}
.card-footer .btn { flex: 1; justify-content: center; font-size: 11px; padding: 7px 8px; }

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.75);
  display: none; align-items: center; justify-content: center;
  z-index: 1000; padding: 20px;
  backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 18px;
  width: 100%; max-width: 500px;
  max-height: 92vh; overflow-y: auto;
  animation: modalIn 0.2s ease;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
}
@keyframes modalIn { from { opacity:0; transform:scale(0.94) translateY(12px); } to { opacity:1; transform:none; } }
.modal-header {
  padding: 18px 22px 14px;
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; background: var(--surface); border-radius: 18px 18px 0 0;
}
.modal-title { font-size: 16px; font-weight: 600; }
.modal-close { background: none; border: none; color: var(--text3); font-size: 22px; cursor: pointer; line-height: 1; padding: 2px 6px; border-radius: 6px; }
.modal-close:hover { color: var(--text); background: var(--surface3); }
.modal-body { padding: 18px 22px; }
.modal-footer { padding: 14px 22px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }

/* â”€â”€ FORM â”€â”€ */
.form-group { margin-bottom: 14px; }
.form-label { display: block; font-size: 11px; font-weight: 500; color: var(--text2); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'DM Mono', monospace; }
.form-input {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 12px;
  color: var(--text); font-size: 14px; font-family: 'DM Sans', sans-serif;
  outline: none; transition: border-color 0.2s;
}
.form-input:focus { border-color: var(--accent); }
input[type="date"].form-input { color-scheme: dark; }
input[type="date"].form-input::-webkit-calendar-picker-indicator { filter: invert(1) opacity(0.6); cursor: pointer; }
.form-input::placeholder { color: var(--text3); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* â”€â”€ QR â”€â”€ */
.qr-print-block { background: white; border-radius: 10px; padding: 18px; display: inline-flex; flex-direction: column; align-items: center; gap: 8px; }
.qr-print-id { font-family: 'DM Mono', monospace; font-size: 16px; font-weight: 700; color: #111; letter-spacing: 2px; }
.qr-print-name { font-size: 12px; color: #444; text-align: center; max-width: 160px; }

/* â”€â”€ SCANNER â”€â”€ */
#qr-reader { width: 100% !important; }

/* â”€â”€ TABLE â”€â”€ */
.table-wrap { overflow-x: auto; border-radius: var(--radius-sm); border: 1px solid var(--border); }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead { background: var(--surface2); }
th { text-align: left; padding: 10px 14px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); font-family: 'DM Mono', monospace; white-space: nowrap; position: relative; }
th.resizable { resize: horizontal; overflow: hidden; min-width: 60px; }
td { padding: 11px 14px; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text2); }
tr:last-child td { border-bottom: none; }
tr:hover td { background: var(--surface2); }
.mono { font-family: 'DM Mono', monospace; color: var(--accent); font-size: 11px; }

/* â”€â”€ ADMIN PANEL â”€â”€ */
.admin-section {
  margin-bottom: 16px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 20px 22px;
}
.admin-section-title {
  font-size: 14px; font-weight: 600; margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px; color: var(--blue);
}

/* USER MANAGEMENT TABLE */
.user-row {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
}
.ur-avatar { font-size: 22px; }
.ur-info { flex: 1; }
.ur-name { font-size: 14px; font-weight: 500; }
.ur-pin { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text3); }
.ur-actions { display: flex; gap: 6px; }

/* â”€â”€ PRINT â”€â”€ */
.print-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px; }
.print-card { background: white; border-radius: 10px; padding: 14px; text-align: center; position: relative; display:flex; flex-direction:column; align-items:center; }
.print-card .pqr-wrap { display:flex; justify-content:center; align-items:center; width:60px; height:60px; margin:0 auto; }
.print-card .pqr-wrap canvas, .print-card .pqr-wrap img { width:60px !important; height:60px !important; display:block; }
.print-card .pname { font-size: 11px; font-weight: 700; color: #111; margin-top: 6px; font-family: 'DM Sans', sans-serif; }
.print-card .pid { font-family: 'DM Mono', monospace; font-size: 10px; color: #555; }
.print-card .pbrand { font-size: 9px; color: #888; }
.print-card-btn { margin-top: 8px; width: 100%; padding: 5px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; font-size: 11px; cursor: pointer; }
.print-card-btn:hover { background: #e0e0e0; }
@media print {
  .no-print { display: none !important; }
  .print-card { page-break-inside: avoid; }
  .print-card .pqr-wrap canvas, .print-card .pqr-wrap img { width:60px !important; height:60px !important; }
}

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state { text-align: center; padding: 50px 20px; color: var(--text3); }
.empty-state .icon { font-size: 40px; margin-bottom: 12px; }
.empty-state p { font-size: 14px; }

/* â”€â”€ SETUP PAGE â”€â”€ */
.setup-card {
  display: flex;
  gap: 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 14px;
  align-items: flex-start;
  transition: border-color 0.2s;
}
.setup-card:hover { border-color: var(--border2); }
.setup-card-num {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--accent); color: #000;
  font-weight: 700; font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-top: 2px;
}
.setup-card-body { flex: 1; min-width: 0; }
.setup-card-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
.setup-card-desc  { font-size: 13px; color: var(--text2); line-height: 1.7; }

/* â”€â”€ SYNC STATUS â”€â”€ */
.sync-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
/* Login sync indicator only on mobile */
@media (min-width: 581px) { body:not(.app-visible) #login-sync-bar { display: none !important; } }
.sync-dot.pulse { animation: syncPulse 1s infinite; }
@keyframes syncPulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* â”€â”€ SETUP MODAL â”€â”€ */
.setup-step { display:flex; gap:12px; margin-bottom:20px; }
.setup-num  { width:28px; height:28px; border-radius:50%; background:var(--accent); color:#000; font-weight:700; font-size:13px; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:2px; }
.setup-content { flex:1; }
.setup-title { font-size:14px; font-weight:600; margin-bottom:4px; }
.setup-desc  { font-size:12px; color:var(--text2); line-height:1.6; }
.code-block  { background:var(--surface3); border:1px solid var(--border2); border-radius:6px; padding:10px 12px; font-family:'DM Mono',monospace; font-size:11px; color:var(--accent); margin-top:8px; word-break:break-all; }


.setup-step { display:flex; gap:12px; margin-bottom:20px; }
.setup-num  { width:28px; height:28px; border-radius:50%; background:var(--accent); color:#000; font-weight:700; font-size:13px; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:2px; }
.setup-content { flex:1; }
.setup-title { font-size:14px; font-weight:600; margin-bottom:4px; }
.setup-desc  { font-size:12px; color:var(--text2); line-height:1.6; }
.code-block  { background:var(--surface3); border:1px solid var(--border2); border-radius:6px; padding:10px 12px; font-family:'DM Mono',monospace; font-size:11px; color:var(--accent); margin-top:8px; word-break:break-all; cursor:pointer; }
.code-block:hover { border-color:var(--accent); }

/* â”€â”€ NOTIFICATION â”€â”€ */
.notif {
  position: fixed;
  bottom: calc(var(--tab-bar-h, 0px) + env(safe-area-inset-bottom, 0px) + 16px);
  left: 50%; transform: translateX(-50%);
  border-radius: 14px; padding: 13px 20px;
  font-size: 14px; font-weight: 600;
  max-width: calc(100vw - 32px); width: max-content;
  z-index: 9999; display: none;
  animation: slideUp 0.2s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow: 0 8px 32px rgba(0,0,0,0.45);
  text-align: center; letter-spacing: 0.01em;
  white-space: nowrap;
}
.notif.show { display: block; }
.notif.success { background: var(--green); color: #000; border: none; }
.notif.error { background: var(--red); color: #fff; border: none; }
.notif.info { background: var(--blue); color: #fff; border: none; }
@keyframes slideUp { from { opacity:0; transform:translateX(-50%) translateY(14px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }
.active-usage-tab { opacity: 1 !important; border-color: var(--accent) !important; color: var(--accent) !important; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE LAYOUT SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ DESKTOP â”€â”€ */
@media (min-width: 1024px) {
  main { padding: 32px 40px; max-width: 1400px; }
  .fixture-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
  .home-hero { grid-template-columns: repeat(4, 1fr); }
  .stats-bar { grid-template-columns: repeat(4, 1fr); }
  .checked-out-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  header { height: 64px; padding: 0 40px; }
  .nav-tabs { padding: 0 40px; }
  .login-logo { font-size: 64px; }
  .user-cards { max-width: 680px; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
}

/* â”€â”€ TABLET â”€â”€ */
@media (min-width: 581px) and (max-width: 1023px) {
  main { padding: 20px 24px; }
  .fixture-grid { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
  .home-hero { grid-template-columns: repeat(2, 1fr); }
}

/* â”€â”€ MOBILE â€” applied by media query (small screen) â”€â”€ */
@media (max-width: 580px) {
  /* main content sits above tab bar */
  main {
    padding: 16px 14px 0;
    padding-bottom: calc(var(--tab-bar-h, 58px) + env(safe-area-inset-bottom, 0px) + 8px);
  }
  header { padding: 0 14px; height: 52px; padding-top: env(safe-area-inset-top, 0px); }
  .logo { font-size: 20px; }
  .logo-sub { display: none; }
  .nav-tabs { display: none !important; }
  /* Tap targets */
  .btn { padding: 11px 16px; font-size: 15px; min-height: 46px; }
  .btn-sm { padding: 8px 12px; font-size: 13px; min-height: 38px; }
  .btn-scan { padding: 8px 12px; font-size: 13px; }
  /* Forms â€” 16px prevents iOS zoom on focus */
  .form-input { font-size: 16px !important; padding: 12px 14px; min-height: 48px; }
  input[type="date"].form-input { height: 48px; min-height: 48px; padding: 0 14px; box-sizing: border-box; -webkit-appearance: none; appearance: none; line-height: 48px; }
  .form-label { font-size: 13px; letter-spacing: 0.5px; }
  .filter-select { font-size: 15px; padding: 10px 12px; min-height: 44px; }
  .search-box input { font-size: 15px; }
  /* Home */
  .home-hero { grid-template-columns: 1fr 1fr; gap: 10px; }
  .hero-stat { padding: 14px 16px; }
  .hero-stat-val { font-size: 36px; }
  .hero-stat-label { font-size: 11px; }
  .stats-bar { grid-template-columns: 1fr 1fr; gap: 10px; }
  .stat-value { font-size: 30px; }
  .stat-label { font-size: 11px; }
  /* Library cards */
  .fixture-grid { grid-template-columns: 1fr; gap: 12px; }
  .card-name { font-size: 17px; }
  .card-meta { font-size: 14px; }
  .card-loc { font-size: 13px; }
  .sbadge { font-size: 11px; padding: 4px 10px; }
  .fid { font-size: 12px; }
  .card-co-info { font-size: 13px; }
  .card-footer { flex-wrap: wrap; gap: 8px; }
  .card-footer .btn { flex: 1; min-width: 80px; justify-content: center; }
  /* Home checked-out list */
  .co-user, .co-time { display: none; }
  .co-row { gap: 8px; grid-template-columns: auto 1fr; }
  .co-name { font-size: 15px; }
  .co-meta { font-size: 13px; }
  /* Forms layout */
  .form-row { grid-template-columns: 1fr; }
  .toolbar { flex-wrap: wrap; gap: 8px; }
  .search-box { flex: 1 1 100%; }
  .filter-select { flex: 1; }
  /* Modals â€” bottom-sheet */
  .modal-overlay { align-items: flex-end; padding: 0; }
  .modal { border-radius: 22px 22px 0 0; max-height: 92vh; width: 100%; margin: 0; }
  .modal-body { padding: 18px; font-size: 15px; }
  .modal-footer { padding: 14px 18px; flex-wrap: wrap; gap: 8px; }
  .modal-footer .btn { flex: 1; justify-content: center; }
  .modal-title { font-size: 18px; }
  /* Admin */
  .admin-section { padding: 16px; }
  .admin-section-title { font-size: 16px; }
  .user-row { flex-wrap: wrap; }
  .ur-name { font-size: 15px; }
  .ur-actions { flex: 1 1 100%; display: flex; gap: 8px; margin-top: 6px; }
  .ur-actions .btn { flex: 1; justify-content: center; }
  .print-grid { grid-template-columns: repeat(2,1fr); gap: 10px; }
  .setup-card { flex-direction: column; gap: 10px; }
  .setup-card-title { font-size: 16px; }
  .setup-card-desc { font-size: 14px; }
  /* Login */
  .login-logo { font-size: 42px; }
  .user-cards { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
  .ulc-name { font-size: 15px; }
  .ulc-avatar { font-size: 34px; }
  .login-co-board { max-width: 100% !important; }
  /* History */
  .table-wrap { font-size: 14px; overflow-x: auto; }
  table th, table td { padding: 10px; font-size: 14px; }
  .section-heading { font-size: 13px; }
  /* PIN pad â€” compact so it fits without scrolling */
  #login-screen { padding: 20px 18px; padding-top: max(20px, env(safe-area-inset-top, 0px)); }
  .pin-screen { max-width: 300px; }
  .pin-pad { gap: 6px; margin-bottom: 12px; }
  .pin-key { height: 46px; font-size: 20px; border-radius: 10px; min-height: unset; }
  .pin-name { font-size: 18px; }
  .pin-hint { font-size: 13px; }
  .pin-dot { width: 12px; height: 12px; }
  .pin-dots { gap: 12px; margin-bottom: 18px; }
  .pin-header { margin-bottom: 16px; }
  /* Comments â€” let inline max-height work, just ensure minimum size */
  #ef-comment-list { min-height: 120px; }
  /* Sync bar sits above tab bar */
}

/* â”€â”€ MOBILE (JS-detected: PWA/standalone/tablet-phone) â”€â”€ */
body.is-mobile main {
  padding: 16px 14px 0;
  padding-bottom: calc(var(--tab-bar-h, 58px) + env(safe-area-inset-bottom, 0px) + 8px);
}
body.is-mobile header { padding: 0 14px; height: 52px; padding-top: env(safe-area-inset-top, 0px); }
body.is-mobile .logo { font-size: 20px; }
body.is-mobile .logo-sub { display: none; }
body.is-mobile .nav-tabs { display: none !important; }
body.is-mobile .btn { padding: 11px 16px; font-size: 15px; min-height: 46px; }
body.is-mobile .btn-sm { padding: 8px 12px; font-size: 13px; min-height: 38px; }
body.is-mobile .form-input { font-size: 16px !important; padding: 12px 14px; min-height: 48px; }
body.is-mobile input[type="date"].form-input { height: 48px; min-height: 48px; padding: 0 14px; box-sizing: border-box; -webkit-appearance: none; appearance: none; line-height: 48px; }
body.is-mobile .form-label { font-size: 13px; }
body.is-mobile .filter-select { font-size: 15px; padding: 10px 12px; min-height: 44px; }
body.is-mobile .search-box input { font-size: 15px; }
body.is-mobile .home-hero { grid-template-columns: 1fr 1fr; gap: 10px; }
body.is-mobile .hero-stat-val { font-size: 36px; }
body.is-mobile .stats-bar { grid-template-columns: 1fr 1fr; gap: 10px; }
body.is-mobile .fixture-grid { grid-template-columns: 1fr; gap: 12px; }
body.is-mobile .card-name { font-size: 17px; }
body.is-mobile .card-meta { font-size: 14px; }
body.is-mobile .card-footer { flex-wrap: wrap; gap: 8px; }
body.is-mobile .form-row { grid-template-columns: 1fr; }
body.is-mobile .toolbar { flex-wrap: wrap; gap: 8px; }
body.is-mobile .search-box { flex: 1 1 100%; }
body.is-mobile .modal-overlay { align-items: flex-end; padding: 0; }
body.is-mobile .modal { border-radius: 22px 22px 0 0; max-height: 92vh; width: 100%; margin: 0; }
body.is-mobile .modal-body { padding: 18px; font-size: 15px; }
body.is-mobile .modal-footer { padding: 14px 18px; flex-wrap: wrap; gap: 8px; }
body.is-mobile .modal-footer .btn { flex: 1; justify-content: center; }
body.is-mobile .modal-title { font-size: 18px; }
body.is-mobile .admin-section { padding: 16px; }
body.is-mobile .user-row { flex-wrap: wrap; }
body.is-mobile .ur-actions { flex: 1 1 100%; display: flex; gap: 8px; margin-top: 6px; }
body.is-mobile .ur-actions .btn { flex: 1; justify-content: center; }
body.is-mobile .setup-card { flex-direction: column; gap: 10px; }
body.is-mobile .login-logo { font-size: 42px; }
body.is-mobile .user-cards { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
body.is-mobile .ulc-name { font-size: 15px; }
body.is-mobile .login-co-board { max-width: 100% !important; }
body.is-mobile .table-wrap { font-size: 14px; overflow-x: auto; }
body.is-mobile .section-heading { font-size: 13px; }
body.is-mobile #login-screen { padding: 20px 18px; padding-top: max(20px, env(safe-area-inset-top, 0px)); }
body.is-mobile .pin-screen { max-width: 300px; }
body.is-mobile .pin-pad { gap: 6px; margin-bottom: 12px; }
body.is-mobile .pin-key { height: 46px; font-size: 20px; border-radius: 10px; min-height: unset; }
body.is-mobile .pin-name { font-size: 18px; }
body.is-mobile .pin-dots { gap: 12px; margin-bottom: 18px; }
body.is-mobile .pin-header { margin-bottom: 16px; }

/* â”€â”€ BOTTOM TAB BAR â”€â”€ */
:root { --tab-bar-h: 58px; }   /* default = tab bar height; JS updates it precisely */

#bottom-tabs {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 500;   /* above sync bar */
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding-bottom: env(safe-area-inset-bottom, 0px);
  overflow-x: auto;
  scrollbar-width: none;
  -webkit-overflow-scrolling: touch;
  width: 100%;
}
#bottom-tabs::-webkit-scrollbar { display: none; }

/* Show on small screens AND JS-detected mobile/PWA */
@media (max-width: 580px) { body.app-visible #bottom-tabs { display: flex; } }
body.is-mobile.app-visible #bottom-tabs { display: flex; }

.btab {
  flex: 1;
  min-width: 0;
  max-width: 110px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  padding: 10px 4px 10px;
  cursor: pointer;
  color: var(--text3);
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  border: none;
  background: none;
  -webkit-tap-highlight-color: transparent;
  transition: color 0.15s;
  white-space: nowrap;
  font-family: 'DM Sans', sans-serif;
  min-height: 58px;
  position: relative;
}
.btab .btab-icon { font-size: 22px; line-height: 1.2; }
.btab.active { color: var(--accent); }
.btab.active .btab-icon { transform: translateY(-1px); }
.btab.admin-btab { color: rgba(96,165,250,0.35); }
.btab.admin-btab.active { color: var(--blue); }
.btab::after {
  content: '';
  position: absolute;
  top: 0; left: 20%; right: 20%;
  height: 2px;
  border-radius: 0 0 3px 3px;
  background: transparent;
  transition: background 0.15s;
}
.btab.active::after { background: var(--accent); }
.btab.admin-btab.active::after { background: var(--blue); }

@media print {
  body { background: white !important; }
  #login-screen, header, .nav-tabs, .toolbar, .stats-bar, .home-hero,
  .card-footer, .btn, .notif, .modal-overlay,
  #bottom-tabs, #sync-bar, #login-sync-bar { display: none !important; }
  .print-grid { display: grid !important; }
  .fixture-grid { display: none; }
  #page-print { display: block !important; }
  /* Prevent blank overflow pages */
  html, body { height: auto !important; overflow: visible !important; }
  main { padding-bottom: 0 !important; }
  .print-grid { page-break-after: avoid; }
}

/* â”€â”€ CONFIRM DIALOG â”€â”€ */
.confirm-box {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 20px;
  margin-top: 16px;
}
.confirm-box p { font-size: 14px; color: var(--text2); margin-bottom: 14px; }

/* Section divider */
.divider { height: 1px; background: var(--border); margin: 16px 0; }
#page-admin .divider { display: none; }

/* â”€â”€ LOCATION COMBO â”€â”€ */
.loc-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 200;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: var(--radius-sm); max-height: 200px; overflow-y: auto;
  box-shadow: var(--shadow); margin-top: 4px;
}
.loc-option {
  padding: 9px 14px; font-size: 13px; cursor: pointer;
  color: var(--text2); transition: background 0.1s;
  border-bottom: 1px solid var(--border);
}
.loc-option:last-child { border-bottom: none; }
.loc-option:hover { background: var(--surface3); color: var(--text); }
.loc-option.add-new { color: var(--accent); font-style: italic; }
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BULK CHECKOUT / SELECT MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fixture-card.selected { border-color: var(--accent) !important; box-shadow: 0 0 0 2px rgba(245,200,66,0.3); }
.fixture-card .select-check {
  display: none;
  width: 22px; height: 22px; border: 2px solid var(--border2);
  border-radius: 6px; background: var(--surface2); flex-shrink: 0;
  align-items: center; justify-content: center; font-size: 13px;
  cursor: pointer; transition: all 0.15s;
}
.select-mode .fixture-card .select-check { display: flex; }
.select-mode .fixture-card.selected .select-check { background: var(--accent); border-color: var(--accent); color: #000; }
.bulk-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 600;
  background: var(--surface); border-top: 1px solid var(--border2);
  padding: 12px 20px; display: none; align-items: center; gap: 12px;
  flex-wrap: wrap;
}
body.is-mobile.app-visible .bulk-bar { padding-bottom: calc(64px + env(safe-area-inset-bottom, 0px)); }
.bulk-bar.visible { display: flex; }
.bulk-bar-count { font-size: 13px; font-weight: 600; color: var(--text); flex: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL SEARCH OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#global-search-overlay {
  display: none; position: fixed; inset: 0; z-index: 2000;
  background: rgba(0,0,0,0.85); backdrop-filter: blur(6px);
  padding: 20px;
  align-items: flex-start; justify-content: center;
  padding-top: 80px;
}
#global-search-overlay.open { display: flex; }
.gs-box {
  width: 100%; max-width: 620px;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: var(--radius); overflow: hidden;
  box-shadow: var(--shadow);
}
.gs-input-row {
  display: flex; align-items: center; gap: 10px;
  padding: 14px 16px; border-bottom: 1px solid var(--border);
}
.gs-input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-size: 16px; font-family: 'DM Sans', sans-serif;
}
.gs-input::placeholder { color: var(--text3); }
.gs-results { max-height: 60vh; overflow-y: auto; }
.gs-result {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  cursor: pointer; transition: background 0.1s;
}
.gs-result:hover { background: var(--surface3); }
.gs-result-id { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--accent); background: var(--accent-dim); padding: 2px 7px; border-radius: 4px; white-space: nowrap; }
.gs-result-name { font-size: 14px; font-weight: 600; flex: 1; }
.gs-result-meta { font-size: 11px; color: var(--text3); }
.gs-empty { padding: 40px; text-align: center; color: var(--text3); font-size: 14px; }
.gs-section-label { padding: 8px 16px 4px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); font-family: 'DM Mono', monospace; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVED FILTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.saved-filters-bar {
  display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;
  align-items: center;
}
.saved-filter-chip {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 20px; padding: 4px 10px 4px 12px;
  font-size: 11px; color: var(--text2); cursor: pointer;
  transition: all 0.15s; white-space: nowrap;
}
.saved-filter-chip:hover { border-color: var(--accent); color: var(--accent); }
.saved-filter-chip.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
.saved-filter-chip .sfc-del { color: var(--text3); font-size: 13px; line-height: 1; margin-left: 2px; }
.saved-filter-chip .sfc-del:hover { color: var(--red); }
.save-filter-btn {
  background: none; border: 1px dashed var(--border2);
  border-radius: 20px; padding: 4px 10px;
  font-size: 11px; color: var(--text3); cursor: pointer; white-space: nowrap;
}
.save-filter-btn:hover { border-color: var(--accent); color: var(--accent); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SORT BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sort-select {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 12px;
  color: var(--text2); font-size: 13px;
  font-family: 'DM Sans', sans-serif; outline: none; cursor: pointer;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHECKOUT NOTE MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#checkout-note-modal .modal { max-width: 420px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USAGE STATS (admin)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.usage-stat-row {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 0; border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.usage-stat-row:last-child { border-bottom: none; }
.usage-bar-wrap { flex: 1; background: var(--surface3); border-radius: 4px; height: 6px; overflow: hidden; }
.usage-bar { height: 6px; border-radius: 4px; background: var(--accent); }
.usage-count { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text3); white-space: nowrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTAINERS (cases/boxes)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.container-card {
  background: var(--surface); border: 1px solid var(--border);
  border-left: 3px solid var(--blue); border-radius: var(--radius);
  padding: 16px; margin-bottom: 12px; cursor: pointer;
  transition: border-color 0.2s, box-shadow 0.15s;
}
.container-card:hover { border-color: var(--border2); box-shadow: var(--shadow); }
.container-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.container-meta { font-size: 12px; color: var(--text3); font-family: 'DM Mono', monospace; }
.container-fixtures { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
.container-fixture-pill {
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 6px; padding: 3px 8px; font-size: 11px;
  font-family: 'DM Mono', monospace; color: var(--text2);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BATCH PRINT SELECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.print-card.print-selected { outline: 2px solid var(--accent); border-radius: 6px; }
/* case print cards on containers page */
.case-print-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 12px 14px;
  display: flex; align-items: center; gap: 12px;
  cursor: pointer; transition: background 0.1s, border-color 0.15s;
  margin-bottom: 8px;
}
.case-print-card:hover { border-color: var(--border2); }
.case-print-card.cpc-selected { border-color: var(--accent); background: rgba(245,200,66,0.05); }
.cpc-check {
  width: 20px; height: 20px; border: 2px solid var(--border2);
  border-radius: 5px; display: flex; align-items: center; justify-content: center;
  font-size: 12px; flex-shrink: 0; transition: all 0.15s;
}
.case-print-card.cpc-selected .cpc-check { background: var(--accent); border-color: var(--accent); color: #000; }
.print-card .pcheck {
  display: none; position: absolute; top: 4px; right: 4px;
  width: 18px; height: 18px; border: 2px solid var(--border2);
  border-radius: 4px; background: #fff; align-items: center; justify-content: center;
  font-size: 11px; cursor: pointer; color: #000;
}
.print-select-mode .print-card { position: relative; cursor: pointer; }
.print-select-mode .print-card .pcheck { display: flex; }
.print-select-mode .print-card.print-selected .pcheck { background: var(--accent); border-color: var(--accent); }



</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div id="login-halo"></div>
  <!-- Firebase connection status â€” top-left dot on login screen -->
  <div id="login-sync-bar" style="position:fixed;top:12px;left:14px;z-index:200;display:flex;align-items:center;gap:6px;font-size:11px;font-family:'DM Mono',monospace;visibility:hidden;">
    <span id="login-sync-dot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--red);flex-shrink:0;"></span>
    <span id="login-sync-msg" style="color:var(--text3);">Not connected</span>
  </div>
  <div class="login-logo" onclick="adminQuickLogin()" style="cursor:pointer;user-select:none;" title="Admin access">LumaSamples</div>
  <div class="login-sub">Lighting Fixture Library</div>
  <button onclick="loginPageQuickScan()" style="position:absolute;top:16px;right:16px;background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:8px 14px;color:var(--text2);font-size:13px;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:'DM Sans',sans-serif;" id="login-scan-btn">
    <span style="font-size:16px;line-height:1;display:flex;align-items:center;">ğŸ“·</span> Scan QR
  </button>

  <!-- Checked out board -->
  <div id="login-co-board" style="width:100%;max-width:560px;margin-bottom:28px;display:none;">
    <div style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:8px;">
      <span>Currently Checked Out</span>
      <span style="flex:1;height:1px;background:var(--border);display:inline-block;"></span>
      <span id="login-co-count" style="background:var(--red-dim);color:var(--red);padding:1px 7px;border-radius:8px;font-size:9px;"></span>
    </div>
    <div id="login-co-list"></div>
  </div>

  <!-- User selection -->
  <div id="login-user-grid" class="user-cards"></div>
  <div id="pin-entry" style="display:none;" class="pin-screen">
    <div class="pin-header">
      <div class="pin-avatar" id="pin-avatar"></div>
      <div class="pin-name" id="pin-name"></div>
      <div class="pin-hint">Enter your PIN</div>
    </div>
    <div class="pin-dots" id="pin-dots">
      <div class="pin-dot" id="d0"></div>
      <div class="pin-dot" id="d1"></div>
      <div class="pin-dot" id="d2"></div>
      <div class="pin-dot" id="d3"></div>
    </div>
    <div class="pin-pad">
      <button class="pin-key" onclick="pinPress('1')">1</button>
      <button class="pin-key" onclick="pinPress('2')">2</button>
      <button class="pin-key" onclick="pinPress('3')">3</button>
      <button class="pin-key" onclick="pinPress('4')">4</button>
      <button class="pin-key" onclick="pinPress('5')">5</button>
      <button class="pin-key" onclick="pinPress('6')">6</button>
      <button class="pin-key" onclick="pinPress('7')">7</button>
      <button class="pin-key" onclick="pinPress('8')">8</button>
      <button class="pin-key" onclick="pinPress('9')">9</button>
      <button class="pin-key" onclick="pinPress('')" style="visibility:hidden;"></button>
      <button class="pin-key" onclick="pinPress('0')">0</button>
      <button class="pin-key del" onclick="pinBackspace()">âŒ«</button>
    </div>
    <button class="pin-back-btn" onclick="showUserSelect()">â† Back</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" style="display:none;">
  <header>
    <div style="display:flex;align-items:center;gap:8px;min-width:0;flex:1;">
      <div class="logo" onclick="showPage('home', document.querySelector('[data-page=home]'))" style="cursor:pointer;flex-shrink:0;">LumaSamples</div>
      <div id="header-sync-dot" style="width:9px;height:9px;border-radius:50%;background:var(--red);flex-shrink:0;margin-left:2px;" title="Not connected"></div>
    </div>
    <div class="header-right">
      <!-- sync via auto-listener only -->
      <!-- User chip â€” avatar + name only, no role badge -->
      <div class="user-chip" id="user-chip" onclick="logOut()">
        <span class="chip-avatar" id="chip-avatar"></span>
        <span id="chip-name"></span>
        <span class="role-badge" id="chip-role" style="display:none;"></span>
      </div>
      <button class="btn btn-secondary no-print" onclick="openGlobalSearch()" title="Global Search" style="font-size:16px;padding:6px 10px;min-width:36px;">ğŸ”</button>
      <button class="btn btn-scan" onclick="openScanModal()">ğŸ“·</button>
    </div>
  </header>

  <div class="nav-tabs" id="nav-tabs">
    <div class="nav-tab active" data-page="home" onclick="showPage('home',this)"><span class="tab-icon">ğŸ </span> Home</div>
    <div class="nav-tab" data-page="library" onclick="showPage('library',this)"><span class="tab-icon">ğŸ’¡</span> Library</div>
    <div class="nav-tab" id="tab-containers" data-page="containers" onclick="showPage('containers',this)"><span class="tab-icon">ğŸ“¦</span> Cases</div>
    <div class="nav-tab" data-page="history" onclick="showPage('history',this)"><span class="tab-icon">ğŸ“‹</span> History</div>
    <div class="nav-tab admin-tab" id="tab-add" data-page="add" onclick="showPage('add',this)" style="display:none;"><span class="tab-icon">â•</span> Add Fixture</div>
    <div class="nav-tab admin-tab" id="tab-print" data-page="print" onclick="showPage('print',this)" style="display:none;"><span class="tab-icon">ğŸ–¨</span> Print QR</div>
    <div class="nav-tab admin-tab" id="tab-admin" data-page="admin" onclick="showPage('admin',this)" style="display:none;"><span class="tab-icon">âš™ï¸</span> Settings</div>
    <!-- settings tab merged into admin tab -->
  </div>

  <main>
    <!-- HOME PAGE -->
    <div class="page active" id="page-home">
      <div class="home-hero" id="home-hero"></div>
      <div id="my-checkouts-strip"></div>
      <div class="section-heading">Currently Checked Out</div>
      <div class="checked-out-list" id="checked-out-list"></div>
      <div class="section-heading">Recently Returned</div>
      <div id="recent-returns"></div>
    </div>

    <!-- LIBRARY PAGE -->
    <div class="page" id="page-library">
      <div class="stats-bar" id="stats-bar"></div>
      <div class="saved-filters-bar" id="saved-filters-bar">
        <button class="save-filter-btn" onclick="saveCurrentFilter()" title="Save current filter">ï¼‹ Save Filter</button>
      </div>
      <div class="toolbar">
        <div class="search-box">
          <span style="color:var(--text3);">ğŸ”</span>
          <input type="text" id="search-input" placeholder="Search fixtures..." oninput="debounce('lib',renderLibrary,150)()">
        </div>
        <select class="filter-select" id="filter-status" onchange="renderLibrary()">
          <option value="">All Status</option>
          <option value="available">Available</option>
          <option value="out">Checked Out</option>
        </select>
        <select class="filter-select" id="filter-category" onchange="renderLibrary()">
          <option value="">All Types</option>
        </select>
        <select class="sort-select" id="sort-select" onchange="renderLibrary()">
          <option value="name">Sort: Name</option>
          <option value="id">Sort: ID</option>
          <option value="location">Sort: Location</option>
          <option value="status">Sort: Status</option>
          <option value="recent">Sort: Recent</option>
        </select>
        <button class="btn btn-secondary btn-sm no-print" id="bulk-toggle-btn" onclick="toggleBulkMode()" title="Select multiple">â˜‘ Select</button>
      </div>
      <div class="fixture-grid" id="fixture-grid"></div>
    </div>

    <!-- HISTORY PAGE -->
    <div class="page" id="page-history">
      <div class="toolbar" style="margin-bottom:18px;">
        <h2 style="font-size:20px;font-weight:700;flex:1;color:#ffffff;">Transaction History</h2>
        <select class="filter-select" id="hist-user-filter" onchange="renderHistory()">
          <option value="">All Users</option>
        </select>
        <select class="filter-select" id="hist-type-filter" onchange="renderHistory()">
          <option value="">All Actions</option>
          <option value="checkout">Checkouts</option>
          <option value="return">Returns</option>
          <option value="added">Added</option>
          <option value="deleted">Deleted</option>
          <option value="transfer">Transferred</option>
        </select>
      </div>
      <div class="table-wrap" style="flex:1;overflow-y:auto;">
        <table>
          <thead><tr><th class="resizable" style="width:140px;">Date / Time</th><th class="resizable" style="width:90px;">Fixture ID</th><th class="resizable">Name</th><th class="resizable" style="width:100px;">User</th><th class="resizable" style="width:90px;">Action</th></tr></thead>
          <tbody id="history-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ADD FIXTURE PAGE -->
    <div class="page" id="page-add">
      <div style="max-width:580px;margin:0 auto;">
        <h2 style="font-size:20px;font-weight:700;margin-bottom:6px;color:#ffffff;">Add New Fixture</h2>
        <p style="color:var(--text2);font-size:13px;margin-bottom:22px;">A unique QR code is auto-generated with each entry.</p>
        <div class="form-group">
          <label class="form-label">Auto-Generated ID</label>
          <input class="form-input" id="new-fixture-id" readonly style="font-family:'DM Mono',monospace;color:var(--accent);background:var(--accent-dim);">
        </div>
        <div class="form-group">
          <label class="form-label">Fixture Name *</label>
          <input class="form-input" id="new-name" placeholder="e.g. Arco Pendant LED">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Manufacturer</label>
            <input class="form-input" id="new-brand" placeholder="e.g. Flos">
          </div>
          <div class="form-group">
            <label class="form-label">Part Number</label>
            <input class="form-input" id="new-partno" placeholder="e.g. FLS-1234-B">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Date Received</label>
            <input class="form-input" id="new-datereceived" type="date">
          </div>
          <div class="form-group">
            <label class="form-label">Wattage</label>
            <input class="form-input" id="new-wattage" placeholder="e.g. 18W">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Fixture Type</label>
            <div style="position:relative;">
              <select class="form-input" id="new-fixtype" onchange="onFixTypeChange('new-fixtype','new-output-wattage-row')" style="padding-right:32px;-webkit-appearance:none;appearance:none;background:var(--surface2);cursor:pointer;">
                <option value="">â€” Select type â€”</option>
              </select>
              <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none;font-size:12px;">â–¾</span>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Input Voltage</label>
            <input class="form-input" id="new-voltage" placeholder="e.g. 120V / 277V">
          </div>
        </div>
        <div class="form-row" id="new-output-wattage-row" style="display:none;">
          <div class="form-group">
            <label class="form-label">Output Wattage</label>
            <input class="form-input" id="new-output-wattage" placeholder="e.g. 60W">
          </div>
          <div class="form-group"></div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Shelf / Location</label>
            <div style="position:relative;">
              <input class="form-input" id="new-location" placeholder="Type or select location..." autocomplete="off" oninput="filterLocDropdown('new-location','loc-drop-add')" onfocus="showLocDropdown('new-location','loc-drop-add')" onblur="setTimeout(()=>hideLocDropdown('loc-drop-add'),180)" style="padding-right:32px;">
              <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none;font-size:12px;">â–¾</span>
              <div id="loc-drop-add" class="loc-dropdown" style="display:none;"></div>
            </div>
          </div>
          <div class="form-group"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Spec Sheet URL</label>
          <input class="form-input" id="new-specsheet" placeholder="https://â€¦ (link to PDF or product page)" type="url">
        </div>
        <button class="btn btn-primary" onclick="addFixture()" style="width:100%;justify-content:center;padding:13px;">
          âœ¦ Add Fixture &amp; Generate QR
        </button>
        <div id="new-qr-section" style="display:none;margin-top:22px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="font-size:14px;font-weight:600;">âœ“ QR Code Ready</h3>
            <button class="btn btn-secondary btn-sm" onclick="window.print()">ğŸ–¨ Print Label</button>
          </div>
          <div style="display:flex;justify-content:center;">
            <div class="qr-print-block" id="new-qr-display">
              <div id="new-qr-code"></div>
              <div class="qr-print-id" id="new-qr-id-text"></div>
              <div class="qr-print-name" id="new-qr-name-text"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PRINT QR PAGE (admin only) -->
    <div class="page" id="page-print">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px;">
        <h2 style="font-size:20px;font-weight:700;color:#ffffff;">Print QR Labels</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-secondary" onclick="togglePrintSelectMode()" id="print-select-btn">â˜‘ Select</button>
          <button class="btn btn-primary" id="print-action-btn" onclick="printAllQR()">ğŸ–¨ Print All</button>
        </div>
      </div>
      <div id="print-select-bar" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:14px;align-items:center;gap:12px;">
        <span id="print-selected-count" style="flex:1;font-size:13px;color:var(--text2);">0 selected</span>
        <button class="btn btn-secondary btn-sm" onclick="selectAllForPrint()">Select All</button>
        <button class="btn btn-secondary btn-sm" onclick="clearPrintSelection()">Clear</button>
      </div>
      <div class="print-grid" id="print-grid"></div>
    </div>

    <!-- ADMIN PAGE (admin only) -->
    <div class="page" id="page-admin">
      <!-- Firebase Sync (full inline) -->
      <div class="admin-section">
        <div class="admin-section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>ğŸ”¥ Firebase Sync</span>
          <div style="display:flex;gap:8px;" id="fb-action-btns"></div>
        </div>
        <div id="fb-status-block" style="font-size:13px;color:var(--text2);margin-top:6px;"></div>
        <!-- Connect form -->
        <div id="admin-connect-card" style="margin-top:14px;display:none;flex-direction:column;gap:10px;">
          <p style="font-size:13px;color:var(--text2);line-height:1.6;">Connect to Firebase to sync in real time across all devices.</p>
          <input class="form-input" id="admin-project-id"
            placeholder="Firebase Project ID (e.g. myapp-a1b2c)"
            style="font-family:'DM Mono',monospace;font-size:14px;"
            onkeydown="if(event.key==='Enter')adminConnectFirebase()">
          <div id="admin-connect-feedback" style="display:none;font-size:12px;padding:8px 12px;border-radius:6px;"></div>
          <button class="btn btn-primary" onclick="adminConnectFirebase()" style="justify-content:center;padding:12px;">
            ğŸ”¥ Connect &amp; Start Syncing
          </button>
        </div>
        <!-- Connected state -->
        <div id="admin-connected-block" style="display:none;margin-top:12px;">
          <div style="background:rgba(74,222,128,0.06);border:1px solid rgba(74,222,128,0.25);border-radius:var(--radius-sm);padding:12px 14px;display:flex;align-items:center;gap:12px;">
            <span style="font-size:24px;">ğŸ”¥</span>
            <div style="flex:1;min-width:0;">
              <div style="font-size:13px;font-weight:600;color:var(--green);">Connected â€” real-time sync active</div>
              <div id="admin-connected-url" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);margin-top:3px;word-break:break-all;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
            <button class="btn btn-secondary btn-sm" onclick="fbStartListening();notify('Listener restarted','info')">â†» Reconnect</button>
            <button class="btn btn-danger btn-sm" onclick="adminDisconnectFirebase()">Disconnect</button>
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <!-- Appearance -->
      <div class="admin-section">
        <div class="admin-section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>ğŸ¨ Appearance</span>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-secondary btn-sm" onclick="manualSync()" id="admin-sync-btn">â‡… Sync Now</button>
            <button class="btn btn-secondary btn-sm" onclick="toggleTheme()" id="admin-theme-btn">â˜€ Light Mode</button>
          </div>
        </div>
        <p style="font-size:13px;color:var(--text2);margin-top:4px;">Toggle between dark and light mode.</p>
      </div>
      <div class="divider"></div>
      <!-- User Management -->
      <div class="admin-section">
        <div class="admin-section-title">ğŸ‘¥ User Management</div>
        <div id="user-list"></div>
        <button class="btn btn-blue btn-sm" style="margin-top:10px;" onclick="openAddUserModal()">+ Add User</button>
      </div>
      <div class="divider"></div>
      <!-- Location Management -->
      <div class="admin-section">
        <div class="admin-section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>ğŸ“ Shelf / Location List</span>
          <button class="btn btn-blue btn-sm" onclick="openLocationsModal()">Manage</button>
        </div>
        <div id="location-preview" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;"></div>
      </div>
      <div class="divider"></div>
      <!-- Fixture Types section -->
      <div class="admin-section">
        <div class="admin-section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>ğŸ”§ Fixture Types</span>
          <button class="btn btn-blue btn-sm" onclick="addFixtureTypeInline()">+ Add Type</button>
        </div>
        <div class="toolbar" style="margin-top:8px;">
          <div class="search-box" style="flex:1;">
            <span style="color:var(--text3);">ğŸ”</span>
            <input type="text" id="admin-type-search" placeholder="Search types..." oninput="renderAdminTypes()">
          </div>
        </div>
        <div id="admin-types-list" style="margin-top:8px;"></div>
        <div id="admin-type-add-row" style="display:none;margin-top:10px;display:none;">
          <div style="display:flex;gap:8px;">
            <input class="form-input" id="admin-new-type-input" placeholder="New type name..." style="flex:1;min-height:38px;font-size:13px;">
            <button class="btn btn-primary btn-sm" onclick="adminAddFixtureType()">Add</button>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('admin-type-add-row').style.display='none'">âœ•</button>
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <!-- Fixture Management -->
      <div class="admin-section">
        <div class="admin-section-title">ğŸ“¦ Fixture Management</div>
        <div class="toolbar">
          <div class="search-box" style="flex:1;">
            <span style="color:var(--text3);">ğŸ”</span>
            <input type="text" id="admin-search" placeholder="Search fixtures to manage..." oninput="debounce('adm',renderAdminFixtures,150)()">
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>ID</th><th>Name</th><th>Brand</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="admin-fixture-tbody"></tbody>
          </table>
        </div>
      </div>
      <div class="divider"></div>
      <!-- Usage Stats -->
      <div class="admin-section">
        <div class="admin-section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>ğŸ“Š Usage Stats</span>
        </div>
        <!-- Filter tabs -->
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;">
          <button class="btn btn-secondary btn-sm usage-tab-btn active-usage-tab" id="usage-tab-fixtures" onclick="showUsageTab('fixtures')">By Fixture</button>
          <button class="btn btn-secondary btn-sm usage-tab-btn" id="usage-tab-brand" onclick="showUsageTab('brand')">By Brand</button>
          <button class="btn btn-secondary btn-sm usage-tab-btn" id="usage-tab-type" onclick="showUsageTab('type')">By Type</button>
          <button class="btn btn-secondary btn-sm usage-tab-btn" id="usage-tab-users" onclick="showUsageTab('users')">By User</button>
        </div>
        <div id="usage-stats-body" style="margin-top:14px;"></div>
      </div>
      <div class="divider"></div>
      <!-- CSV Import / Export -->
      <div class="admin-section">
        <div class="admin-section-title">ğŸ“„ Fixture CSV Import / Export</div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:14px;">Export your fixture list as a spreadsheet, edit offline, then re-import. New fixtures are added; existing IDs are updated.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-secondary" onclick="exportFixturesCSV()">â¬‡ Export Fixtures CSV</button>
          <label class="btn btn-blue" style="cursor:pointer;">
            â¬† Import Fixtures CSV
            <input type="file" accept=".csv" onchange="importFixturesCSV(this)" style="display:none;">
          </label>
        </div>
        <div id="csv-status" style="margin-top:10px;font-size:12px;color:var(--text3);display:none;"></div>
      </div>
      <div class="divider"></div>
      <!-- Force Return -->
      <div class="admin-section">
        <div class="admin-section-title">ğŸ” Force Return</div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:14px;">Return a fixture on behalf of any user.</p>
        <div id="force-return-list"></div>
      </div>
      <div class="divider"></div>
      <!-- Transaction History Management -->
      <div class="admin-section">
        <div class="admin-section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>ğŸ“‹ Transaction History</span>
        </div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:14px;">Clear all transaction records from local storage and Firebase. This cannot be undone.</p>
        <button class="btn btn-danger" onclick="confirmClearHistory()">ğŸ—‘ Clear All History</button>
        <div id="clear-history-confirm" style="display:none;margin-top:12px;background:rgba(248,113,113,0.06);border:1px solid rgba(248,113,113,0.25);border-radius:var(--radius-sm);padding:14px;">
          <p style="font-size:13px;color:var(--text);margin-bottom:12px;">âš ï¸ This will permanently delete all transaction history. Are you sure?</p>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-danger btn-sm" onclick="clearHistory()">Yes, delete everything</button>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('clear-history-confirm').style.display='none'">Cancel</button>
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <!-- Database Backup / Restore -->
      <div class="admin-section">
        <div class="admin-section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>ğŸ’¾ Backup &amp; Restore</span>
        </div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:14px;">Export all fixtures, users, history and settings as a JSON file. Restore from a previous backup at any time.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-secondary" onclick="exportBackup()">â¬‡ Download Backup</button>
          <label class="btn btn-blue" style="cursor:pointer;">
            â¬† Restore from Backup
            <input type="file" accept=".json" onchange="importBackup(this)" style="display:none;">
          </label>
        </div>
        <div id="backup-status" style="margin-top:10px;font-size:12px;color:var(--text3);display:none;"></div>
      </div>
    </div>
    <!-- CONTAINERS PAGE -->
    <div class="page" id="page-containers">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px;">
        <h2 style="font-size:20px;font-weight:700;color:#fff;">ğŸ“¦ Cases &amp; Boxes</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-secondary" id="case-print-select-btn" onclick="toggleCasePrintMode()">â˜‘ Select to Print</button>
          <button class="btn btn-blue" onclick="openBatchAddFixturesToCase()">+ Add Fixtures to Case</button>
          <button class="btn btn-primary" onclick="openAddContainerModal()">+ New Case</button>
        </div>
      </div>
      <div id="case-print-bar" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:14px;align-items:center;gap:10px;flex-wrap:wrap;">
        <span id="case-print-count" style="flex:1;font-size:13px;color:var(--text2);">0 selected</span>
        <button class="btn btn-secondary btn-sm" onclick="selectAllCases()">Select All</button>
        <button class="btn btn-secondary btn-sm" onclick="clearCaseSelection()">Clear</button>
        <button class="btn btn-primary btn-sm" onclick="printSelectedCases()">ğŸ–¨ Print Selected</button>
      </div>
      <p id="containers-desc" style="font-size:13px;color:var(--text2);margin-bottom:20px;line-height:1.6;">Each case has its own QR code. Scan a case QR to see all fixtures inside it. Tag fixtures to a case by editing them.</p>
      <div id="containers-list"></div>
    </div>
    <!-- SETUP PAGE -->
    <div class="page" id="page-setup">
      <div style="max-width:620px;margin:0 auto;padding-bottom:20px;">

        <!-- Status banner -->
        <div id="setup-status-banner" style="border-radius:var(--radius);padding:16px 20px;margin-bottom:24px;display:flex;align-items:center;gap:14px;"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
          <h2 style="font-size:20px;font-weight:700;color:#ffffff;">âš™ï¸ Settings</h2>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <button class="btn btn-secondary btn-sm" onclick="toggleTheme()" id="settings-theme-btn">â˜€ Light Mode</button>
            <button class="btn btn-secondary btn-sm" id="settings-sync-btn" onclick="manualSync()">â‡… Sync Now</button>
          </div>
        </div>
        <h3 id="settings-fb-heading" style="font-size:15px;font-weight:600;margin-bottom:6px;color:var(--text);">ğŸ”¥ Firebase Sync</h3>
        <p id="settings-fb-desc" style="color:var(--text2);font-size:13px;margin-bottom:20px;line-height:1.7;">Connect LumaSamples to Firebase to sync in real time across all devices.</p>

        <!-- Connect form (hidden when connected) -->
        <div class="setup-card admin-only-setting" id="setup-connect-card" style="flex-direction:column;gap:14px;">
          <div class="setup-card-body" style="width:100%;">
            <div class="setup-card-title" style="font-size:16px;margin-bottom:4px;">Enter your Firebase Project ID</div>
            <div class="setup-card-desc" style="margin-bottom:14px;">Ask your admin for the Project ID, or find it in <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accent);">Firebase Console</a> â†’ Project Settings â†’ Project ID field.</div>
            <input class="form-input" id="setup-project-id"
              placeholder="your-project-id  (e.g. myapp-a1b2c)"
              style="font-family:'DM Mono',monospace;font-size:14px;letter-spacing:0.5px;"
              onkeydown="if(event.key==='Enter')connectFromSetup()">
            <div id="setup-connect-feedback" style="display:none;margin-top:8px;font-size:12px;padding:8px 12px;border-radius:6px;"></div>
            <button class="btn btn-primary" onclick="connectFromSetup()"
              style="width:100%;justify-content:center;padding:14px;font-size:15px;margin-top:12px;letter-spacing:0.3px;">
              ğŸ”¥ Connect &amp; Start Syncing
            </button>
            <details style="margin-top:18px;">
              <summary style="font-size:13px;color:var(--text2);cursor:pointer;user-select:none;font-weight:500;">â–¸ Having trouble connecting?</summary>
              <div style="margin-top:12px;padding:16px;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--border);">
                <div style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:8px;">Contact an admin for help.</div>
                <div style="font-size:13px;color:var(--text2);line-height:1.7;margin-bottom:12px;">Alternatively, paste your full Firebase config object below. You can find it in Firebase Console â†’ Project Settings â†’ Your apps â†’ Web app.</div>
                <textarea id="setup-fb-config" class="form-input" rows="6"
                  placeholder="const firebaseConfig = {&#10;  apiKey: &quot;AIza...&quot;,&#10;  authDomain: &quot;...&quot;,&#10;  databaseURL: &quot;https://...firebaseio.com&quot;,&#10;  projectId: &quot;...&quot;,&#10;  ...&#10;}"
                  style="font-family:'DM Mono',monospace;font-size:12px;resize:vertical;line-height:1.5;"></textarea>
              </div>
            </details>
          </div>
        </div>

        <!-- Connected state -->
        <div id="setup-connected-block" style="display:none;">
          <div class="setup-card" style="border-color:rgba(74,222,128,0.3);background:rgba(74,222,128,0.04);">
            <div style="font-size:32px;flex-shrink:0;">ğŸ”¥</div>
            <div class="setup-card-body">
              <div class="setup-card-title" style="color:var(--green);font-size:16px;">Connected â€” real-time sync active</div>
              <div id="setup-connected-url" style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);margin-top:6px;word-break:break-all;"></div>
              <div class="setup-admin-only-btns" style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;">
                <button class="btn btn-secondary btn-sm" onclick="fbStartListening();notify('Listener restarted','info')">â†» Reconnect</button>
                <button class="btn btn-danger btn-sm" onclick="disconnectFromSetup()">Disconnect</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </main>
</div>

<!-- â”€â”€ GLOBAL SEARCH OVERLAY â”€â”€ -->
<div id="global-search-overlay" onclick="if(event.target===this)closeGlobalSearch()">
  <div class="gs-box">
    <div class="gs-input-row">
      <span style="font-size:18px;color:var(--text3);">ğŸ”</span>
      <input class="gs-input" id="gs-input" placeholder="Search fixtures, IDs, locations, brands..." oninput="runGlobalSearch()" autocomplete="off">
      <button onclick="closeGlobalSearch()" style="background:none;border:none;color:var(--text3);font-size:22px;cursor:pointer;padding:0 4px;">Ã—</button>
    </div>
    <div class="gs-results" id="gs-results">
      <div class="gs-empty">Start typing to search everythingâ€¦</div>
    </div>
  </div>
</div>
<!-- â”€â”€ BULK CHECKOUT BAR â”€â”€ -->
<div class="bulk-bar" id="bulk-bar">
  <div style="flex:1;min-width:0;">
    <div class="bulk-bar-count" id="bulk-count">0 selected</div>
    <div id="bulk-summary" style="font-size:11px;color:var(--text3);margin-top:2px;"></div>
  </div>
  <button class="btn btn-primary btn-sm" id="bulk-action-btn" onclick="bulkDoAll()" style="display:none;">âœ¦ Do All</button>
  <button class="btn btn-secondary btn-sm" onclick="toggleBulkMode()">Cancel</button>
</div>
<!-- â”€â”€ BOTTOM TAB BAR (mobile) â”€â”€ -->
<div id="bottom-tabs">
  <button class="btab active" id="btab-home"    onclick="showPage('home',this)"   >
    <span class="btab-icon">ğŸ </span>Home
  </button>
  <button class="btab"        id="btab-library" onclick="showPage('library',this)">
    <span class="btab-icon">ğŸ’¡</span>Library
  </button>
  <button class="btab" id="btab-containers" onclick="showPage('containers',this)">
    <span class="btab-icon">ğŸ“¦</span>Cases
  </button>
  <button class="btab"        id="btab-history" onclick="showPage('history',this)">
    <span class="btab-icon">ğŸ“‹</span>History
  </button>
  <button class="btab admin-btab" id="btab-add"   onclick="showPage('add',this)"   style="display:none;">
    <span class="btab-icon">â•</span>Add
  </button>
  <button class="btab admin-btab" id="btab-print" onclick="showPage('print',this)" style="display:none;">
    <span class="btab-icon">ğŸ–¨</span>Print
  </button>
  <button class="btab admin-btab" id="btab-admin" onclick="showPage('admin',this)" style="display:none;">
    <span class="btab-icon">âš™ï¸</span>Settings
  </button>
  <!-- settings btab merged into admin -->
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• DEEP LINK SCAN LANDING â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- Shown when opened via QR scan (?f=FL-xxxx) from native camera -->
<div id="scan-landing" style="display:none;position:fixed;inset:0;z-index:9000;background:var(--bg);overflow-y:auto;-webkit-overflow-scrolling:touch;">
  <!-- Header bar -->
  <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:10;">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;color:var(--accent);">LumaSamples</div>
    <div id="scan-landing-sync-dot" style="width:8px;height:8px;border-radius:50%;background:var(--red);" title=""></div>
  </div>
  <!-- Fixture card -->
  <div id="scan-landing-body" style="padding:20px 16px;max-width:500px;margin:0 auto;"></div>
  <!-- Action sheet â€” user picker -->
  <div id="scan-action-sheet" style="display:none;position:fixed;inset:0;z-index:9100;background:rgba(0,0,0,0.6);" onclick="if(event.target===this)closeScanActionSheet()">
    <div id="scan-action-inner" style="position:absolute;bottom:0;left:0;right:0;background:var(--surface2);border-top:1px solid var(--border2);border-radius:20px 20px 0 0;padding:20px 16px 32px;max-height:85vh;overflow-y:auto;overscroll-behavior:contain;touch-action:pan-y;-webkit-overflow-scrolling:touch;">
      <div id="scan-action-content"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ CHECKOUT NOTE MODAL â”€â”€ -->
<div class="modal-overlay" id="checkout-note-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title" id="checkout-note-title">Check Out Fixture</div>
      <button class="modal-close" onclick="closeModal('checkout-note-modal')">Ã—</button>
    </div>
    <div class="modal-body">
      <div id="checkout-note-fixture-info" style="background:var(--surface2);border-radius:var(--radius-sm);padding:12px;margin-bottom:16px;font-size:13px;color:var(--text2);"></div>
      <div class="form-group">
        <label class="form-label">Job / Note <span style="color:var(--text3);font-weight:400;">(optional)</span></label>
        <input class="form-input" id="checkout-note-input" placeholder="Taking for jobâ€¦ e.g. Office 3F, Living Room Sample" autocomplete="off"
          onkeydown="if(event.key==='Enter')confirmCheckoutNote()">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('checkout-note-modal')">Cancel</button>
      <button class="btn btn-success" onclick="confirmCheckoutNote()">â†— Check Out</button>
    </div>
  </div>
</div>
<!-- â”€â”€ ADD CONTAINER MODAL â”€â”€ -->
<div class="modal-overlay" id="add-container-modal">
  <div class="modal" style="max-width:440px;">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¦ New Case / Box</div>
      <button class="modal-close" onclick="closeModal('add-container-modal')">Ã—</button>
    </div>
    <div class="modal-body" style="max-height:80vh;overflow-y:auto;">
      <div class="form-group">
        <label class="form-label">Case Name</label>
        <input class="form-input" id="nc-name" placeholder="e.g. Road Case A, Living Room Kit">
      </div>
      <div class="form-group">
        <label class="form-label">Description <span style="color:var(--text3);font-weight:400;">(optional)</span></label>
        <input class="form-input" id="nc-desc" placeholder="e.g. Pendant samples for showroom">
      </div>
      <div class="form-group">
        <label class="form-label">Add Fixtures <span style="color:var(--text3);font-weight:400;">(optional â€” unassigned only)</span></label>
        <div class="search-box" style="margin-bottom:8px;">
          <span style="color:var(--text3);">ğŸ”</span>
          <input type="text" id="nc-fixture-search" class="" style="flex:1;background:none;border:none;outline:none;color:var(--text);font-size:14px;padding:8px 0;" placeholder="Search fixtures..." oninput="renderNcFixturePicker()">
        </div>
        <div id="nc-fixture-list" style="max-height:180px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm);"></div>
        <div id="nc-selected-count" style="font-size:12px;color:var(--text3);margin-top:6px;">0 fixtures selected</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('add-container-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="addContainer()">âœ¦ Create Case</button>
    </div>
  </div>
</div>
<!-- â”€â”€ CONTAINER DETAIL MODAL â”€â”€ -->
<div class="modal-overlay" id="container-detail-modal">
  <div class="modal" style="max-width:540px;">
    <div class="modal-header">
      <div class="modal-title" id="cd-title">Case Detail</div>
      <button class="modal-close" onclick="closeModal('container-detail-modal')">Ã—</button>
    </div>
    <div class="modal-body" id="cd-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('container-detail-modal')">Close</button>
      <button class="btn btn-danger btn-sm" id="cd-delete-btn" onclick="">Delete Case</button>
    </div>
  </div>
</div>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="login-detail-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title">Fixture Details</div>
      <button class="modal-close" onclick="closeModal('login-detail-modal')">Ã—</button>
    </div>
    <div class="modal-body" id="login-detail-body"></div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('login-detail-modal')">Close</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• SCAN MODAL â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="scan-modal">
  <div class="modal" style="max-width:380px;">
    <div class="modal-header">
      <div class="modal-title">ğŸ“· Scan QR Code</div>
      <button class="modal-close" onclick="closeScanModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <!-- Native camera trigger â€” hidden file input, tapped by the button -->
      <input type="file" id="qr-camera-input" accept="image/*" capture="environment"
        style="display:none;" onchange="handleCameraCapture(this)">

      <div id="scan-camera-prompt" style="text-align:center;padding:10px 0 18px;">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ“·</div>
        <button class="btn btn-primary" style="width:100%;justify-content:center;padding:16px;font-size:16px;letter-spacing:0.3px;"
          onclick="triggerNativeCamera()">
          Open Camera to Scan
        </button>
        <p style="font-size:12px;color:var(--text3);margin-top:10px;line-height:1.6;">
          Uses your device's native camera â€” fast and accurate.<br>
          The camera permission is remembered after the first scan.
        </p>
      </div>

      <div id="scan-processing" style="display:none;text-align:center;padding:20px;">
        <div style="font-size:32px;margin-bottom:8px;">â³</div>
        <div style="font-size:13px;color:var(--text2);">Reading QR codeâ€¦</div>
      </div>

      <div id="scan-result" style="display:none;margin-top:4px;padding:14px;background:var(--surface2);border-radius:var(--radius-sm);"></div>

      <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px;">
        <label class="form-label" style="font-size:11px;">Or Enter ID Manually</label>
        <div style="display:flex;gap:8px;">
          <input class="form-input" id="manual-id-input" placeholder="e.g. FL-0042" style="flex:1;text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')processManualId()">
          <button class="btn btn-secondary" onclick="processManualId()">Go</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Fixture Details</div>
      <button class="modal-close" onclick="closeModal('detail-modal')">Ã—</button>
    </div>
    <div class="modal-body" id="detail-body"></div>
    <div class="modal-footer" id="detail-footer"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• ADD USER MODAL â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="add-user-modal">
  <div class="modal" style="max-width:360px;">
    <div class="modal-header">
      <div class="modal-title">Add New User</div>
      <button class="modal-close" onclick="closeModal('add-user-modal')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input class="form-input" id="nu-name" placeholder="e.g. Jane Smith">
      </div>
      <div class="form-group">
        <label class="form-label">4-Digit PIN</label>
        <input class="form-input" id="nu-pin" type="password" maxlength="4" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢">
      </div>
      <div class="form-group">
        <label class="form-label">Role</label>
        <select class="form-input" id="nu-role">
          <option value="user">User â€” checkout/return only</option>
          <option value="admin">Admin â€” full access</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Avatar</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;max-height:120px;overflow-y:auto;" id="avatar-picker">
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ’¡</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ”¦</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸŒŸ</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">âš¡</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¨</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ—ï¸</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¯</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸŒ™</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ”§</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ </span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ‘·</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ§‘â€ğŸ¨</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸª©</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸª</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸŒˆ</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ”®</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ› ï¸</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ­</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ†</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¥‡</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¦</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¯</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¦Š</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸº</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¦…</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸŒŠ</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ”¥</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">â„ï¸</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸŒ¿</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ€</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¸</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¹</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸº</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ»</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¥</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸµ</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¶</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¤</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¬</span>
          <span class="av-opt" onclick="pickAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ“¸</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('add-user-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="addUser()">Add User</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• EDIT USER MODAL â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="edit-user-modal">
  <div class="modal" style="max-width:360px;">
    <div class="modal-header">
      <div class="modal-title">Edit User</div>
      <button class="modal-close" onclick="closeModal('edit-user-modal')">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="eu-id">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input class="form-input" id="eu-name">
      </div>
      <div class="form-group">
        <label class="form-label">Change PIN (leave blank to keep)</label>
        <input class="form-input" id="eu-pin" type="password" maxlength="4" inputmode="numeric" placeholder="New PIN">
      </div>
      <div class="form-group">
        <label class="form-label">Role</label>
        <select class="form-input" id="eu-role">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Avatar</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;max-height:120px;overflow-y:auto;" id="eu-avatar-picker">
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ’¡</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ”¦</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸŒŸ</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">âš¡</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¨</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ—ï¸</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¯</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸŒ™</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ”§</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ </span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ‘·</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ§‘â€ğŸ¨</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸª©</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸª</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸŒˆ</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ”®</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ› ï¸</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ­</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ†</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¥‡</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¦</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¯</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¦Š</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸº</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¦…</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸŒŠ</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ”¥</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">â„ï¸</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸŒ¿</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ€</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¸</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¹</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸº</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ»</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¥</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸµ</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¶</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¤</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ¬</span>
          <span class="av-opt" onclick="pickEditAvatar(this)" style="font-size:26px;cursor:pointer;padding:5px;border-radius:7px;border:2px solid transparent;">ğŸ“¸</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('edit-user-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditUser()">Save Changes</button>
    </div>
  </div>
</div>

<div class="notif" id="notif"></div>



<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• EDIT FIXTURE MODAL â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="edit-fixture-modal">
  <div class="modal" style="max-width:620px;">
    <div class="modal-header">
      <div class="modal-title">âœï¸ Edit Fixture</div>
      <button class="modal-close" onclick="closeModal('edit-fixture-modal')">Ã—</button>
    </div>
    <div class="modal-body" style="max-height:80vh;overflow-y:auto;">
      <input type="hidden" id="ef-id">
      <div class="form-group">
        <label class="form-label">Fixture ID</label>
        <input class="form-input" id="ef-fid" readonly style="font-family:'DM Mono',monospace;color:var(--accent);background:var(--accent-dim);">
      </div>
      <div class="form-group">
        <label class="form-label">Fixture Name *</label>
        <input class="form-input" id="ef-name" placeholder="e.g. Arco Pendant LED">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Manufacturer</label>
          <input class="form-input" id="ef-brand" placeholder="e.g. Flos">
        </div>
        <div class="form-group">
          <label class="form-label">Part Number</label>
          <input class="form-input" id="ef-partno" placeholder="e.g. FLS-1234-B">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date Received</label>
          <input class="form-input" id="ef-datereceived" type="date">
        </div>
        <div class="form-group">
          <label class="form-label">Wattage</label>
          <input class="form-input" id="ef-wattage" placeholder="e.g. 18W">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Input Voltage</label>
          <input class="form-input" id="ef-voltage" placeholder="e.g. 120V / 277V">
        </div>
        <div class="form-group">
          <label class="form-label">Fixture Type</label>
          <div style="position:relative;">
            <select class="form-input" id="ef-fixtype" onchange="onFixTypeChange('ef-fixtype','ef-output-wattage-row')" style="padding-right:32px;-webkit-appearance:none;appearance:none;background:var(--surface2);cursor:pointer;">
              <option value="">â€” Select type â€”</option>
            </select>
            <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none;font-size:12px;">â–¾</span>
          </div>
        </div>
      </div>
      <div class="form-row" id="ef-output-wattage-row" style="display:none;">
        <div class="form-group">
          <label class="form-label">Output Wattage</label>
          <input class="form-input" id="ef-output-wattage" placeholder="e.g. 60W">
        </div>
        <div class="form-group"></div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Shelf / Location</label>
          <div style="position:relative;">
            <input class="form-input" id="ef-location" placeholder="Type or select..." autocomplete="off"
              oninput="filterLocDropdown('ef-location','loc-drop-edit')"
              onfocus="showLocDropdown('ef-location','loc-drop-edit')"
              onblur="setTimeout(()=>hideLocDropdown('loc-drop-edit'),180)"
              style="padding-right:32px;">
            <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none;font-size:12px;">â–¾</span>
            <div id="loc-drop-edit" class="loc-dropdown" style="display:none;"></div>
          </div>
        </div>
        <div class="form-group"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Spec Sheet URL</label>
        <input class="form-input" id="ef-specsheet" placeholder="https://â€¦ (link to PDF or product page)" type="url">
      </div>
      <!-- Last checked out info box -->
      <div id="ef-lastco-box" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:12px;">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:4px;">Last Checked Out</div>
        <div id="ef-lastco-info" style="font-size:13px;color:var(--text2);"></div>
      </div>
      <!-- Comments / Notes accordion -->
      <details id="ef-comments-details" style="margin-top:4px;">
        <summary style="cursor:pointer;font-size:15px;font-weight:600;color:var(--text2);padding:14px 0;list-style:none;display:flex;align-items:center;gap:8px;border-top:1px solid var(--border);">
          <span id="ef-comments-toggle-icon" style="font-size:12px;">â–¸</span> ğŸ’¬ Notes &amp; Comment History
          <span id="ef-comments-count" style="font-size:13px;font-weight:400;color:var(--text3);"></span>
        </summary>
        <div style="margin-top:12px;">
          <div style="display:flex;gap:8px;margin-bottom:14px;">
            <input class="form-input" id="ef-new-comment" placeholder="Add a comment or note..." style="flex:1;">
            <button class="btn btn-blue btn-sm" onclick="addFixtureComment()">Post</button>
          </div>
          <div id="ef-comment-list" style="display:flex;flex-direction:column;gap:10px;max-height:500px;overflow-y:auto;font-size:14px;"></div>
        </div>
      </details>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('edit-fixture-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditFixture()">Save Changes</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• MANAGE LOCATIONS MODAL â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="locations-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title">ğŸ“ Manage Locations</div>
      <button class="modal-close" onclick="closeModal('locations-modal')">Ã—</button>
    </div>
    <div class="modal-body">
      <p style="font-size:12px;color:var(--text2);margin-bottom:14px;">These appear in the Location dropdown when adding or editing fixtures.</p>
      <div id="locations-list" style="margin-bottom:14px;"></div>
      <div style="display:flex;gap:8px;">
        <input class="form-input" id="new-location-input" placeholder="New location name..." style="flex:1;">
        <button class="btn btn-primary" onclick="addLocation()">Add</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('locations-modal')">Done</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• MANAGE FIXTURE TYPES MODAL â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="fixtypes-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title">ğŸ”§ Fixture Types</div>
      <button class="modal-close" onclick="closeModal('fixtypes-modal')">Ã—</button>
    </div>
    <div class="modal-body">
      <p style="font-size:12px;color:var(--text2);margin-bottom:14px;">These appear in the Fixture Type dropdown. Anyone can add new types.</p>
      <div id="fixtypes-list" style="margin-bottom:14px;max-height:260px;overflow-y:auto;"></div>
      <div style="display:flex;gap:8px;">
        <input class="form-input" id="new-fixtype-input" placeholder="New type name..." style="flex:1;">
        <button class="btn btn-primary" onclick="addFixtureType()">Add</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('fixtypes-modal')">Done</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KEY_FIXTURES  = 'luma:fixtures';
const KEY_USERS     = 'luma:users';
const KEY_HISTORY   = 'luma:history';
const KEY_COUNTER   = 'luma:counter';
const KEY_LOCATIONS  = 'luma:locations';
const KEY_FIX_TYPES  = 'luma:fixtureTypes';
const KEY_FB_CONFIG = 'luma:fbConfig';  // Firebase config JSON

// â”€â”€ HARDCODED FIREBASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// An admin can paste the projectId here once and every device
// will auto-connect without any setup. Leave null to use the
// Sync Setup tab manually.
// Example: const HARDCODED_FB_PROJECT_ID = 'lumasamples-abc12';
const HARDCODED_FB_PROJECT_ID = null;
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const DEFAULT_FIX_TYPES = ['Downlight','Uplight','Wall Sconce','Pendant','Track Head','Linear / Strip','Flood','Spot','Bollard','Step Light','Underwater','Power Supply','Driver','Transformer','Other'];
const DEFAULT_LOCATIONS = ['Shelf A-1','Shelf A-2','Shelf B-1','Shelf B-2','Shelf B-3','Shelf C-1','Shelf C-2','Storage Room','Display Floor','Front Desk','Back Office'];

let fixtures  = [];
let users     = [];
let history   = [];
let locations = [];
let fixtureTypes = [];
let fixtureCounter = 42;
let currentUser    = null;
let pinTarget      = null;
let pinBuffer      = '';
let selectedAvatar = 'ğŸ’¡';
let scannerInstance = null;
let fbConfig   = null;   // Firebase config object { apiKey, projectId, ... }
let fbDb       = null;   // Firebase database reference
let fbUnsub    = [];     // active Firebase listeners (for cleanup)
let fbSyncing  = false;  // prevent overlapping initial sync

const ADMIN_DEFAULTS = [
  { id: 'admin-1', name: 'Admin', pin: '4116', role: 'admin', avatar: 'âš™ï¸' }
];
const SAMPLE_FIXTURES = [
  { id:'FL-0001', name:'Arco Pendant LED', brand:'Flos', category:'Pendant', wattage:'18W', finish:'Polished Chrome', location:'Shelf A-1', notes:'Dimmable 0-10V', status:'available', checkedOutBy:null, checkedOutAt:null },
  { id:'FL-0002', name:'Zuma Recessed Trim', brand:'Halo', category:'Recessed', wattage:'9W', finish:'Matte White', location:'Shelf A-2', notes:'4" aperture', status:'available', checkedOutBy:null, checkedOutAt:null },
  { id:'FL-0003', name:'Volta Wall Sconce', brand:'Visual Comfort', category:'Wall', wattage:'12W', finish:'Aged Brass', location:'Shelf B-1', notes:'Up/down light', status:'available', checkedOutBy:null, checkedOutAt:null },
  { id:'FL-0004', name:'Nova Track Head', brand:'Juno', category:'Track', wattage:'15W', finish:'Matte Black', location:'Shelf B-2', notes:'Adjustable beam', status:'available', checkedOutBy:null, checkedOutAt:null },
  { id:'FL-0005', name:'Serene Strip Light', brand:'Lutron', category:'Linear', wattage:'20W/m', finish:'N/A', location:'Shelf C-1', notes:'Color tunable 2700-6500K', status:'available', checkedOutBy:null, checkedOutAt:null },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCAL STORAGE (cache layer)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Safe storage abstraction: tries window.storage, falls back to localStorage â”€â”€
async function storeGet(key) {
  try {
    if (window.storage && typeof window.storage.get === 'function') {
      const r = await window.storage.get(key);
      return r ? r.value : null;
    }
  } catch(e) {}
  try { return localStorage.getItem(key); } catch(e) {}
  return null;
}
async function storeSet(key, val) {
  try {
    if (window.storage && typeof window.storage.set === 'function') {
      await window.storage.set(key, val);
      return;
    }
  } catch(e) {}
  try { localStorage.setItem(key, val); } catch(e) {}
}

async function localLoad() {
  try { const r = await storeGet(KEY_FIXTURES);   fixtures  = r ? JSON.parse(r) : [...SAMPLE_FIXTURES]; } catch { fixtures = [...SAMPLE_FIXTURES]; }
  try { const r = await storeGet(KEY_USERS);      users     = r ? JSON.parse(r) : [...ADMIN_DEFAULTS]; } catch { users = [...ADMIN_DEFAULTS]; }
  try { const r = await storeGet(KEY_HISTORY);    history   = r ? JSON.parse(r) : []; } catch { history = []; }
  try { const r = await storeGet(KEY_COUNTER);    fixtureCounter = r ? parseInt(r) : 42; } catch { fixtureCounter = 42; }
  try { const r = await storeGet(KEY_LOCATIONS);  locations = r ? JSON.parse(r) : [...DEFAULT_LOCATIONS]; } catch { locations = [...DEFAULT_LOCATIONS]; }
  try { const r = await storeGet(KEY_FIX_TYPES);   fixtureTypes = r ? JSON.parse(r) : [...DEFAULT_FIX_TYPES]; } catch { fixtureTypes = [...DEFAULT_FIX_TYPES]; }
  try {
    const r = await storeGet(KEY_FB_CONFIG);
    fbConfig = r ? JSON.parse(r) : null;
  } catch { fbConfig = null; }
  // Fall back to hardcoded project ID if no saved config
  if (!fbConfig && HARDCODED_FB_PROJECT_ID) {
    fbConfig = {
      apiKey: 'lumasamples-autokey',
      authDomain: HARDCODED_FB_PROJECT_ID + '.firebaseapp.com',
      databaseURL: 'https://' + HARDCODED_FB_PROJECT_ID + '-default-rtdb.firebaseio.com',
      projectId: HARDCODED_FB_PROJECT_ID,
      storageBucket: HARDCODED_FB_PROJECT_ID + '.appspot.com',
      messagingSenderId: '000000000000',
      appId: '1:000000000000:web:000000000000',
    };
  }
}

async function localSave() {
  try {
    await storeSet(KEY_FIXTURES,  JSON.stringify(fixtures));
    await storeSet(KEY_USERS,     JSON.stringify(users));
    await storeSet(KEY_HISTORY,   JSON.stringify(history));
    await storeSet(KEY_COUNTER,   String(fixtureCounter));
    await storeSet(KEY_LOCATIONS, JSON.stringify(locations));
    await storeSet(KEY_FIX_TYPES,  JSON.stringify(fixtureTypes));
  } catch(e) { console.error('Local save failed', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE REALTIME DATABASE SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FIREBASE SYNC  (compat SDK v9 â€” loaded via <script>)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _fbApp = null;

// â”€â”€ Init Firebase â”€â”€
async function fbInit(config) {
  // Delete any pre-existing app so re-connect works cleanly
  if (_fbApp) {
    try { await _fbApp.delete(); } catch(e) {}
    _fbApp = null; fbDb = null;
  }
  _fbApp = firebase.initializeApp(config, 'lumasamples-' + Date.now());
  fbDb   = firebase.database(_fbApp);
  return fbDb;
}

// â”€â”€ Path helpers (compat API) â”€â”€
function fbRef(path)             { return fbDb.ref(path); }
async function fbGet(path)       { return fbDb.ref(path).get(); }
async function fbSet(path, val)  { return fbDb.ref(path).set(val); }
async function fbUpdate(path, u) { return fbDb.ref(path).update(u); }
async function fbRemove(path)    { return fbDb.ref(path).remove(); }
async function fbPush(path, val) { return fbDb.ref(path).push(val); }

// â”€â”€ Real-time listener â”€â”€
let fbUnsubscribe = null;
function fbStartListening() {
  fbStopListening();
  fbDb.ref('lumasamples').on('value',
    snap => {
      if (!snap.exists()) return;
      applyRemoteData(snap.val());
      localSave();
      refreshCurrentPage();
      renderLoginScreen();
      setSyncStatus('synced', 'Live Â· ' + new Date().toLocaleTimeString());
    },
    err => setSyncStatus('error', 'Firebase: ' + err.message)
  );
  fbUnsubscribe = () => fbDb.ref('lumasamples').off('value');
}

function fbStopListening() {
  if (fbUnsubscribe) { try { fbUnsubscribe(); } catch(e) {} fbUnsubscribe = null; }
}

// â”€â”€ Apply remote snapshot to local state â”€â”€
function applyRemoteData(data) {
  if (data.fixtures)  fixtures  = Object.values(data.fixtures).map(normalizeFixture);
  if (data.users)     users     = Object.values(data.users).map(normalizeUser);
  if (data.locations) locations = Array.isArray(data.locations)
    ? data.locations.filter(Boolean)
    : Object.values(data.locations).filter(Boolean);
  if (data.fixtureTypes) fixtureTypes = Array.isArray(data.fixtureTypes)
    ? data.fixtureTypes.filter(Boolean)
    : Object.values(data.fixtureTypes).filter(Boolean);
  if (data.containers) containers = Object.values(data.containers);
  if (data.history)   history   = Object.values(data.history)
    .sort((a, b) => new Date(b.ts) - new Date(a.ts)).slice(0, 500);
  if (data.counter) {
    const rc = parseInt(data.counter);
    if (!isNaN(rc) && rc > fixtureCounter) fixtureCounter = rc;
  }
  ensureAdmin();
  bumpCounter();
}

// â”€â”€ Normalize data from Firebase â”€â”€
function normalizeFixture(f) {
  return {
    id: f.id||'', name: f.name||'', brand: f.brand||'',
    category: f.category||'', fixtureType: f.fixtureType||'', outputWattage: f.outputWattage||'', wattage: f.wattage||'',
    voltage: f.voltage||'',
    finish: f.finish||'', location: f.location||'',
    partNo: f.partNo||'', notes: f.notes||'', specSheet: f.specSheet||'',
    dateReceived: f.dateReceived||'',
    comments: f.comments||[],  // [{ts, userId, userName, text, action}]
    status: f.status||'available',
    checkedOutBy: f.checkedOutBy||null, checkedOutAt: f.checkedOutAt||null,
    containerId: f.containerId||null,
  };
}
function normalizeUser(u) {
  return { id:u.id||'', name:u.name||'', pin:u.pin||'', role:u.role||'user', avatar:u.avatar||'ğŸ’¡' };
}

// â”€â”€ Push full local snapshot to Firebase (on first connect) â”€â”€
async function fbPushAll() {
  setSyncStatus('syncing', 'Uploading to Firebaseâ€¦');
  // Firebase keys cannot contain . # $ [ ]
  const sanitize = s => String(s).replace(/[.#$[\]\/\s]/g, '_');
  const snap = {
    fixtures:  Object.fromEntries(fixtures.map(f => [sanitize(f.id), f])),
    containers: Object.fromEntries(containers.map(c => [sanitize(c.id), c])),
    users:     Object.fromEntries(users.map(u    => [sanitize(u.id), u])),
    locations:    Object.fromEntries(locations.map((l, i) => [sanitize(l) || 'loc' + i, l])),
    fixtureTypes: Object.fromEntries(fixtureTypes.map((t, i) => [sanitize(t) || 'type' + i, t])),
    counter:   fixtureCounter,
  };
  await fbSet('lumasamples', snap);
  // Push history entries one by one
  for (const h of history.slice(0, 200)) {
    await fbPush('lumasamples/history', h);
  }
}

// â”€â”€ Connect â”€â”€
async function connectFirebase(configInput) {
  let config;
  try {
    if (typeof configInput === 'object' && configInput !== null) {
      config = configInput;
    } else {
      let raw = String(configInput).trim();
      // Strip "const firebaseConfig = " or "var firebaseConfig = " preamble
      raw = raw.replace(/^[^{]*({[\s\S]*})[^}]*$/, '$1');
      // Quote unquoted JS object keys  e.g.  apiKey: "x"  â†’  "apiKey": "x"
      if (!raw.startsWith('{"')){
        raw = raw.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
      }
      config = JSON.parse(raw);
    }
    if (!config.projectId) throw new Error('Missing projectId');
    // databaseURL is required â€” if missing, derive it from projectId
    if (!config.databaseURL) {
      config.databaseURL = 'https://' + config.projectId + '-default-rtdb.firebaseio.com';
    }
  } catch(e) { notify('Invalid config: ' + e.message, 'error'); return; }

  setSyncStatus('syncing', 'Connecting to Firebaseâ€¦');
  try {
    fbConfig = config;
    await fbInit(config);
    // Check if Firebase already has data â€” if so pull it, otherwise push local
    const existingSnap = await fbGet('lumasamples');
    if (existingSnap && existingSnap.exists()) {
      setSyncStatus('syncing', 'Pulling data from Firebaseâ€¦');
      applyRemoteData(existingSnap.val());
      await localSave();
    } else {
      // New / empty database â€” push local data up
      await fbPushAll();
    }
    fbStartListening();
    await storeSet(KEY_FB_CONFIG, JSON.stringify(config));
    notify('âœ“ Connected â€” real-time sync active!', 'success');
    renderSetupPage();
    renderGsStatus();
    renderLoginScreen();
    refreshCurrentPage();
  } catch(e) {
    setSyncStatus('error', 'Connection failed: ' + e.message);
    notify('Firebase failed: ' + e.message, 'error');
    fbConfig = null; fbDb = null;
  }
}

// â”€â”€ Disconnect â”€â”€
function disconnectFirebase() {
  fbStopListening();
  if (_fbApp) { try { _fbApp.delete(); } catch(e) {} _fbApp = null; }
  fbConfig = null; fbDb = null;
  storeSet(KEY_FB_CONFIG, '');
  setSyncStatus('offline', 'Not connected');
  notify('Disconnected from Firebase', 'info');
  renderSetupPage();
  renderGsStatus();
}

// â”€â”€ Sync status bar â”€â”€
let syncHideTimer = null;
function setSyncStatus(state, msg) {
  // â”€â”€ login screen top-left indicator â”€â”€
  const loginBar  = document.getElementById('login-sync-bar');
  const loginDot  = document.getElementById('login-sync-dot');
  const loginMsg  = document.getElementById('login-sync-msg');
  if (loginBar) {
    loginBar.style.visibility = 'visible';
    const colors = { syncing: 'var(--accent)', synced: 'var(--green)', error: 'var(--red)', offline: 'var(--text3)' };
    const c = colors[state] || 'var(--text3)';
    if (loginDot) { loginDot.style.background = c; loginDot.style.animation = state === 'syncing' ? 'syncPulse 1s infinite' : ''; }
    if (loginMsg) { loginMsg.textContent = msg; loginMsg.style.color = c; }
  }

  // â”€â”€ header dot (always visible in header when app shown) â”€â”€
  const hDot = document.getElementById('header-sync-dot');
  if (hDot) {
    const colors = { syncing: 'var(--accent)', synced: 'var(--green)', error: 'var(--red)', offline: 'var(--red)' };
    hDot.style.background = colors[state] || 'var(--red)';
    hDot.className = state === 'syncing' ? 'sync-dot pulse' : 'sync-dot';
    hDot.title = msg;
  }
}
function hideSyncBar() { /* no-op â€” bottom bar removed */ }

async function manualSync() {
  const btn = document.getElementById('header-sync-btn') || document.getElementById('settings-sync-btn') || document.getElementById('admin-sync-btn');
  if (!fbDb) { notify('Not connected to Firebase â€” go to Sync Setup', 'error'); return; }
  if (btn) btn.classList.add('syncing');
  setSyncStatus('syncing', 'Syncingâ€¦');
  try {
    // Pull first, then push local on top to merge
    const snap = await fbGet('lumasamples');
    if (snap && snap.exists()) {
      applyRemoteData(snap.val());
    }
    await fbPushAll();
    await localSave();
    refreshCurrentPage();
    setSyncStatus('synced', 'Synced Â· ' + new Date().toLocaleTimeString());
    notify('âœ“ Synced with Firebase', 'success');
  } catch(e) {
    setSyncStatus('error', 'Sync failed: ' + e.message);
    notify('Sync failed: ' + e.message, 'error');
  } finally {
    if (btn) btn.classList.remove('syncing');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UNIFIED SAVE (local cache + Firebase)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveData(options = {}) {
  await localSave();
  if (!fbDb) return;                      // no Firebase connected â†’ local only
  try {
    const updates = {};
    if (options.fixture) {
      const f = options.fixture;
      updates[`lumasamples/fixtures/${f.id}`] = f;
      updates[`lumasamples/counter`] = fixtureCounter;
    }
    if (options.user) {
      const u = options.user;
      updates[`lumasamples/users/${u.id}`] = u;
    }
    if (options.deletedFixtureId)
      updates[`lumasamples/fixtures/${options.deletedFixtureId}`] = null;
    if (options.deletedUserId)
      updates[`lumasamples/users/${options.deletedUserId}`] = null;
    if (options.location)
      updates[`lumasamples/locations/${options.location}`] = options.location;
    if (options.deletedLocation)
      updates[`lumasamples/locations/${options.deletedLocation}`] = null;
    if (options.counter)
      updates[`lumasamples/counter`] = fixtureCounter;
    if (Object.keys(updates).length) await fbUpdate('lumasamples', flattenUpdates(updates));
    if (options.historyEntry)
      await fbPush('lumasamples/history', options.historyEntry);
  } catch(e) {
    setSyncStatus('error', 'Save error: ' + e.message);
    console.error('Firebase save error:', e);
  }
}

// flatten { 'lumasamples/fixtures/X': val } â†’ { 'fixtures/X': val }
function flattenUpdates(obj) {
  const out = {};
  for (const [k, v] of Object.entries(obj)) {
    const short = k.replace(/^lumasamples\//, '');
    out[short] = v;
  }
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT / LOAD DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadData() {
  await localLoad();
  ensureAdmin();
  bumpCounter();
  if (fbConfig) {
    // Firebase config saved â€” reconnect and PULL remote data before rendering
    setSyncStatus('syncing', 'Connecting to Firebaseâ€¦');
    try {
      await fbInit(fbConfig);
      // Pull remote snapshot first so a new device gets real data
      const snap = await fbGet('lumasamples');
      if (snap && snap.exists()) {
        applyRemoteData(snap.val());
      }
      await localSave();
      fbStartListening();
      setSyncStatus('synced', 'Firebase connected Â· ' + new Date().toLocaleTimeString());
    } catch(e) {
      setSyncStatus('error', 'Firebase reconnect failed: ' + e.message);
      await localSave();
    }
  } else {
    await localSave();
  }
}

function ensureAdmin() {
  users = users.filter(u => u.id === 'admin-1' || u.role === 'admin' || !(['Alex Rivera','Jordan Kim','Sam Chen'].includes(u.name)));
  const a = users.find(u => u.id === 'admin-1');
  if (!a) users.unshift({ id:'admin-1', name:'Admin', pin:'4116', role:'admin', avatar:'âš™ï¸' });
  else { a.role = 'admin'; a.pin = '4116'; }
}

function bumpCounter() {
  fixtures.forEach(f => {
    const n = parseInt((f.id||'').split('-')[1]);
    if (!isNaN(n) && n >= fixtureCounter) fixtureCounter = n + 1;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIN / PIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLoginScreen() {
  const grid = document.getElementById('login-user-grid');
  grid.innerHTML = users.map(u => `
    <div class="user-login-card ${u.role==='admin'?'admin-card':''}" onclick="startPinEntry('${u.id}')">
      <span class="ulc-avatar">${u.avatar}</span>
      <div class="ulc-name">${u.name}</div>
      <span class="ulc-role ${u.role}">${u.role}</span>
    </div>
  `).join('');
  renderLoginCheckedOut();
}

function openLoginDetail(fid) {
  const f = fixtures.find(x => x.id === fid);
  if (!f) return;
  const u = f.checkedOutBy ? users.find(x => x.id === f.checkedOutBy) : null;
  document.getElementById('login-detail-body').innerHTML = `
    <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;">
      <div style="flex:1;min-width:180px;">
        <div style="margin-bottom:10px;">
          <span class="fid">${f.id}</span>
          <span class="sbadge out" style="margin-left:8px;">Checked Out</span>
        </div>
        <div style="font-size:18px;font-weight:700;margin-bottom:14px;">${f.name}</div>
        <table style="font-size:13px;border-collapse:collapse;width:100%;">
          ${f.partNo   ? `<tr><td style="padding:5px 0;color:var(--text3);width:90px;">Part #</td><td style="padding:5px 0;font-family:'DM Mono',monospace;">${f.partNo}</td></tr>` : ''}
          ${f.brand    ? `<tr><td style="padding:5px 0;color:var(--text3);width:90px;">Brand</td><td style="padding:5px 0;">${f.brand}</td></tr>` : ''}
          ${(f.fixtureType||f.category) ? `<tr><td style="padding:5px 0;color:var(--text3);">Fixture Type</td><td style="padding:5px 0;">${f.fixtureType||f.category}</td></tr>` : ''}
          ${f.wattage  ? `<tr><td style="padding:5px 0;color:var(--text3);">Wattage</td><td style="padding:5px 0;">${f.wattage}</td></tr>` : ''}
          ${f.finish   ? `<tr><td style="padding:5px 0;color:var(--text3);">Finish</td><td style="padding:5px 0;">${f.finish}</td></tr>` : ''}
          ${f.location ? `<tr><td style="padding:5px 0;color:var(--text3);">Location</td><td style="padding:5px 0;">${f.location}</td></tr>` : ''}
          ${f.notes    ? `<tr><td style="padding:5px 0;color:var(--text3);">Notes</td><td style="padding:5px 0;">${f.notes}</td></tr>` : ''}
          ${f.specSheet ? `<tr><td style="padding:5px 0;color:var(--text3);">Spec Sheet</td><td style="padding:5px 0;"><a href="${f.specSheet}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;">ğŸ“„ View â†—</a></td></tr>` : ''}
          ${u ? `<tr><td style="padding:8px 0 0;color:var(--text3);">With</td><td style="padding:8px 0 0;color:var(--red);font-weight:600;">${u.avatar} ${u.name} Â· ${timeAgo(f.checkedOutAt)}</td></tr>` : ''}
        </table>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
        <div id="ldm-qr-${f.id}" style="background:white;border-radius:8px;padding:12px;"></div>
        <div style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;">${f.id}</div>
      </div>
    </div>
  `;
  openModal('login-detail-modal');
  setTimeout(() => {
    const el = document.getElementById('ldm-qr-' + f.id);
    if (el && !el.querySelector('canvas')) {
      new QRCode(el, { text: fixtureUrl(f.id), width: 125, height: 125, colorDark: '#111', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
    }
  }, 60);
}

function renderLoginCheckedOut() {
  const board   = document.getElementById('login-co-board');
  const listEl  = document.getElementById('login-co-list');
  const countEl = document.getElementById('login-co-count');
  if (!board || !listEl) return;
  const coList = fixtures.filter(f => f.status === 'out').sort((a,b) => new Date(b.checkedOutAt) - new Date(a.checkedOutAt));
  if (!coList.length) { board.style.display = 'none'; return; }
  board.style.display = 'block';
  if (countEl) countEl.textContent = coList.length + ' out';
  listEl.innerHTML = coList.map(f => {
    const u = users.find(x => x.id === f.checkedOutBy);
    return `<div class="login-co-row" onclick="openLoginDetail('${f.id}')" style="cursor:pointer;">
      <span class="login-co-id">${f.id}</span>
      <span class="login-co-name">${f.name}</span>
      <span class="login-co-user">${u ? u.avatar + ' ' + u.name : 'â€”'}</span>
      <span class="login-co-time">${timeAgo(f.checkedOutAt)}</span>
    </div>`;
  }).join('');
}

function startPinEntry(uid) {
  pinTarget = users.find(u => u.id === uid);
  pinBuffer = '';
  document.getElementById('pin-avatar').textContent = pinTarget.avatar;
  document.getElementById('pin-name').textContent = pinTarget.name;
  updatePinDots();
  document.getElementById('login-user-grid').style.display = 'none';
  document.getElementById('pin-entry').style.display = 'block';
}

function showUserSelect() {
  pinBuffer = '';
  pinTarget = null;
  document.getElementById('pin-entry').style.display = 'none';
  document.getElementById('login-user-grid').style.display = 'grid';
}

function pinPress(digit) {
  if (!digit) return;
  if (pinBuffer.length >= 4) return;
  pinBuffer += digit;
  haptic('light');
  updatePinDots();
  if (pinBuffer.length === 4) {
    setTimeout(checkPin, 120);
  }
}

function pinBackspace() {
  pinBuffer = pinBuffer.slice(0, -1);
  haptic('light');
  updatePinDots();
}

function updatePinDots() {
  for (let i = 0; i < 4; i++) {
    const d = document.getElementById('d' + i);
    d.classList.toggle('filled', i < pinBuffer.length);
    d.classList.remove('error');
  }
}

function checkPin() {
  if (pinBuffer === pinTarget.pin) {
    loginSuccess(pinTarget);
  } else {
    // Shake dots
    for (let i = 0; i < 4; i++) document.getElementById('d' + i).classList.add('error');
    setTimeout(() => { pinBuffer = ''; updatePinDots(); }, 800);
  }
}

function adminQuickLogin() {
  // Find admin by id first, then fall back to any admin role
  const admin = users.find(u => u.id === 'admin-1') || users.find(u => u.role === 'admin');
  if (!admin) { notify('No admin account found.', 'error'); return; }
  loginSuccess(admin);
}

function loginSuccess(user) {
  haptic('success');
  currentUser = user;
  detectAndApplyLayout();
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.body.classList.add('app-visible');
  // Hide the login-screen sync bar, keep header chip
  const loginBar = document.getElementById('login-sync-bar');
  if (loginBar) loginBar.style.visibility = 'hidden';
  // Header
  document.getElementById('chip-avatar').textContent = user.avatar;
  document.getElementById('chip-name').textContent = user.name;
  const roleEl = document.getElementById('chip-role');
  roleEl.textContent = user.role;
  roleEl.className = 'role-badge ' + user.role;
  // tab-add visible to all; tab-print + tab-admin admin-only
  const isAdmin = user.role === 'admin';
  document.getElementById('tab-add').style.display = '';
  ['tab-print','tab-admin'].forEach(id => {
    document.getElementById(id).style.display = isAdmin ? '' : 'none';
  });
  const btabAdd = document.getElementById('btab-add');
  if (btabAdd) btabAdd.style.display = '';
  ['btab-print','btab-admin'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = isAdmin ? '' : 'none';
  });
  showPage('home', document.querySelector('[data-page="home"]'));
  loadContainers();
  checkPendingScan();
}

function logOut() {
  currentUser = null;
  pinBuffer = '';
  pinTarget = null;
  stopScanner();
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-screen').style.display = '';
  document.body.classList.remove('app-visible');
  // Re-show login sync bar, hide header chip
  const loginBar = document.getElementById('login-sync-bar');
  if (loginBar && fbConfig) loginBar.style.visibility = 'visible';
  document.getElementById('pin-entry').style.display = 'none';
  document.getElementById('login-user-grid').style.display = 'grid';
  renderLoginScreen();
  notify('Signed out', 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name, tabEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.btab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (tabEl) tabEl.classList.add('active');
  const btab = document.getElementById('btab-' + name);
  if (btab) btab.classList.add('active');
  if (name === 'home')    renderHome();
  if (name === 'library') { renderStats(); renderLibrary(); populateFilters(); }
  if (name === 'history') { populateHistFilters(); renderHistory(); }
  if (name === 'add')     { refreshAddId(); populateFixTypeSelect('new-fixtype'); }
  if (name === 'containers') renderContainersPage();
  if (name === 'library') renderSavedFilters();
  if (name === 'admin') { renderUsageStats(); renderForceReturn(); renderAdminFixtures(); }
  if (name === 'print')   renderPrintPage();
  if (name === 'admin')   { renderUserList(); renderAdminFixtures(); renderForceReturn(); renderLocationPreview(); renderAdminTypes(); renderGsStatus(); }
  if (name === 'setup')   { renderSetupPage(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOME PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome() {
  const total  = fixtures.length;
  const out    = fixtures.filter(f => f.status === 'out').length;
  const avail  = total - out;
  const myOut  = fixtures.filter(f => f.checkedOutBy === currentUser?.id).length;

  document.getElementById('home-hero').innerHTML = `
    <div class="hero-stat green"><div class="hero-stat-label">Available</div><div class="hero-stat-val green">${avail}</div></div>
    <div class="hero-stat red"><div class="hero-stat-label">Checked Out</div><div class="hero-stat-val red">${out}</div></div>
    <div class="hero-stat accent"><div class="hero-stat-label">Total Fixtures</div><div class="hero-stat-val accent">${total}</div></div>
    <div class="hero-stat blue"><div class="hero-stat-label">My Checkouts</div><div class="hero-stat-val blue">${myOut}</div></div>
  `;

  // My checkouts strip
  const mine = fixtures.filter(f => f.checkedOutBy === currentUser?.id);
  const strip = document.getElementById('my-checkouts-strip');
  if (mine.length) {
    strip.innerHTML = `
      <div class="my-co-strip">
        <div class="my-co-strip-header">
          <div class="my-co-strip-title">ğŸ“¤ Your Checked Out Fixtures (${mine.length})</div>
          <button class="btn btn-danger btn-sm" onclick="showPage('library', document.querySelector('[data-page=library]'))">View All</button>
        </div>
        <div class="my-co-items">
          ${mine.map(f => `
            <div class="my-co-pill" onclick="openDetailModal('${f.id}')">
              <span class="pill-id">${f.id}</span>
              <span>${f.name}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  } else {
    strip.innerHTML = '';
  }

  // All checked out list
  const coList = fixtures.filter(f => f.status === 'out').sort((a,b) => new Date(b.checkedOutAt) - new Date(a.checkedOutAt));
  const coEl = document.getElementById('checked-out-list');
  if (!coList.length) {
    coEl.innerHTML = '<div class="empty-state"><div class="icon">âœ…</div><p>All fixtures are currently available.</p></div>';
  } else {
    coEl.innerHTML = coList.map(f => {
      const u = users.find(x => x.id === f.checkedOutBy);
      return `
        <div class="co-row" onclick="openDetailModal('${f.id}')">
          <div class="co-id">${f.id}</div>
          <div class="co-info">
            <div class="co-name">${f.name}</div>
            <div class="co-meta">${f.brand || ''} ${f.category ? 'Â· ' + f.category : ''} ${f.location ? 'Â· ğŸ“' + f.location : ''}</div>
          </div>
          ${u ? `<div class="co-user"><span class="avatar">${u.avatar}</span><span>${u.name}</span></div>` : ''}
          <div class="co-time">${timeAgo(f.checkedOutAt)}</div>
        </div>
      `;
    }).join('');
  }

  // Recent returns (last 5 return events)
  const returns = history.filter(h => h.action === 'return').slice(0, 5);
  const rrEl = document.getElementById('recent-returns');
  if (!returns.length) {
    rrEl.innerHTML = '<div style="color:var(--text3);font-size:13px;padding:12px 0;">No returns recorded yet.</div>';
  } else {
    rrEl.innerHTML = `<div class="table-wrap"><table>
      <thead><tr><th>Fixture</th><th>Returned By</th><th>When</th></tr></thead>
      <tbody>${returns.map(h => `
        <tr>
          <td><span class="mono">${h.fixtureId}</span> <span style="color:var(--text2);margin-left:8px;">${h.fixtureName}</span></td>
          <td>${h.userName}</td>
          <td style="color:var(--text3);font-family:'DM Mono',monospace;font-size:11px;">${new Date(h.ts).toLocaleString()}</td>
        </tr>
      `).join('')}</tbody>
    </table></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIBRARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats() {
  const total = fixtures.length;
  const out   = fixtures.filter(f => f.status === 'out').length;
  document.getElementById('stats-bar').innerHTML = `
    <div class="stat-card accent"><div class="stat-label">Total</div><div class="stat-value accent">${total}</div></div>
    <div class="stat-card green"><div class="stat-label">Available</div><div class="stat-value green">${total-out}</div></div>
    <div class="stat-card red"><div class="stat-label">Checked Out</div><div class="stat-value red">${out}</div></div>
    <div class="stat-card blue"><div class="stat-label">My Checkouts</div><div class="stat-value blue">${fixtures.filter(f=>f.checkedOutBy===currentUser?.id).length}</div></div>
  `;
}

function populateFilters() {
  // Merge fixtureTypes list + any category values already on fixtures
  const fromFixtures = [...new Set(fixtures.map(f => f.fixtureType || f.category).filter(Boolean))];
  const allTypes = [...new Set([...fixtureTypes, ...fromFixtures])].sort();
  const sel = document.getElementById('filter-category');
  const cur = sel.value;
  sel.innerHTML = '<option value="">All Types</option>' + allTypes.map(t => `<option value="${t}">${t}</option>`).join('');
  if (allTypes.includes(cur)) sel.value = cur;
}

function renderLibrary() {
  const q    = (document.getElementById('search-input').value||'').toLowerCase();
  const sf   = document.getElementById('filter-status').value;
  const cf   = document.getElementById('filter-category').value;
  let list = fixtures.filter(f => {
    const txt = [f.id,f.name,f.brand,f.category,f.fixtureType,f.finish,f.location].join(' ').toLowerCase();
    const typeMatch = !cf || f.fixtureType===cf || f.category===cf;
    return txt.includes(q) && (!sf || f.status===sf) && typeMatch;
  });
  list = sortFixtures(list);
  const grid = document.getElementById('fixture-grid');
  if (!list.length) { grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="icon">ğŸ”¦</div><p>No fixtures found.</p></div>'; return; }
  // Render immediately for fast paint â€” batch remaining on rAF
  const FIRST = 12;
  grid.innerHTML = list.slice(0, FIRST).map(f => fixtureCardHTML(f)).join('');
  if (list.length > FIRST) {
    requestAnimationFrame(() => {
      grid.innerHTML = list.map(f => fixtureCardHTML(f)).join('');
      if (bulkMode) {
        grid.classList.add('select-mode');
        bulkSelected.forEach(fid => {
          const card = grid.querySelector(`[data-fid="${fid}"]`);
          if (card) { card.classList.add('selected'); const ch = card.querySelector('.select-check'); if(ch) ch.textContent='âœ“'; }
        });
      }
    });
    return;
  }
  // Re-apply bulk selection state
  if (bulkMode) {
    grid.classList.add('select-mode');
    bulkSelected.forEach(fid => {
      const card = grid.querySelector(`[data-fid="${fid}"]`);
      if (card) { card.classList.add('selected'); const ch = card.querySelector('.select-check'); if(ch) ch.textContent='âœ“'; }
    });
  }
}

function fixtureCardHTML(f) {
  const u = f.checkedOutBy ? users.find(x=>x.id===f.checkedOutBy) : null;
  const isMe = f.checkedOutBy === currentUser?.id;
  const isAdmin = currentUser?.role === 'admin';
  return `
    <div class="fixture-card ${f.status}" data-fid="${f.id}" onclick="if(bulkMode){toggleCardSelect('${f.id}');}else{openDetailModal('${f.id}');}">
      <div class="card-top">
        <div class="fid">${f.id}</div>
        <div style="display:flex;align-items:center;gap:6px;">
          <div class="sbadge ${f.status==='available'?'available':'out'}">${f.status==='available'?'Available':'Out'}</div>
          <div class="select-check" id="check-${f.id}"></div>
        </div>
      </div>
      <div class="card-body">
        <div class="card-name">${f.name}</div>
        <div class="card-meta">
          ${f.partNo?`<span style='font-family:"DM Mono",monospace;font-size:10px;color:var(--text3);'>ğŸ”¢ ${f.partNo}</span>`:''}
          ${f.brand?`<span>ğŸ· ${f.brand}</span>`:''}
          ${(f.fixtureType||f.category)?`<span style="background:var(--surface3);border:1px solid var(--border2);border-radius:5px;padding:2px 7px;font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;">ğŸ”§ ${f.fixtureType||f.category}</span>`:''}
          ${f.wattage?`<span>âš¡ ${f.wattage}</span>`:''}
        </div>
        ${f.location?`<div class="card-loc">ğŸ“ ${f.location}</div>`:''}
        ${f.specSheet?`<a href="${f.specSheet}" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center;gap:4px;font-size:10px;color:var(--accent);text-decoration:none;margin-top:5px;opacity:0.8;">ğŸ“„ Spec Sheet â†—</a>`:''}
        ${u?`<div class="card-co-info">With <strong>${u.name}</strong> Â· ${timeAgo(f.checkedOutAt)}</div>`:''}
      </div>
      <div style="border-top:1px solid var(--border);">
        <div class="card-footer" onclick="event.stopPropagation()">
          ${f.status==='available'
            ? `<button class="btn btn-success" onclick="quickCheckout('${f.id}')">â†— Check Out</button>`
            : isMe
            ? `<button class="btn btn-danger" onclick="quickReturn('${f.id}')">â†™ Return</button>`
            : `<span style="display:flex;gap:5px;">
                 <button class="btn btn-warning btn-sm" onclick="swapOwnership('${f.id}');event.stopPropagation()">â‡„ Take Over</button>
                 <button class="btn btn-danger btn-sm" onclick="quickReturn('${f.id}');event.stopPropagation()">â†™ Return</button>
               </span>`}
          <button class="btn btn-secondary" onclick="openDetailModal('${f.id}');event.stopPropagation()">Details</button>
          <button class="btn btn-blue btn-sm" onclick="openEditFixture('${f.id}');event.stopPropagation()" title="Edit fixture">âœï¸</button>
        </div>
        <div onclick="event.stopPropagation()">
          <button onclick="toggleCardComments('${f.id}')" style="width:100%;background:none;border:none;border-top:1px solid var(--border);padding:12px 16px;text-align:left;font-size:14px;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:8px;font-family:'DM Sans',sans-serif;font-weight:500;">
            <span id="card-cmttoggle-${f.id}" style="font-size:12px;">â–¸</span>
            ğŸ’¬ Notes &amp; History
            <span style="font-size:13px;color:var(--text3);">(${(f.comments||[]).length})</span>
          </button>
          <div id="card-cmt-${f.id}" style="display:none;padding:12px 16px 14px;background:var(--surface2);border-top:1px solid var(--border);">
            <div style="display:flex;gap:8px;margin-bottom:12px;">
              <input class="form-input" id="card-cmt-input-${f.id}" placeholder="Add a comment..." style="flex:1;font-size:14px;padding:10px 12px;">
              <button class="btn btn-blue btn-sm" onclick="addCardComment('${f.id}')">Post</button>
            </div>
            <div id="card-cmt-list-${f.id}" style="max-height:320px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;font-size:14px;">
              ${buildCommentListHTML(f)}
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHECKOUT / RETURN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function quickCheckout(fid) {
  openCheckoutNote(fid);
}

async function quickReturn(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  const ts = new Date().toISOString();
  if (!f.comments) f.comments = [];
  f.comments.push({ ts, userId: currentUser.id, userName: currentUser.name, text: '', action: 'return' });
  f.status = 'available';
  f.checkedOutBy = null;
  f.checkedOutAt = null;
  const hret = logEvent(f, 'return');
  await saveData({ fixture: f, historyEntry: hret });
  refreshCurrentPage();
  notify(`âœ“ Returned: ${f.name}`, 'success');
}

async function swapOwnership(fid) {
  const f = fixtures.find(x => x.id === fid);
  if (!f || f.status !== 'out') return;
  const prev = users.find(x => x.id === f.checkedOutBy);
  const ts = new Date().toISOString();
  if (!f.comments) f.comments = [];
  f.comments.push({ ts, userId: currentUser.id, userName: currentUser.name, text: `taken from ${prev?.name||'unknown'}`, action: 'transfer' });
  f.checkedOutBy = currentUser.id;
  f.checkedOutAt = ts;
  const h = logEvent(f, 'transfer');
  await saveData({ fixture: f, historyEntry: h });
  refreshCurrentPage();
  notify(`â‡„ Taken over from ${prev?.name || 'previous user'}`, 'success');
}

function logEvent(f, action) {
  const entry = { ts: new Date().toISOString(), fixtureId: f.id, fixtureName: f.name, userId: currentUser.id, userName: currentUser.name, action };
  history.unshift(entry);
  return entry;
}

function refreshCurrentPage() {
  const active = document.querySelector('.page.active');
  if (!active) return;
  const id = active.id.replace('page-','');
  if (id==='home') renderHome();
  if (id==='library') { renderStats(); renderLibrary(); }
  if (id==='admin') { renderAdminFixtures(); renderForceReturn(); }
}

function buildCommentListHTML(f) {
  const entries = (f.comments||[]).slice().reverse().slice(0,10);
  if (!entries.length) return '<div style="font-size:11px;color:var(--text3);">No comments yet.</div>';
  return entries.map(c => {
    const icon = c.action==='checkout'?'â†—':c.action==='return'?'â†™':c.action==='transfer'?'â‡„':'ğŸ’¬';
    const clr  = c.action==='checkout'?'var(--red)':c.action==='return'?'var(--green)':'var(--text2)';
    return `<div style="font-size:14px;padding:7px 0;border-bottom:1px solid var(--border);"><span style="color:${clr};font-weight:600;">${icon} ${c.userName}</span> <span style="color:var(--text3);font-size:12px;">${timeAgo(c.ts)}</span>${c.text?` Â· <span style="color:var(--text2);">${c.text}</span>`:''}</div>`;
  }).join('');
}

function toggleCardComments(fid) {
  const panel  = document.getElementById('card-cmt-'+fid);
  const toggle = document.getElementById('card-cmttoggle-'+fid);
  if (!panel) return;
  const open = panel.style.display==='none';
  panel.style.display = open ? '' : 'none';
  if (toggle) toggle.textContent = open ? 'â–¾' : 'â–¸';
  if (open) {
    // Refresh comment list
    const f = fixtures.find(x=>x.id===fid);
    const listEl = document.getElementById('card-cmt-list-'+fid);
    if (f && listEl) listEl.innerHTML = buildCommentListHTML(f);
  }
}

async function addCardComment(fid) {
  const f   = fixtures.find(x=>x.id===fid);
  const inp = document.getElementById('card-cmt-input-'+fid);
  if (!f || !inp) return;
  const txt = inp.value.trim();
  if (!txt) return;
  if (!f.comments) f.comments = [];
  f.comments.push({ ts: new Date().toISOString(), userId: currentUser.id, userName: currentUser.name, text: txt, action: 'comment' });
  await saveData({ fixture: f });
  inp.value = '';
  const listEl = document.getElementById('card-cmt-list-'+fid);
  if (listEl) listEl.innerHTML = buildCommentListHTML(f);
  // Update count badge
  const btn = document.querySelector(`button[onclick="toggleCardComments('${fid}')"]`);
  if (btn) btn.querySelector('span:last-child').textContent = `(${f.comments.length})`;
  notify('Comment added', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetailModal(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  const u = f.checkedOutBy ? users.find(x=>x.id===f.checkedOutBy) : null;
  const isMe = f.checkedOutBy === currentUser?.id;
  const isAdmin = currentUser?.role === 'admin';
  document.getElementById('detail-body').innerHTML = `
    <div style="display:flex;gap:20px;flex-wrap:wrap;">
      <div style="flex:1;min-width:180px;">
        <div style="margin-bottom:10px;"><span class="fid">${f.id}</span> <span class="sbadge ${f.status==='available'?'available':'out'}" style="margin-left:8px;">${f.status==='available'?'Available':'Checked Out'}</span></div>
        <div style="font-size:18px;font-weight:700;margin-bottom:12px;">${f.name}</div>
        <table style="font-size:13px;border-collapse:collapse;">
          ${drow('Part #',f.partNo)}${drow('Brand',f.brand)}${drow('Fixture Type', f.fixtureType || f.category)}${drow('Wattage',f.wattage)}${drow('Finish',f.finish)}${drow('Location',f.location)}${drowCase('Case',f.containerId)}${drow('Notes',f.notes)}${drowLink('Spec Sheet',f.specSheet)}
          ${u?`<tr><td style="padding:5px 0;color:var(--text3);width:80px;">With</td><td style="padding:5px 0;color:var(--red);">${u.avatar} ${u.name} Â· ${timeAgo(f.checkedOutAt)}</td></tr>`:''}
        </table>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
        <div id="detail-qr-${f.id}" class="qr-print-block" style="padding:14px;"></div>
        <div style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;">${f.id}</div>
      </div>
    </div>
  `;
  document.getElementById('detail-footer').innerHTML = `
    <button class="btn btn-secondary" onclick="closeModal('detail-modal')">Close</button>
    <button class="btn btn-blue" onclick="closeModal('detail-modal');openEditFixture('${f.id}')">âœï¸ Edit</button>
    ${f.status==='available'
      ? `<button class="btn btn-success" onclick="quickCheckout('${f.id}');closeModal('detail-modal')">â†— Check Out</button>`
      : isMe
      ? `<button class="btn btn-danger" onclick="quickReturn('${f.id}');closeModal('detail-modal')">â†™ Return to Stock</button>`
      : `<span style="display:inline-flex;gap:8px;flex-wrap:wrap;">
           <button class="btn btn-warning" onclick="swapOwnership('${f.id}');closeModal('detail-modal')">â‡„ Take Over</button>
           <button class="btn btn-danger" onclick="quickReturn('${f.id}');closeModal('detail-modal')">â†™ Return to Stock</button>
         </span>`
    }
  `;
  openModal('detail-modal');
  setTimeout(() => {
    const el = document.getElementById('detail-qr-'+f.id);
    if (el && !el.querySelector('canvas')) {
      new QRCode(el, { text:fixtureUrl(f.id), width:138, height:138, colorDark:'#111', colorLight:'#fff', correctLevel:QRCode.CorrectLevel.H });
    }
  }, 60);
}

function drow(l,v) { return v ? `<tr><td style="padding:5px 0;color:var(--text3);width:80px;">${l}</td><td style="padding:5px 0;">${v}</td></tr>` : ''; }
function drowCase(l, cid) {
  if (!cid) return '';
  const c = containers.find(x => x.id === cid);
  if (!c) return '';
  return `<tr><td style="padding:5px 0;color:var(--text3);width:80px;">${l}</td><td style="padding:5px 0;"><span style="cursor:pointer;color:var(--blue);font-size:13px;" onclick="closeModal('detail-modal');setTimeout(()=>openContainerDetail('${cid}'),100);">ğŸ“¦ ${c.name}</span></td></tr>`;
}
function drowLink(l,v) { return v ? `<tr><td style="padding:5px 0;color:var(--text3);width:80px;">${l}</td><td style="padding:5px 0;"><a href="${v}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:5px;font-size:13px;">ğŸ“„ View Spec Sheet <span style="font-size:10px;opacity:0.7;">â†—</span></a></td></tr>` : ''; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateHistFilters() {
  const sel = document.getElementById('hist-user-filter');
  sel.innerHTML = '<option value="">All Users</option>' + users.map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
}

function renderHistory() {
  const uf = document.getElementById('hist-user-filter').value;
  const tf = document.getElementById('hist-type-filter').value;
  const list = history.filter(h => (!uf||h.userId===uf) && (!tf||h.action===tf));
  const tbody = document.getElementById('history-tbody');
  if (!list.length) { tbody.innerHTML=`<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text3);">No records found.</td></tr>`; return; }
  const actionColors = { checkout:'out', return:'available', added:'available', deleted:'out', edited:'available', transfer:'out' };
  tbody.innerHTML = list.map(h=>`
    <tr>
      <td style="white-space:nowrap;">
        <div style="font-size:13px;color:var(--text2);">${new Date(h.ts).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}</div>
        <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:1px;">${new Date(h.ts).toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}</div>
      </td>
      <td class="mono">${h.fixtureId}</td>
      <td>${h.fixtureName}</td>
      <td>${h.userName}</td>
      <td><span class="sbadge ${actionColors[h.action]||'available'}">${h.action}</span></td>
    </tr>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD FIXTURE (admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genId() { return 'FL-' + String(fixtureCounter).padStart(4,'0'); }

function refreshAddId() {
  document.getElementById('new-fixture-id').value = genId();
  document.getElementById('new-qr-section').style.display = 'none';
}

async function addFixture() {
  const name = document.getElementById('new-name').value.trim();
  if (!name) { notify('Fixture name is required.','error'); return; }
  const f = {
    id: genId(), name,
    brand:        document.getElementById('new-brand').value.trim(),
    partNo:       document.getElementById('new-partno').value.trim(),
    dateReceived: document.getElementById('new-datereceived').value,
    wattage:      document.getElementById('new-wattage').value.trim(),
    voltage:      document.getElementById('new-voltage').value.trim(),
    location:     document.getElementById('new-location').value.trim(),
    specSheet:    document.getElementById('new-specsheet').value.trim(),
    fixtureType:   document.getElementById('new-fixtype').value.trim(),
    outputWattage: document.getElementById('new-fixtype').value==='Power Supply'||document.getElementById('new-fixtype').value==='Driver'||document.getElementById('new-fixtype').value==='Transformer' ? document.getElementById('new-output-wattage').value.trim() : '',
    category: '', finish: '', notes: '', comments: [],
    status: 'available', checkedOutBy: null, checkedOutAt: null,
  };
  fixtures.push(f);
  fixtureCounter++;
  const hadd = logEvent(f, 'added');
  await saveData({ fixture: f, historyEntry: hadd, counter: true });
  populateFilters();
  notify(`âœ“ Added ${f.id}: ${f.name}`, 'success');
  // Show QR
  document.getElementById('new-qr-section').style.display = 'block';
  document.getElementById('new-qr-id-text').textContent = f.id;
  document.getElementById('new-qr-name-text').textContent = f.name;
  const qrEl = document.getElementById('new-qr-code');
  qrEl.innerHTML = '';
  new QRCode(qrEl, { text:fixtureUrl(f.id), width:188, height:188, colorDark:'#111', colorLight:'#fff', correctLevel:QRCode.CorrectLevel.H });
  // Reset form
  ['new-name','new-brand','new-partno','new-wattage','new-voltage','new-location','new-specsheet','new-output-wattage'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('new-fixtype').value='';
  document.getElementById('new-output-wattage-row').style.display='none';
  document.getElementById('new-datereceived').value='';
  document.getElementById('new-fixture-id').value = genId();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRINT PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPrintPage() {
  const grid = document.getElementById('print-grid');
  grid.innerHTML = fixtures.map(f=>`
    <div class="print-card" id="pcard-${f.id}" onclick="printSelectMode ? togglePrintCard('${f.id}') : null">
      <div class="pcheck no-print" id="pcheck-${f.id}"></div>
      <div class="pqr-wrap" id="pqr-${f.id}"></div>
      <div class="pid">${f.id}</div>
      <div class="pname">${f.name}</div>
      <div class="pbrand">${[f.partNo,f.brand,f.fixtureType||f.category].filter(Boolean).join(' Â· ')}</div>
      <button class="print-card-btn no-print" onclick="event.stopPropagation();printSingleQR('${f.id}')">ğŸ–¨ Print</button>
      <button class="print-card-btn no-print" onclick="event.stopPropagation();copyQRLink('fixture','${f.id}')" title="Copy QR link" style="font-size:11px;padding:4px 6px;">ğŸ”— Copy</button>
    </div>
  `).join('');
  fixtures.forEach(f=>{
    setTimeout(()=>{
      const el = document.getElementById('pqr-'+f.id);
      if (el && !el.querySelector('canvas')) {
        new QRCode(el,{text:fixtureUrl(f.id),width:60,height:60,colorDark:'#111',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.H});
      }
    },50);
  });
}

function printSingleQR(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  const tmp = document.createElement('div');
  document.body.appendChild(tmp);
  new QRCode(tmp, { text: fixtureUrl(f.id), width: 150, height: 150, colorDark: '#000', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
  setTimeout(() => {
    const canvas = tmp.querySelector('canvas');
    const imgSrc = canvas ? canvas.toDataURL() : '';
    document.body.removeChild(tmp);
    const info = [f.partNo, f.brand].filter(Boolean).join(' Â· ');
    // Create a print overlay in the same window so iOS can return after printing
    const overlay = document.createElement('div');
    overlay.id = 'print-single-overlay';
    overlay.style.cssText = 'display:none;position:fixed;inset:0;background:#fff;z-index:9999;flex-direction:column;align-items:center;justify-content:center;font-family:Arial,sans-serif;';
    const sEl = document.createElement('style');
    sEl.textContent = [
      '#print-single-overlay{display:flex!important;flex-direction:column;align-items:center;justify-content:center;}',
      '.pso-qr{width:0.625in;height:0.625in;display:block;margin:0 auto;}',
      '.pso-id{font-size:6pt;font-family:monospace;color:#444;margin-top:3pt;text-align:center;}',
      '.pso-name{font-size:6pt;font-weight:bold;color:#111;margin-top:1pt;text-align:center;}',
      '.pso-info{font-size:5pt;color:#777;margin-top:1pt;text-align:center;}',
      '@media print{body > *:not(#print-single-overlay){display:none!important;}#pso-back{display:none!important;}}',
      '#pso-back{position:fixed;top:16px;left:16px;padding:8px 16px;background:#111;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;z-index:10000;}'
    ].join(' ');
    overlay.appendChild(sEl);
    const bk = document.createElement('button'); bk.id = 'pso-back'; bk.textContent = '\u2190 Back'; bk.onclick = () => overlay.remove(); overlay.appendChild(bk);
    if (imgSrc) { const img = document.createElement('img'); img.className = 'pso-qr'; img.src = imgSrc; overlay.appendChild(img); }
    const idDiv = document.createElement('div'); idDiv.className = 'pso-id'; idDiv.textContent = f.id; overlay.appendChild(idDiv);
    const nmDiv = document.createElement('div'); nmDiv.className = 'pso-name'; nmDiv.textContent = f.name; overlay.appendChild(nmDiv);
    if (info) { const inDiv = document.createElement('div'); inDiv.className = 'pso-info'; inDiv.textContent = info; overlay.appendChild(inDiv); }
    overlay.style.display = 'flex';
    document.body.appendChild(overlay);
    // Remove overlay after printing
    window.addEventListener('afterprint', () => {
      const el = document.getElementById('print-single-overlay');
      if (el) el.remove();
    }, { once: true });
    setTimeout(() => window.print(), 150);
  }, 250);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN â€” USER MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedAv = 'ğŸ’¡';

function renderUserList() {
  const el = document.getElementById('user-list');
  el.innerHTML = users.map(u=>`
    <div class="user-row">
      <div class="ur-avatar">${u.avatar}</div>
      <div class="ur-info">
        <div class="ur-name">${u.name} <span class="role-badge ${u.role}" style="margin-left:6px;">${u.role}</span></div>
        <div class="ur-pin">PIN: ${'â€¢'.repeat(u.pin.length)} &nbsp;|&nbsp; ID: ${u.id}</div>
      </div>
      <div class="ur-actions">
        <button class="btn btn-blue btn-sm" onclick="openEditUser('${u.id}')">Edit</button>
        ${u.id !== currentUser?.id ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">Delete</button>` : `<span style="font-size:11px;color:var(--text3);padding:0 8px;">(you)</span>`}
      </div>
    </div>
  `).join('');
}

function openAddUserModal() {
  document.getElementById('nu-name').value = '';
  document.getElementById('nu-pin').value = '';
  document.getElementById('nu-role').value = 'user';
  selectedAv = 'ğŸ’¡';
  document.querySelectorAll('.av-opt').forEach((el,i) => { el.style.border = i===0?'2px solid var(--accent)':'2px solid transparent'; });
  openModal('add-user-modal');
}

function pickAvatar(el) {
  document.querySelectorAll('.av-opt').forEach(a=>a.style.border='2px solid transparent');
  el.style.border = '2px solid var(--accent)';
  selectedAv = el.textContent;
}

async function addUser() {
  const name = document.getElementById('nu-name').value.trim();
  const pin  = document.getElementById('nu-pin').value.trim();
  const role = document.getElementById('nu-role').value;
  if (!name) { notify('Name required','error'); return; }
  if (!/^\d{4}$/.test(pin)) { notify('PIN must be exactly 4 digits','error'); return; }
  const newUser = { id:'u'+Date.now(), name, pin, role, avatar: selectedAv };
  users.push(newUser);
  await saveData({ user: newUser });
  closeModal('add-user-modal');
  renderUserList();
  renderLoginScreen();
  notify('User added!', 'success');
}

function openEditUser(uid) {
  const u = users.find(x=>x.id===uid);
  if (!u) return;
  document.getElementById('eu-id').value   = u.id;
  document.getElementById('eu-name').value = u.name;
  document.getElementById('eu-pin').value  = '';
  document.getElementById('eu-role').value = u.role;
  openModal('edit-user-modal');
}

async function saveEditUser() {
  const uid  = document.getElementById('eu-id').value;
  const name = document.getElementById('eu-name').value.trim();
  const pin  = document.getElementById('eu-pin').value.trim();
  const role = document.getElementById('eu-role').value;
  if (!name) { notify('Name required','error'); return; }
  if (pin && !/^\d{4}$/.test(pin)) { notify('PIN must be 4 digits','error'); return; }
  const u = users.find(x=>x.id===uid);
  if (!u) return;
  u.name = name;
  u.role = role;
  if (pin) u.pin = pin;
  u.avatar = selectedEditAv || u.avatar || 'ğŸ’¡';
  await saveData({ user: u });
  closeModal('edit-user-modal');
  renderUserList();
  renderLoginScreen();
  notify('User updated!','success');
}

async function deleteUser(uid) {
  const u = users.find(x=>x.id===uid);
  if (!u) return;
  if (!confirm(`Delete user "${u.name}"? This cannot be undone.`)) return;
  users = users.filter(x=>x.id!==uid);
  await saveData({ deletedUserId: uid });
  renderUserList();
  renderLoginScreen();
  notify('User deleted.','info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN â€” FIXTURE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdminFixtures() {
  const q = (document.getElementById('admin-search').value||'').toLowerCase();
  const list = fixtures.filter(f=>[f.id,f.name,f.brand,f.category].join(' ').toLowerCase().includes(q));
  const tbody = document.getElementById('admin-fixture-tbody');
  if (!list.length) { tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text3);">No fixtures.</td></tr>`; return; }
  tbody.innerHTML = list.map(f=>`
    <tr>
      <td class="mono">${f.id}</td>
      <td>${f.name}</td>
      <td style="color:var(--text2);">${f.brand||'â€”'}</td>
      <td style="color:var(--text2);font-size:11px;font-family:'DM Mono',monospace;">${f.location||'â€”'}</td>
      <td><span class="sbadge ${f.status==='available'?'available':'out'}">${f.status==='available'?'Available':'Out'}</span></td>
      <td style="white-space:nowrap;">
        <button class="btn btn-secondary btn-sm" onclick="copyQRLink('fixture','${f.id}')" title="Copy QR link">ğŸ”—</button>
        <button class="btn btn-blue btn-sm" onclick="openEditFixture('${f.id}')">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteFixture('${f.id}')">Delete</button>
      </td>
    </tr>
  `).join('');
}

async function deleteFixture(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  if (f.status==='out') { notify('Return fixture before deleting.','error'); return; }
  if (!confirm(`Delete "${f.name}" (${f.id})? This cannot be undone.`)) return;
  fixtures = fixtures.filter(x=>x.id!==fid);
  const hdel = logEvent(f,'deleted');
  await saveData({ deletedFixtureId: fid, historyEntry: hdel });
  renderAdminFixtures();
  notify(`Deleted ${f.id}`,'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN â€” FORCE RETURN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderForceReturn() {
  const coList = fixtures.filter(f=>f.status==='out');
  const el = document.getElementById('force-return-list');
  if (!coList.length) { el.innerHTML='<div style="color:var(--text3);font-size:13px;">Nothing currently checked out.</div>'; return; }
  el.innerHTML = coList.map(f=>{
    const u = users.find(x=>x.id===f.checkedOutBy);
    return `
      <div class="user-row" style="margin-bottom:8px;">
        <div style="flex:1;">
          <span class="fid">${f.id}</span>
          <span style="margin-left:10px;font-weight:500;">${f.name}</span>
          <span style="margin-left:10px;font-size:12px;color:var(--text2);">${u?u.avatar+' '+u.name:'Unknown'}</span>
          <span style="margin-left:8px;font-size:11px;color:var(--text3);">${timeAgo(f.checkedOutAt)}</span>
        </div>
        <button class="btn btn-danger btn-sm" onclick="forceReturn('${f.id}')">Force Return</button>
      </div>
    `;
  }).join('');
}

async function forceReturn(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  f.status = 'available';
  f.checkedOutBy = null;
  f.checkedOutAt = null;
  const hfr = logEvent(f,'return');
  await saveData({ fixture: f, historyEntry: hfr });
  renderForceReturn();
  renderAdminFixtures();
  notify(`Force returned: ${f.name}`,'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QR SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openScanModal() {
  openModal('scan-modal');
  // Reset state
  document.getElementById('scan-result').style.display = 'none';
  document.getElementById('scan-processing').style.display = 'none';
  document.getElementById('scan-camera-prompt').style.display = 'block';
  document.getElementById('manual-id-input').value = '';
  // Clear the file input so the same photo can be rescanned
  const inp = document.getElementById('qr-camera-input');
  if (inp) inp.value = '';
}

function closeScanModal() {
  closeModal('scan-modal');
}

function triggerNativeCamera() {
  // Programmatically click the hidden file input â€” opens native camera on iOS/Android
  const inp = document.getElementById('qr-camera-input');
  if (inp) { inp.value = ''; inp.click(); }
}

async function handleCameraCapture(input) {
  const file = input.files && input.files[0];
  if (!file) return;

  document.getElementById('scan-camera-prompt').style.display = 'none';
  document.getElementById('scan-processing').style.display = 'block';
  document.getElementById('scan-result').style.display = 'none';

  try {
    // Decode the image with jsQR
    const bitmap = await createImageBitmap(file);
    const canvas = document.createElement('canvas');
    // Scale down large photos for speed â€” jsQR works fine at 1024px
    const MAX = 1024;
    const scale = Math.min(1, MAX / Math.max(bitmap.width, bitmap.height));
    canvas.width  = Math.round(bitmap.width  * scale);
    canvas.height = Math.round(bitmap.height * scale);
    const ctx = canvas.getContext('2d');
    ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'dontInvert' });

    document.getElementById('scan-processing').style.display = 'none';

    if (code) {
      haptic('success');
      processScannedId(code.data);
    } else {
      // Try again with inverted colours (some dark-background QR codes)
      const code2 = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'onlyInvert' });
      if (code2) {
        haptic('success');
        processScannedId(code2.data);
      } else {
        haptic('error');
        document.getElementById('scan-camera-prompt').style.display = 'block';
        const el = document.getElementById('scan-result');
        el.style.display = 'block';
        el.innerHTML = `<div style="color:var(--red);font-size:13px;">âŒ No QR code detected. Try again with better lighting or hold the camera steady.</div>
          <button class="btn btn-secondary btn-sm" style="margin-top:10px;" onclick="triggerNativeCamera()">Try Again</button>`;
      }
    }
  } catch(e) {
    document.getElementById('scan-processing').style.display = 'none';
    document.getElementById('scan-camera-prompt').style.display = 'block';
    const el = document.getElementById('scan-result');
    el.style.display = 'block';
    el.innerHTML = `<div style="color:var(--red);font-size:13px;">âŒ Could not read image. Please try again.</div>`;
  }
  // Reset input so the same file can be re-selected
  input.value = '';
}

function stopScanner() { /* no-op â€” kept for any legacy callers */ }


function processManualId() {
  const id = document.getElementById('manual-id-input').value.trim().toUpperCase();
  if (!id) return;
  processScannedId(id);
}

function processScannedId(raw) {
  // If a full URL was scanned, extract the fixture or box ID from it
  let id = raw.trim();
  try {
    const url = new URL(id);
    const fParam = url.searchParams.get('f');
    const boxParam = url.searchParams.get('box');
    if (fParam) { id = decodeURIComponent(fParam); }
    else if (boxParam) {
      // Case QR scanned inside app â€” show case detail
      closeScanModal();
      const cid = decodeURIComponent(boxParam);
      const c = containers.find(x => x.id === cid);
      if (c) { showPage('containers', document.getElementById('btab-containers') || document.getElementById('tab-containers')); setTimeout(() => openContainerDetail(cid), 200); }
      else { notify('Case not found: ' + cid, 'error'); }
      return;
    }
  } catch(e) { /* not a URL, treat as raw ID */ }
  const f = fixtures.find(x=>x.id===id);
  const el = document.getElementById('scan-result');
  el.style.display = 'block';
  if (!f) { el.innerHTML=`<div style="color:var(--red);">âŒ Fixture "${id}" not found.</div>`; return; }
  const u = f.checkedOutBy ? users.find(x=>x.id===f.checkedOutBy) : null;
  const isMe = f.checkedOutBy === currentUser?.id;
  const isAdmin = currentUser?.role === 'admin';
  el.innerHTML = `
    <div style="margin-bottom:12px;">
      <span class="fid">${f.id}</span>
      <div style="font-size:15px;font-weight:600;margin-top:6px;">${f.name}</div>
      <div style="font-size:12px;color:var(--text2);margin-top:2px;">${f.brand||''} ${f.category||''}</div>
      <div style="margin-top:8px;">
        <span class="sbadge ${f.status==='available'?'available':'out'}">${f.status==='available'?'Available':'Checked Out'}</span>
        ${u?`<span style="font-size:12px;color:var(--text2);margin-left:8px;">${u.avatar} ${u.name}</span>`:''}
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      ${f.status==='available'
        ? `<button class="btn btn-success" onclick="quickCheckout('${f.id}');closeScanModal();">â†— Check Out</button>`
        : isMe
        ? `<button class="btn btn-danger" onclick="quickReturn('${f.id}');closeScanModal();">â†™ Return to Stock</button>`
        : `<span style="display:inline-flex;gap:8px;flex-wrap:wrap;">
             <button class="btn btn-warning" onclick="swapOwnership('${f.id}');closeScanModal();">â‡„ Take Over</button>
             <button class="btn btn-danger" onclick="quickReturn('${f.id}');closeScanModal();">â†™ Return to Stock</button>
           </span>`}
      <button class="btn btn-secondary" onclick="closeScanModal();openDetailModal('${f.id}')">Details</button>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT FIXTURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEditFixture(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if (!f) return;
  document.getElementById('ef-id').value           = f.id;
  document.getElementById('ef-fid').value          = f.id;
  document.getElementById('ef-name').value         = f.name;
  document.getElementById('ef-brand').value        = f.brand        || '';
  document.getElementById('ef-partno').value       = f.partNo       || '';
  document.getElementById('ef-datereceived').value = f.dateReceived || '';
  document.getElementById('ef-wattage').value      = f.wattage      || '';
  document.getElementById('ef-voltage').value      = f.voltage      || '';
  document.getElementById('ef-location').value     = f.location     || '';
  document.getElementById('ef-specsheet').value    = f.specSheet    || '';
  populateFixTypeSelect('ef-fixtype');
  const eft = document.getElementById('ef-fixtype');
  if (eft) eft.value = f.fixtureType || '';
  onFixTypeChange('ef-fixtype','ef-output-wattage-row');
  document.getElementById('ef-output-wattage').value = f.outputWattage || '';

  // Last checked out box
  const lcBox  = document.getElementById('ef-lastco-box');
  const lcInfo = document.getElementById('ef-lastco-info');
  const lastCO = (f.comments||[]).filter(c=>c.action==='checkout').slice(-1)[0];
  if (lastCO) {
    const u = users.find(x=>x.id===lastCO.userId);
    lcBox.style.display = '';
    lcInfo.innerHTML = `${u ? u.avatar + ' ' + u.name : lastCO.userName} &nbsp;Â·&nbsp; <span style="color:var(--text3)">${new Date(lastCO.ts).toLocaleString()}</span>`;
  } else if (f.checkedOutBy) {
    const u = users.find(x=>x.id===f.checkedOutBy);
    lcBox.style.display = '';
    lcInfo.innerHTML = `${u ? u.avatar + ' ' + u.name : 'Unknown'} &nbsp;Â·&nbsp; <span style="color:var(--red)">Currently out</span> Â· ${timeAgo(f.checkedOutAt)}`;
  } else {
    lcBox.style.display = 'none';
  }

  // Comments + checkout history
  renderFixtureComments(f);
  document.getElementById('ef-new-comment').value = '';
  openModal('edit-fixture-modal');
  // Re-set fixtureType and container after modal is visible
  setTimeout(() => {
    populateFixTypeSelect('ef-fixtype');
    populateContainerSelect();
    const eft = document.getElementById('ef-fixtype');
    if (eft) {
      eft.value = f.fixtureType || '';
      onFixTypeChange('ef-fixtype','ef-output-wattage-row');
      document.getElementById('ef-output-wattage').value = f.outputWattage || '';
    }
    const csel = document.getElementById('ef-container');
    if (csel) csel.value = f.containerId || '';
  }, 0);
}

function renderFixtureComments(f) {
  const list = document.getElementById('ef-comment-list');
  const countEl = document.getElementById('ef-comments-count');
  const allEntries = (f.comments||[]).slice().reverse();
  countEl.textContent = allEntries.length ? `(${allEntries.length})` : '';
  if (!allEntries.length) {
    list.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:8px 0;">No comments yet.</div>';
    return;
  }
  list.innerHTML = allEntries.map(c => {
    const isCheckout = c.action==='checkout' || c.action==='return' || c.action==='transfer';
    const bg = isCheckout ? 'var(--surface2)' : 'var(--surface)';
    const borderColor = c.action==='checkout' ? 'rgba(248,113,113,0.2)' : c.action==='return' ? 'rgba(74,222,128,0.2)' : 'var(--border)';
    const icon = c.action==='checkout' ? 'â†—' : c.action==='return' ? 'â†™' : c.action==='transfer' ? 'â‡„' : 'ğŸ’¬';
    return `<div style="background:${bg};border:1px solid ${borderColor};border-radius:6px;padding:8px 10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">
        <span style="font-size:11px;font-weight:600;color:var(--text);">${icon} ${c.userName}</span>
        <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">${new Date(c.ts).toLocaleDateString()} ${new Date(c.ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
      </div>
      ${c.text ? `<div style="font-size:12px;color:var(--text2);">${c.text}</div>` : ''}
      ${isCheckout ? `<div style="font-size:10px;color:var(--text3);margin-top:2px;">${c.action}</div>` : ''}
    </div>`;
  }).join('');
}

async function addFixtureComment() {
  const fid = document.getElementById('ef-id').value;
  const f   = fixtures.find(x=>x.id===fid);
  const txt = document.getElementById('ef-new-comment').value.trim();
  if (!f || !txt) return;
  if (!f.comments) f.comments = [];
  const entry = { ts: new Date().toISOString(), userId: currentUser.id, userName: currentUser.name, text: txt, action: 'comment' };
  f.comments.push(entry);
  await saveData({ fixture: f });
  document.getElementById('ef-new-comment').value = '';
  renderFixtureComments(f);
  notify('Comment added', 'success');
}

async function saveEditFixture() {
  const fid = document.getElementById('ef-id').value;
  const f   = fixtures.find(x=>x.id===fid);
  if (!f) return;
  const name = document.getElementById('ef-name').value.trim();
  if (!name) { notify('Fixture name is required.','error'); return; }
  f.name         = name;
  f.brand        = document.getElementById('ef-brand').value.trim();
  f.partNo       = document.getElementById('ef-partno').value.trim();
  f.dateReceived = document.getElementById('ef-datereceived').value;
  f.wattage      = document.getElementById('ef-wattage').value.trim();
  f.voltage      = document.getElementById('ef-voltage').value.trim();
  f.location     = document.getElementById('ef-location').value.trim();
  f.specSheet    = document.getElementById('ef-specsheet').value.trim();
  f.fixtureType  = document.getElementById('ef-fixtype').value.trim();
  const isPSType = ['Power Supply','Driver','Transformer'].includes(f.fixtureType);
  f.outputWattage = isPSType ? document.getElementById('ef-output-wattage').value.trim() : '';
  f.containerId = document.getElementById('ef-container') ? document.getElementById('ef-container').value : (f.containerId || null);
  if (f.location && !locations.includes(f.location)) {
    locations.push(f.location);
    locations.sort();
  }
  const hedit = logEvent(f,'edited');
  await saveData({ fixture: f, historyEntry: hedit });
  closeModal('edit-fixture-modal');
  refreshCurrentPage();
  populateFilters();
  notify(`âœ“ Updated: ${f.name}`,'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKUP & RESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmClearHistory() {
  document.getElementById('clear-history-confirm').style.display = 'block';
}
async function clearHistory() {
  history = [];
  await storeSet(KEY_HISTORY, JSON.stringify([]));
  if (fbDb) {
    try {
      await fbDb.ref('lumasamples/history').remove();
      notify('âœ“ History cleared from Firebase + local storage', 'success');
    } catch(e) {
      notify('âœ“ Local history cleared (Firebase error: ' + e.message + ')', 'info');
    }
  } else {
    notify('âœ“ Transaction history cleared', 'success');
  }
  document.getElementById('clear-history-confirm').style.display = 'none';
  if (typeof renderHistory === 'function') renderHistory();
}

function exportBackup() {
  const data = {
    version: 2,
    exportedAt: new Date().toISOString(),
    fixtures, users, history, locations, fixtureTypes, fixtureCounter,
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `lumasamples-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  notify('Backup downloaded', 'success');
}

async function importBackup(input) {
  const file = input.files[0];
  if (!file) return;
  const statusEl = document.getElementById('backup-status');
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    if (!data.fixtures || !data.users) throw new Error('Invalid backup file â€” missing fixtures or users');
    // Confirm overwrite
    if (!confirm(`Restore backup from ${data.exportedAt ? new Date(data.exportedAt).toLocaleString() : 'unknown date'}?

This will REPLACE all current data. Make sure you have a current backup first.`)) {
      input.value = ''; return;
    }
    fixtures  = (data.fixtures  || []).map(normalizeFixture);
    users     = (data.users     || []).map(normalizeUser);
    history   = data.history   || [];
    locations    = data.locations    || DEFAULT_LOCATIONS;
    fixtureTypes = data.fixtureTypes || DEFAULT_FIX_TYPES;
    if (data.fixtureCounter) fixtureCounter = data.fixtureCounter;
    ensureAdmin();
    bumpCounter();
    await saveData({ counter: true });
    // Push to Firebase if connected
    if (fbDb) await fbPushAll();
    debounce('fb-refresh', refreshCurrentPage, 300)();
    renderLoginScreen();
    populateFilters();
    statusEl.style.display = '';
    statusEl.style.color = 'var(--green)';
    statusEl.textContent = `âœ“ Restored ${fixtures.length} fixtures, ${users.length} users from backup.`;
    notify('Database restored from backup!', 'success');
  } catch(e) {
    statusEl.style.display = '';
    statusEl.style.color = 'var(--red)';
    statusEl.textContent = 'âš  Restore failed: ' + e.message;
    notify('Restore failed: ' + e.message, 'error');
  }
  input.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCATION COMBO DROPDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLocDropdown(inputId, dropId) {
  filterLocDropdown(inputId, dropId);
  document.getElementById(dropId).style.display = 'block';
}

function hideLocDropdown(dropId) {
  const el = document.getElementById(dropId);
  if (el) el.style.display = 'none';
}

function filterLocDropdown(inputId, dropId) {
  const q   = (document.getElementById(inputId).value||'').toLowerCase();
  const drop = document.getElementById(dropId);
  if (!drop) return;
  const filtered = locations.filter(l => l.toLowerCase().includes(q));
  const showAdd  = q && !locations.some(l=>l.toLowerCase()===q);
  drop.innerHTML = filtered.map(l =>
    `<div class="loc-option" onmousedown="pickLocation('${inputId}','${dropId}','${l.replace(/'/g,"\'")}')">ğŸ“ ${l}</div>`
  ).join('') + (showAdd ? `<div class="loc-option add-new" onmousedown="addAndPickLocation('${inputId}','${dropId}')">ï¼‹ Add "${document.getElementById(inputId).value}"</div>` : '');
  drop.style.display = 'block';
}

function pickLocation(inputId, dropId, val) {
  document.getElementById(inputId).value = val;
  hideLocDropdown(dropId);
}

async function addAndPickLocation(inputId, dropId) {
  const val = document.getElementById(inputId).value.trim();
  if (!val || locations.includes(val)) return;
  locations.push(val);
  locations.sort();
  await saveData({ location: val });
  hideLocDropdown(dropId);
  renderLocationPreview();
  notify(`Location "${val}" added`,'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCATION MANAGEMENT (admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLocationsModal() {
  renderLocationsList();
  openModal('locations-modal');
}

function renderLocationsList() {
  const el = document.getElementById('locations-list');
  if (!el) return;
  el.innerHTML = locations.map((l,i) => `
    <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);">
      <span style="flex:1;font-size:13px;">ğŸ“ ${l}</span>
      <button class="btn btn-danger btn-sm" onclick="removeLocation(${i})">Remove</button>
    </div>
  `).join('');
}

async function addLocation() {
  const val = document.getElementById('new-location-input').value.trim();
  if (!val) return;
  if (locations.includes(val)) { notify('Already exists','error'); return; }
  locations.push(val);
  locations.sort();
  document.getElementById('new-location-input').value = '';
  await saveData({ location: val });
  renderLocationsList();
  renderLocationPreview();
  notify(`âœ“ Added location: ${val}`,'success');
}

async function removeLocation(idx) {
  const removed = locations[idx];
  locations.splice(idx,1);
  await saveData({ deletedLocation: removed });
  renderLocationsList();
  renderLocationPreview();
}

function renderLocationPreview() {
  const el = document.getElementById('location-preview');
  if (!el) return;
  el.innerHTML = locations.map(l =>
    `<span style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 10px;font-size:11px;font-family:'DM Mono',monospace;color:var(--text2);">ğŸ“ ${l}</span>`
  ).join('');
}
function renderAdminTypes() {
  const el = document.getElementById('admin-types-list');
  if (!el) return;
  const q = (document.getElementById('admin-type-search')?.value||'').toLowerCase();
  const list = fixtureTypes.filter(t => t.toLowerCase().includes(q));
  if (!list.length) { el.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:8px 0;">No types found.</div>'; return; }
  el.innerHTML = list.map((t, i) => `
    <div style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);">
      <span style="flex:1;font-size:13px;color:var(--text2);">ğŸ”§ ${t}</span>
      <button class="btn btn-danger btn-sm" style="padding:4px 10px;font-size:11px;" onclick="adminRemoveFixtureType(${fixtureTypes.indexOf(t)})">Remove</button>
    </div>
  `).join('');
}
function addFixtureTypeInline() {
  const row = document.getElementById('admin-type-add-row');
  if (row) { row.style.display = ''; document.getElementById('admin-new-type-input')?.focus(); }
}
async function adminAddFixtureType() {
  const val = (document.getElementById('admin-new-type-input')?.value||'').trim();
  if (!val) return;
  if (fixtureTypes.includes(val)) { notify('Already exists','error'); return; }
  fixtureTypes.push(val); fixtureTypes.sort();
  document.getElementById('admin-new-type-input').value = '';
  document.getElementById('admin-type-add-row').style.display = 'none';
  await storeSet(KEY_FIX_TYPES, JSON.stringify(fixtureTypes));
  if (fbDb) { try { await fbSet('lumasamples/fixtureTypes', Object.fromEntries(fixtureTypes.map((t,i)=>[t.replace(/[.#$[\] ]/g,'_')||'t'+i,t]))); } catch(e){} }
  renderAdminTypes(); populateFilters();
  notify(`âœ“ Added type: ${val}`, 'success');
}
async function adminRemoveFixtureType(idx) {
  fixtureTypes.splice(idx, 1);
  await storeSet(KEY_FIX_TYPES, JSON.stringify(fixtureTypes));
  if (fbDb) { try { await fbSet('lumasamples/fixtureTypes', Object.fromEntries(fixtureTypes.map((t,i)=>[t.replace(/[.#$[\] ]/g,'_')||'t'+i,t]))); } catch(e){} }
  renderAdminTypes(); populateFilters();
}

// â”€â”€ Fixture Types â”€â”€
function openFixtureTypesModal() {
  renderFixtypesList();
  openModal('fixtypes-modal');
}
function renderFixtypesList() {
  const el = document.getElementById('fixtypes-list');
  if (!el) return;
  el.innerHTML = fixtureTypes.map((t,i) => `
    <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);">
      <span style="flex:1;font-size:13px;">ğŸ”§ ${t}</span>
      <button class="btn btn-danger btn-sm" onclick="removeFixtureType(${i})">Remove</button>
    </div>
  `).join('') || '<div style="font-size:12px;color:var(--text3);padding:8px 0;">No types yet.</div>';
}
async function addFixtureType() {
  const val = document.getElementById('new-fixtype-input').value.trim();
  if (!val) return;
  if (fixtureTypes.includes(val)) { notify('Already exists','error'); return; }
  fixtureTypes.push(val);
  fixtureTypes.sort();
  document.getElementById('new-fixtype-input').value = '';
  await storeSet(KEY_FIX_TYPES, JSON.stringify(fixtureTypes));
  if (fbDb) await fbSet('lumasamples/fixtureTypes', Object.fromEntries(fixtureTypes.map((t,i)=>[t.replace(/[.#$[\]\/\s]/g,'_')||'t'+i,t])));
  renderFixtypesList();
  notify(`âœ“ Added type: ${val}`,'success');
}
async function removeFixtureType(idx) {
  fixtureTypes.splice(idx,1);
  await storeSet(KEY_FIX_TYPES, JSON.stringify(fixtureTypes));
  if (fbDb) await fbSet('lumasamples/fixtureTypes', Object.fromEntries(fixtureTypes.map((t,i)=>[t.replace(/[.#$[\]\/\s]/g,'_')||'t'+i,t])));
  renderFixtypesList();
}
function populateFixTypeSelect(selectId) {
  const sel = document.getElementById(selectId);
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">â€” Select type â€”</option>' +
    fixtureTypes.map(t=>`<option value="${t}">${t}</option>`).join('') +
    '<option value="__add__">+ Add new typeâ€¦</option>';
  if (cur && fixtureTypes.includes(cur)) sel.value = cur;
}
function onFixTypeChange(selectId, outputRowId) {
  const sel = document.getElementById(selectId);
  const row = document.getElementById(outputRowId);
  if (!sel) return;
  if (sel.value === '__add__') {
    sel.value = '';
    openFixtureTypesModal();
    return;
  }
  const isPowerSupply = ['Power Supply','Driver','Transformer'].includes(sel.value);
  if (row) row.style.display = isPowerSupply ? '' : 'none';
}
function autoWatt(el) {
  let v = el.value.trim();
  if (!v) return;
  // Remove any trailing W/w already there then re-add
  v = v.replace(/[Ww]+$/, '').trim();
  if (v && /^[\d.,\/\-\+x]+/.test(v)) el.value = v + 'W';
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSetupPage() {
  const connected = !!(fbConfig && fbDb);
  const isAdmin = currentUser?.role === 'admin';

  const fbHeading = document.getElementById('settings-fb-heading');
  const fbDesc    = document.getElementById('settings-fb-desc');
  const banner    = document.getElementById('setup-status-banner');

  // Everyone sees the heading and description
  [fbHeading, fbDesc].forEach(el => { if (el) el.style.display = ''; });

  // Status banner â€” everyone sees it
  if (banner) {
    if (connected) {
      banner.style.cssText = 'border-radius:var(--radius);padding:16px 20px;margin-bottom:24px;display:flex;align-items:center;gap:14px;background:rgba(74,222,128,0.06);border:1px solid rgba(74,222,128,0.25);';
      banner.innerHTML = `<span style="font-size:26px;">ğŸ”¥</span><div><div style="font-weight:600;color:var(--green);">Real-time sync active</div><div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:2px;">${fbConfig?.projectId||''}</div></div>`;
    } else {
      banner.style.cssText = 'border-radius:var(--radius);padding:16px 20px;margin-bottom:24px;display:flex;align-items:center;gap:14px;background:rgba(245,200,66,0.06);border:1px solid rgba(245,200,66,0.2);';
      banner.innerHTML = `<span style="font-size:26px;">âš ï¸</span><div><div style="font-weight:600;color:var(--accent);">Not connected</div><div style="font-size:12px;color:var(--text2);margin-top:2px;">Enter your Firebase Project ID below to sync with the team database.</div></div>`;
    }
  }

  const connectCard    = document.getElementById('setup-connect-card');
  const connectedBlock = document.getElementById('setup-connected-block');
  const urlEl          = document.getElementById('setup-connected-url');

  if (connected) {
    if (connectCard)    connectCard.style.display = 'none';
    if (connectedBlock) connectedBlock.style.display = 'block';
    if (urlEl) urlEl.textContent = `Project: ${fbConfig?.projectId||''}  Â·  ${fbConfig?.databaseURL||''}`;

    // Standard users: hide disconnect/reconnect buttons
    const adminBtns = connectedBlock?.querySelector('.setup-admin-only-btns');
    if (adminBtns) adminBtns.style.display = isAdmin ? '' : 'none';
  } else {
    if (connectCard)    connectCard.style.display = 'flex';
    if (connectedBlock) connectedBlock.style.display = 'none';

    // Standard users: hide the advanced "Having trouble?" section
    const troubleSection = connectCard?.querySelector('details');
    if (troubleSection) troubleSection.style.display = isAdmin ? '' : 'none';
  }
}

async function connectFromSetup() {
  const fb = document.getElementById('setup-connect-feedback');
  const showErr = (msg) => {
    if (!fb) return;
    fb.style.display = 'block';
    fb.style.background = 'var(--red-dim)';
    fb.style.color = 'var(--red)';
    fb.textContent = 'âš  ' + msg;
  };
  const showInfo = (msg) => {
    if (!fb) return;
    fb.style.display = 'block';
    fb.style.background = 'rgba(245,200,66,0.08)';
    fb.style.color = 'var(--accent)';
    fb.textContent = msg;
  };

  // Try full config textarea first (advanced mode)
  const fullConfig = (document.getElementById('setup-fb-config')?.value || '').trim();
  if (fullConfig) {
    showInfo('Connectingâ€¦');
    await connectFirebase(fullConfig);
    if (fb) fb.style.display = 'none';
    return;
  }

  // Otherwise use Project ID (easy mode)
  const pid = (document.getElementById('setup-project-id')?.value || '').trim();
  if (!pid) { showErr('Enter your Firebase Project ID first.'); return; }
  if (!/^[a-zA-Z0-9_-]+$/.test(pid)) { showErr('Project ID can only contain letters, numbers, hyphens and underscores.'); return; }

  showInfo('Connecting to ' + pid + 'â€¦');
  // Build config from Project ID â€” Firebase uses predictable URLs
  const config = {
    apiKey:            'lumasamples-autokey',   // not needed for Realtime DB with public rules
    authDomain:        pid + '.firebaseapp.com',
    databaseURL:       'https://' + pid + '-default-rtdb.firebaseio.com',
    projectId:         pid,
    storageBucket:     pid + '.appspot.com',
    messagingSenderId: '000000000000',
    appId:             '1:000000000000:web:000000000000',
  };
  await connectFirebase(config);
  if (fb) fb.style.display = 'none';
}

function disconnectFromSetup() {
  disconnectFirebase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE STATUS (admin panel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGsStatus() {
  const btns  = document.getElementById('fb-action-btns');
  const block = document.getElementById('fb-status-block');
  if (!btns || !block) return;
  const connected = !!(fbConfig && fbDb);
  if (connected) {
    btns.innerHTML = `
      <button class="btn btn-secondary btn-sm" onclick="fbStartListening();notify('Reconnected','success')">â†» Reconnect</button>
      <button class="btn btn-danger btn-sm" onclick="disconnectFirebase()">Disconnect</button>
    `;
    block.innerHTML = `<span style="color:var(--green);">ğŸ”¥ Firebase live sync</span> <span style="color:var(--text3);margin-left:8px;font-size:11px;font-family:'DM Mono',monospace;">${fbConfig?.projectId}</span>`;
  } else {
    btns.innerHTML = '';
    block.innerHTML = `<span style="color:var(--text3);">Not connected â€” data is stored locally only.</span>`;
  }
  // Update admin inline connect/connected blocks
  const aConn = document.getElementById('admin-connect-card');
  const aDisc = document.getElementById('admin-connected-block');
  const aUrl  = document.getElementById('admin-connected-url');
  if (aConn) aConn.style.display = connected ? 'none' : 'flex';
  if (aDisc) aDisc.style.display = connected ? '' : 'none';
  if (aUrl && fbConfig) aUrl.textContent = fbConfig.projectId + '.firebaseio.com';
  // Sync admin-project-id field with setup field
  const adminPid = document.getElementById('admin-project-id');
  const setupPid = document.getElementById('setup-project-id');
  if (adminPid && setupPid && setupPid.value) adminPid.value = setupPid.value;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function timeAgo(ts) {
  if (!ts) return '';
  const d = Math.floor((Date.now()-new Date(ts))/1000);
  if (d<60) return `${d}s ago`;
  if (d<3600) return `${Math.floor(d/60)}m ago`;
  if (d<86400) return `${Math.floor(d/3600)}h ago`;
  return `${Math.floor(d/86400)}d ago`;
}

function notify(msg, type='success') {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.className = 'notif show ' + type;
  setTimeout(()=>{el.className='notif';},3000);
}

// Keyboard PIN support
document.addEventListener('keydown', e => {
  if (document.getElementById('pin-entry').style.display!=='none') {
    if (e.key>='0'&&e.key<='9') pinPress(e.key);
    if (e.key==='Backspace') pinBackspace();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function detectAndApplyLayout() {
  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
    || window.innerWidth <= 580
    || (window.navigator.standalone === true)
    || window.matchMedia('(display-mode: standalone)').matches;
  document.body.classList.toggle('is-mobile', isMobile);
  // Set --tab-bar-h immediately (sync) so sync-bar bottom offset is always correct.
  // Also run after next paint in case flex layout hasn't resolved yet.
  const setTabH = () => {
    const tabBar = document.getElementById('bottom-tabs');
    if (!tabBar) return;
    const h = tabBar.offsetHeight || 58;
    document.documentElement.style.setProperty('--tab-bar-h', h + 'px');
  };
  setTabH();
  requestAnimationFrame(setTabH);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HAPTIC FEEDBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function haptic(style) {
  if (navigator.vibrate) {
    if (style === 'light') navigator.vibrate(10);
    else if (style === 'success') navigator.vibrate([10, 30, 10]);
    else if (style === 'error') navigator.vibrate([30, 20, 30]);
    else navigator.vibrate(10);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBAL SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openGlobalSearch() {
  const ov = document.getElementById('global-search-overlay');
  ov.classList.add('open');
  setTimeout(() => document.getElementById('gs-input').focus(), 80);
  runGlobalSearch();
}
function closeGlobalSearch() {
  document.getElementById('global-search-overlay').classList.remove('open');
}
document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openGlobalSearch(); }
  if (e.key === 'Escape') closeGlobalSearch();
});

function runGlobalSearch() {
  const q = (document.getElementById('gs-input').value || '').toLowerCase().trim();
  const res = document.getElementById('gs-results');
  if (!q) {
    res.innerHTML = '<div class="gs-empty">Start typing to search everythingâ€¦</div>';
    return;
  }
  const matched = fixtures.filter(f => {
    const txt = [f.id, f.name, f.brand, f.fixtureType, f.category, f.location, f.partNo, f.notes].join(' ').toLowerCase();
    return txt.includes(q);
  }).slice(0, 20);

  if (!matched.length) {
    res.innerHTML = '<div class="gs-empty">No fixtures found for "' + q + '"</div>';
    return;
  }
  res.innerHTML = '<div class="gs-section-label">Fixtures (' + matched.length + ')</div>' +
    matched.map(f => {
      const u = f.checkedOutBy ? users.find(x => x.id === f.checkedOutBy) : null;
      return `<div class="gs-result" onclick="gsOpenFixture('${f.id}')">
        <span class="gs-result-id">${f.id}</span>
        <span class="gs-result-name">${f.name}</span>
        <span class="gs-result-meta">${[f.fixtureType||f.category, f.location].filter(Boolean).join(' Â· ')} ${f.status==='out'?(u?'Â· ğŸ‘¤ '+u.name:'Â· Out'):'Â· Available'}</span>
        <span class="sbadge ${f.status==='available'?'available':'out'}" style="flex-shrink:0;">${f.status==='available'?'âœ“':'Out'}</span>
      </div>`;
    }).join('');
}

function gsOpenFixture(fid) {
  closeGlobalSearch();
  // Navigate to library and open detail
  showPage('library', document.querySelector('[data-page="library"]'));
  setTimeout(() => openDetailModal(fid), 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVED FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let savedFilters = JSON.parse(localStorage.getItem('luma:savedFilters') || '[]');

function renderSavedFilters() {
  const bar = document.getElementById('saved-filters-bar');
  if (!bar) return;
  const chips = savedFilters.map((sf, i) => `
    <span class="saved-filter-chip" onclick="applySavedFilter(${i})" id="sfc-${i}">
      ${sf.label}
      <span class="sfc-del" onclick="event.stopPropagation();deleteSavedFilter(${i})" title="Remove">Ã—</span>
    </span>
  `).join('');
  bar.innerHTML = chips + '<button class="save-filter-btn" onclick="saveCurrentFilter()" title="Save current filter">ï¼‹ Save Filter</button>';
}

function saveCurrentFilter() {
  const q = document.getElementById('search-input').value;
  const status = document.getElementById('filter-status').value;
  const type = document.getElementById('filter-category').value;
  const sort = document.getElementById('sort-select').value;
  if (!q && !status && !type) { notify('Set at least one filter to save', 'info'); return; }
  const parts = [q, status, type].filter(Boolean);
  const label = parts.join(' Â· ') || 'Filter';
  const name = prompt('Name this filter:', label);
  if (!name) return;
  savedFilters.push({ label: name, q, status, type, sort });
  localStorage.setItem('luma:savedFilters', JSON.stringify(savedFilters));
  renderSavedFilters();
  notify('Filter saved: ' + name, 'success');
}

function applySavedFilter(i) {
  const sf = savedFilters[i];
  if (!sf) return;
  document.getElementById('search-input').value = sf.q || '';
  document.getElementById('filter-status').value = sf.status || '';
  const catSel = document.getElementById('filter-category');
  if (catSel) catSel.value = sf.type || '';
  document.getElementById('sort-select').value = sf.sort || 'name';
  // Toggle active state
  document.querySelectorAll('.saved-filter-chip').forEach((c, idx) => c.classList.toggle('active', idx === i));
  renderLibrary();
}

function deleteSavedFilter(i) {
  savedFilters.splice(i, 1);
  localStorage.setItem('luma:savedFilters', JSON.stringify(savedFilters));
  renderSavedFilters();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sortFixtures(list) {
  const sort = (document.getElementById('sort-select') || {}).value || 'name';
  return [...list].sort((a, b) => {
    if (sort === 'name')     return a.name.localeCompare(b.name);
    if (sort === 'id')       return a.id.localeCompare(b.id);
    if (sort === 'location') return (a.location||'').localeCompare(b.location||'');
    if (sort === 'status')   return a.status.localeCompare(b.status);
    if (sort === 'recent') {
      const ta = a.checkedOutAt ? new Date(a.checkedOutAt) : new Date(0);
      const tb = b.checkedOutAt ? new Date(b.checkedOutAt) : new Date(0);
      return tb - ta;
    }
    return 0;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHECKOUT NOTE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let checkoutNoteFid = null;
let checkoutNoteBulk = [];

function openCheckoutNote(fid) {
  const f = fixtures.find(x => x.id === fid);
  if (!f || f.status !== 'available') return;
  checkoutNoteFid = fid;
  checkoutNoteBulk = [];
  document.getElementById('checkout-note-title').textContent = 'Check Out Fixture';
  document.getElementById('checkout-note-fixture-info').innerHTML =
    `<span class="fid">${f.id}</span> <strong style="margin-left:8px;">${f.name}</strong>` +
    (f.brand ? `<span style="margin-left:8px;color:var(--text3);">${f.brand}</span>` : '');
  document.getElementById('checkout-note-input').value = '';
  openModal('checkout-note-modal');
  setTimeout(() => document.getElementById('checkout-note-input').focus(), 100);
}

function openBulkCheckoutNote(fids) {
  checkoutNoteFid = null;
  checkoutNoteBulk = fids;
  document.getElementById('checkout-note-title').textContent = `Check Out ${fids.length} Fixture${fids.length>1?'s':''}`;
  const names = fids.slice(0,3).map(id => { const f = fixtures.find(x=>x.id===id); return f ? f.name : id; });
  document.getElementById('checkout-note-fixture-info').innerHTML =
    names.join(', ') + (fids.length > 3 ? ` <span style="color:var(--text3);">+${fids.length-3} more</span>` : '');
  document.getElementById('checkout-note-input').value = '';
  openModal('checkout-note-modal');
  setTimeout(() => document.getElementById('checkout-note-input').focus(), 100);
}

async function confirmCheckoutNote() {
  const note = document.getElementById('checkout-note-input').value.trim();
  closeModal('checkout-note-modal');

  // Capture return/swap fids before clearing state
  const retFids  = (window._bulkReturnFids  || []).slice();
  const swapFids = (window._bulkSwapFids    || []).slice();
  const bulkCheckoutFids = checkoutNoteBulk.slice();
  const singleFid = checkoutNoteFid;
  // Clear state immediately
  window._bulkReturnFids = [];
  window._bulkSwapFids   = [];
  checkoutNoteBulk = [];
  checkoutNoteFid = null;

  if (bulkCheckoutFids.length && (retFids.length || swapFids.length)) {
    window._skipBulkExit = true; // we'll do the exit ourselves after returns
    await doBulkCheckout(bulkCheckoutFids, note);
    window._skipBulkExit = false;
  } else if (bulkCheckoutFids.length) {
    await doBulkCheckout(bulkCheckoutFids, note);
  } else if (singleFid) {
    await doCheckout(singleFid, note);
  }

  // Returns
  for (const fid of retFids) {
    const f = fixtures.find(x => x.id === fid);
    if (!f) continue;
    const ts = new Date().toISOString();
    if (!f.comments) f.comments = [];
    f.comments.push({ ts, userId: currentUser.id, userName: currentUser.name, text: '', action: 'return' });
    f.status = 'available'; f.checkedOutBy = null; f.checkedOutAt = null;
    const h = { ts, fixtureId: f.id, fixtureName: f.name, userId: currentUser.id, userName: currentUser.name, action: 'return' };
    history.unshift(h);
    await saveData({ fixture: f, historyEntry: h });
  }
  // Swaps / take-overs
  for (const fid of swapFids) {
    const f = fixtures.find(x => x.id === fid);
    if (!f) continue;
    const prev = users.find(x => x.id === f.checkedOutBy);
    const ts = new Date().toISOString();
    if (!f.comments) f.comments = [];
    f.comments.push({ ts, userId: currentUser.id, userName: currentUser.name, text: `taken from ${prev?.name||'unknown'}`, action: 'transfer' });
    f.checkedOutBy = currentUser.id; f.checkedOutAt = ts;
    const h = { ts, fixtureId: f.id, fixtureName: f.name, userId: currentUser.id, userName: currentUser.name, action: 'transfer' };
    history.unshift(h);
    await saveData({ fixture: f, historyEntry: h });
  }

  if (retFids.length || swapFids.length) {
    haptic('success');
    exitBulkMode();
    refreshCurrentPage();
    const msgs = [];
    if (retFids.length)  msgs.push(`â†™ ${retFids.length} returned`);
    if (swapFids.length) msgs.push(`â‡„ ${swapFids.length} taken over`);
    if (msgs.length) notify(msgs.join(', '), 'success');
  } else {
    exitBulkMode();
    refreshCurrentPage();
  }
}

async function doCheckout(fid, note) {
  const f = fixtures.find(x => x.id === fid);
  if (!f || f.status !== 'available') return;
  const ts = new Date().toISOString();
  f.status = 'out';
  f.checkedOutBy = currentUser.id;
  f.checkedOutAt = ts;
  if (!f.comments) f.comments = [];
  f.comments.push({ ts, userId: currentUser.id, userName: currentUser.name, text: note || '', action: 'checkout' });
  const hco = { ts, fixtureId: f.id, fixtureName: f.name, userId: currentUser.id, userName: currentUser.name, action: 'checkout', note };
  history.unshift(hco);
  await saveData({ fixture: f, historyEntry: hco });
  haptic('success');
  refreshCurrentPage();
  notify(`âœ“ Checked out: ${f.name}` + (note ? ` â€” "${note}"` : ''), 'success');
}

async function bulkReturn() {
  const myOutFids = [...bulkSelected].filter(id => {
    const f = fixtures.find(x => x.id === id);
    return f && f.status === 'out' && (f.checkedOutBy === currentUser?.id || currentUser?.role === 'admin');
  });
  if (!myOutFids.length) { notify('No returnable fixtures selected', 'error'); return; }
  for (const fid of myOutFids) {
    const f = fixtures.find(x => x.id === fid);
    if (!f) continue;
    const ts = new Date().toISOString();
    if (!f.comments) f.comments = [];
    f.comments.push({ ts, userId: currentUser.id, userName: currentUser.name, text: '', action: 'return' });
    f.status = 'available'; f.checkedOutBy = null; f.checkedOutAt = null;
    const h = { ts, fixtureId: f.id, fixtureName: f.name, userId: currentUser.id, userName: currentUser.name, action: 'return' };
    history.unshift(h);
    await saveData({ fixture: f, historyEntry: h });
  }
  haptic('success');
  exitBulkMode();
  refreshCurrentPage();
  notify(`âœ“ Returned ${myOutFids.length} fixture${myOutFids.length!==1?'s':''}`, 'success');
}

async function bulkSwap() {
  const otherOutFids = [...bulkSelected].filter(id => {
    const f = fixtures.find(x => x.id === id);
    return f && f.status === 'out' && f.checkedOutBy !== currentUser?.id;
  });
  if (!otherOutFids.length) { notify('No fixtures to take over', 'error'); return; }
  for (const fid of otherOutFids) {
    const f = fixtures.find(x => x.id === fid);
    if (!f) continue;
    const prev = users.find(x => x.id === f.checkedOutBy);
    const ts = new Date().toISOString();
    if (!f.comments) f.comments = [];
    f.comments.push({ ts, userId: currentUser.id, userName: currentUser.name, text: `taken from ${prev?.name||'unknown'}`, action: 'transfer' });
    f.checkedOutBy = currentUser.id; f.checkedOutAt = ts;
    const h = { ts, fixtureId: f.id, fixtureName: f.name, userId: currentUser.id, userName: currentUser.name, action: 'transfer' };
    history.unshift(h);
    await saveData({ fixture: f, historyEntry: h });
  }
  haptic('success');
  exitBulkMode();
  refreshCurrentPage();
  notify(`â‡„ Took over ${otherOutFids.length} fixture${otherOutFids.length!==1?'s':''}`, 'success');
}

async function doBulkCheckout(fids, note) {
  let count = 0;
  for (const fid of fids) {
    const f = fixtures.find(x => x.id === fid);
    if (!f || f.status !== 'available') continue;
    const ts = new Date().toISOString();
    f.status = 'out';
    f.checkedOutBy = currentUser.id;
    f.checkedOutAt = ts;
    if (!f.comments) f.comments = [];
    f.comments.push({ ts, userId: currentUser.id, userName: currentUser.name, text: note || '', action: 'checkout' });
    const hco = { ts, fixtureId: f.id, fixtureName: f.name, userId: currentUser.id, userName: currentUser.name, action: 'checkout', note };
    history.unshift(hco);
    await saveData({ fixture: f, historyEntry: hco });
    count++;
  }
  haptic('success');
  if (!window._skipBulkExit) { exitBulkMode(); refreshCurrentPage(); }
  notify(`âœ“ Checked out ${count} fixture${count!==1?'s':''}` + (note ? ` â€” "${note}"` : ''), 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BULK SELECT MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bulkMode = false;
let bulkSelected = new Set();

function toggleBulkMode() {
  bulkMode = !bulkMode;
  bulkSelected.clear();
  const grid = document.getElementById('fixture-grid');
  const btn = document.getElementById('bulk-toggle-btn');
  const bar = document.getElementById('bulk-bar');
  if (bulkMode) {
    grid.classList.add('select-mode');
    btn.textContent = 'âœ• Cancel';
    btn.classList.add('btn-danger');
    bar.classList.add('visible');
    updateBulkBar();
  } else {
    exitBulkMode();
  }
}

function exitBulkMode() {
  bulkMode = false;
  bulkSelected.clear();
  const grid = document.getElementById('fixture-grid');
  const btn = document.getElementById('bulk-toggle-btn');
  const bar = document.getElementById('bulk-bar');
  if (grid) grid.classList.remove('select-mode');
  if (btn) { btn.textContent = 'â˜‘ Select'; btn.classList.remove('btn-danger'); }
  if (bar) bar.classList.remove('visible');
  document.querySelectorAll('.fixture-card').forEach(c => c.classList.remove('selected'));
}

function toggleCardSelect(fid) {
  haptic('light');
  if (bulkSelected.has(fid)) bulkSelected.delete(fid);
  else bulkSelected.add(fid);
  const card = document.querySelector(`[data-fid="${fid}"]`);
  if (card) card.classList.toggle('selected', bulkSelected.has(fid));
  const check = document.getElementById('check-' + fid);
  if (check) check.textContent = bulkSelected.has(fid) ? 'âœ“' : '';
  updateBulkBar();
}

function updateBulkBar() {
  const count = bulkSelected.size;
  const countEl = document.getElementById('bulk-count');
  if (countEl) countEl.textContent = count + ' selected';

  const selectedList = [...bulkSelected];
  const availFids   = selectedList.filter(id => { const f = fixtures.find(x=>x.id===id); return f && f.status==='available'; });
  const myOutFids   = selectedList.filter(id => { const f = fixtures.find(x=>x.id===id); return f && f.status==='out' && f.checkedOutBy===currentUser?.id; });
  const otherOutFids = selectedList.filter(id => { const f = fixtures.find(x=>x.id===id); return f && f.status==='out' && f.checkedOutBy!==currentUser?.id; });

  const parts = [];
  if (availFids.length)    parts.push(`â†— ${availFids.length} check out`);
  if (myOutFids.length)    parts.push(`â†™ ${myOutFids.length} return`);
  if (otherOutFids.length) parts.push(`â‡„ ${otherOutFids.length} take over`);

  const summaryEl = document.getElementById('bulk-summary');
  if (summaryEl) summaryEl.textContent = parts.join('  Â·  ');

  const actionBtn = document.getElementById('bulk-action-btn');
  if (actionBtn) {
    const hasAny = availFids.length || myOutFids.length || otherOutFids.length;
    actionBtn.style.display = hasAny && count > 0 ? '' : 'none';
    // Label the button based on what actions will happen
    if (availFids.length && !myOutFids.length && !otherOutFids.length) {
      actionBtn.textContent = 'â†— Check Out';
      actionBtn.className = 'btn btn-success btn-sm';
    } else if (!availFids.length && (myOutFids.length || otherOutFids.length) && !otherOutFids.length) {
      actionBtn.textContent = 'â†™ Return';
      actionBtn.className = 'btn btn-danger btn-sm';
    } else if (!availFids.length && otherOutFids.length && !myOutFids.length && !availFids.length) {
      actionBtn.textContent = 'â‡„ Take Over';
      actionBtn.className = 'btn btn-warning btn-sm';
    } else if (availFids.length && myOutFids.length && !otherOutFids.length) {
      actionBtn.textContent = 'â†— Check Out / â†™ Return';
      actionBtn.className = 'btn btn-primary btn-sm';
    } else if (availFids.length && otherOutFids.length) {
      actionBtn.textContent = 'â†— Check Out / â‡„ Take Over';
      actionBtn.className = 'btn btn-primary btn-sm';
    } else {
      actionBtn.textContent = 'âœ¦ Do All';
      actionBtn.className = 'btn btn-primary btn-sm';
    }
  }
}

function bulkCheckout() { bulkDoAll(); } // legacy compat

function bulkDoAll() {
  const selectedList = [...bulkSelected];
  const availFids    = selectedList.filter(id => { const f = fixtures.find(x=>x.id===id); return f && f.status==='available'; });
  const myOutFids    = selectedList.filter(id => { const f = fixtures.find(x=>x.id===id); return f && f.status==='out' && f.checkedOutBy===currentUser?.id; });
  const otherOutFids = selectedList.filter(id => { const f = fixtures.find(x=>x.id===id); return f && f.status==='out' && f.checkedOutBy!==currentUser?.id; });

  if (!availFids.length && !myOutFids.length && !otherOutFids.length) {
    notify('Nothing to do with selected fixtures', 'error'); return;
  }
  // Store all three lists on the note state
  checkoutNoteFid = null;
  checkoutNoteBulk = availFids;
  window._bulkReturnFids  = myOutFids;
  window._bulkSwapFids    = otherOutFids;

  // Build a summary for the note modal
  const parts = [];
  if (availFids.length)    parts.push(`â†— Check out ${availFids.length}`);
  if (myOutFids.length)    parts.push(`â†™ Return ${myOutFids.length}`);
  if (otherOutFids.length) parts.push(`â‡„ Take over ${otherOutFids.length}`);

  // If only returns/swaps and no checkouts, skip the note modal
  if (!availFids.length) {
    confirmCheckoutNote();
    return;
  }
  // Open note modal with summary
  document.getElementById('checkout-note-title').textContent = parts.join(' Â· ');
  const names = availFids.slice(0,2).map(id => { const f = fixtures.find(x=>x.id===id); return f ? f.name : id; });
  document.getElementById('checkout-note-fixture-info').innerHTML =
    `<div style="font-size:12px;color:var(--text3);margin-bottom:6px;">${parts.join(' Â· ')}</div>` +
    names.join(', ') + (availFids.length > 2 ? ` <span style="color:var(--text3);">+${availFids.length-2} more</span>` : '');
  document.getElementById('checkout-note-input').value = '';
  openModal('checkout-note-modal');
  setTimeout(() => document.getElementById('checkout-note-input').focus(), 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  USAGE STATS (admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let usageTab = 'fixtures';

function showUsageTab(tab) {
  usageTab = tab;
  document.querySelectorAll('.usage-tab-btn').forEach(b => {
    const isActive = b.id === 'usage-tab-' + tab;
    b.classList.toggle('active-usage-tab', isActive);
  });
  renderUsageStats();
}

function _usageBarRow(label, sublabel, count, max, color, prefix) {
  return `
    <div class="usage-stat-row">
      ${prefix || ''}
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</div>
        ${sublabel ? `<div style="font-size:11px;color:var(--text3);margin-top:1px;">${sublabel}</div>` : ''}
      </div>
      <div class="usage-bar-wrap" style="min-width:80px;max-width:140px;">
        <div class="usage-bar" style="width:${Math.round((count/max)*100)}%;background:${color};"></div>
      </div>
      <span class="usage-count">${count}Ã—</span>
    </div>`;
}

function renderUsageStats() {
  const el = document.getElementById('usage-stats-body');
  if (!el) return;
  const checkouts = history.filter(h => h.action === 'checkout');
  if (!checkouts.length) {
    el.innerHTML = '<div style="color:var(--text3);font-size:13px;">No checkout history yet.</div>';
    return;
  }

  if (usageTab === 'fixtures') {
    const counts = {};
    checkouts.forEach(h => {
      if (!counts[h.fixtureId]) counts[h.fixtureId] = { name: h.fixtureName, count: 0 };
      counts[h.fixtureId].count++;
    });
    const sorted = Object.entries(counts).sort((a,b) => b[1].count - a[1].count).slice(0, 25);
    const max = sorted[0][1].count;
    el.innerHTML = sorted.map(([id, d]) =>
      _usageBarRow(d.name, id, d.count, max, 'var(--accent)',
        `<span class="fid" style="min-width:64px;flex-shrink:0;">${id}</span>`)
    ).join('');

  } else if (usageTab === 'brand') {
    const counts = {};
    checkouts.forEach(h => {
      const f = fixtures.find(x => x.id === h.fixtureId);
      const brand = (f && f.brand) ? f.brand.trim() : '(No Brand)';
      if (!counts[brand]) counts[brand] = { count: 0, fixtures: new Set() };
      counts[brand].count++;
      counts[brand].fixtures.add(h.fixtureId);
    });
    const sorted = Object.entries(counts).sort((a,b) => b[1].count - a[1].count).slice(0, 25);
    const max = sorted[0][1].count;
    el.innerHTML = sorted.map(([brand, d]) =>
      _usageBarRow(brand, `${d.fixtures.size} fixture${d.fixtures.size !== 1 ? 's' : ''}`, d.count, max, 'var(--blue)')
    ).join('');

  } else if (usageTab === 'type') {
    const counts = {};
    checkouts.forEach(h => {
      const f = fixtures.find(x => x.id === h.fixtureId);
      const type = (f && (f.fixtureType || f.category)) ? (f.fixtureType || f.category) : '(No Type)';
      if (!counts[type]) counts[type] = { count: 0, fixtures: new Set() };
      counts[type].count++;
      counts[type].fixtures.add(h.fixtureId);
    });
    const sorted = Object.entries(counts).sort((a,b) => b[1].count - a[1].count).slice(0, 25);
    const max = sorted[0][1].count;
    el.innerHTML = sorted.map(([type, d]) =>
      _usageBarRow(type, `${d.fixtures.size} unique fixture${d.fixtures.size !== 1 ? 's' : ''}`, d.count, max, 'rgba(167,139,250,0.9)')
    ).join('');

  } else if (usageTab === 'users') {
    const counts = {};
    checkouts.forEach(h => {
      if (!h.userId) return;
      if (!counts[h.userId]) counts[h.userId] = { name: h.userName, count: 0, userId: h.userId };
      counts[h.userId].count++;
    });
    const sorted = Object.entries(counts).sort((a,b) => b[1].count - a[1].count).slice(0, 25);
    if (!sorted.length) { el.innerHTML = '<div style="color:var(--text3);font-size:13px;">No user data.</div>'; return; }
    const max = sorted[0][1].count;
    el.innerHTML = sorted.map(([uid, d]) => {
      const u = users.find(x => x.id === uid);
      return _usageBarRow(d.name, null, d.count, max, 'var(--green)',
        `<span style="font-size:20px;flex-shrink:0;">${u ? u.avatar : 'ğŸ‘¤'}</span>`);
    }).join('');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportFixturesCSV() {
  const cols = ['id','name','brand','partNo','fixtureType','wattage','voltage','outputWattage','location','specSheet','dateReceived','status','notes'];
  const header = cols.join(',');
  const rows = fixtures.map(f => cols.map(c => {
    const v = (f[c] || '').toString().replace(/"/g, '""');
    return v.includes(',') || v.includes('"') || v.includes('\n') ? `"${v}"` : v;
  }).join(','));
  const csv = [header, ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `lumasamples-fixtures-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
  notify('CSV exported: ' + fixtures.length + ' fixtures', 'success');
}

async function importFixturesCSV(input) {
  const file = input.files[0];
  if (!file) return;
  const statusEl = document.getElementById('csv-status');
  try {
    const text = await file.text();
    const lines = text.trim().split(/\r?\n/);
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g,''));
    let added = 0, updated = 0;
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      // Basic CSV parse (handles quoted fields)
      const vals = [];
      let cur = '', inQ = false;
      for (const ch of lines[i]) {
        if (ch === '"') { inQ = !inQ; continue; }
        if (ch === ',' && !inQ) { vals.push(cur); cur = ''; continue; }
        cur += ch;
      }
      vals.push(cur);
      const row = {};
      headers.forEach((h, idx) => { row[h] = (vals[idx] || '').trim(); });
      if (!row.name) continue;
      const existing = row.id ? fixtures.find(f => f.id === row.id) : null;
      if (existing) {
        Object.assign(existing, normalizeFixture({ ...existing, ...row }));
        updated++;
      } else {
        const nf = normalizeFixture({ ...row, id: row.id || genId(), status: row.status || 'available' });
        fixtures.push(nf);
        fixtureCounter++;
        added++;
      }
    }
    await saveData({ counter: true });
    if (fbDb) await fbPushAll();
    refreshCurrentPage();
    populateFilters();
    statusEl.style.display = '';
    statusEl.style.color = 'var(--green)';
    statusEl.textContent = `âœ“ Imported: ${added} added, ${updated} updated.`;
    notify(`CSV imported: ${added} added, ${updated} updated`, 'success');
  } catch(e) {
    statusEl.style.display = '';
    statusEl.style.color = 'var(--red)';
    statusEl.textContent = 'âš  Import failed: ' + e.message;
    notify('CSV import failed: ' + e.message, 'error');
  }
  input.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BATCH PRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let printSelectMode = false;
let printSelected = new Set();

function togglePrintSelectMode() {
  printSelectMode = !printSelectMode;
  printSelected.clear();
  const btn = document.getElementById('print-select-btn');
  const bar = document.getElementById('print-select-bar');
  const actionBtn = document.getElementById('print-action-btn');
  const grid = document.getElementById('print-grid');
  if (printSelectMode) {
    grid.classList.add('print-select-mode');
    btn.textContent = 'âœ• Cancel';
    bar.style.display = 'flex';
    actionBtn.textContent = 'ğŸ–¨ Print Selected (0)';
    actionBtn.onclick = printSelectedQR;
  } else {
    grid.classList.remove('print-select-mode');
    btn.textContent = 'â˜‘ Select';
    bar.style.display = 'none';
    actionBtn.textContent = 'ğŸ–¨ Print All';
    actionBtn.onclick = printAllQR;
    document.querySelectorAll('.print-card').forEach(c => c.classList.remove('print-selected'));
    document.querySelectorAll('.pcheck').forEach(c => c.textContent = '');
  }
  updatePrintSelectCount();
}

function togglePrintCard(fid) {
  haptic('light');
  if (printSelected.has(fid)) printSelected.delete(fid);
  else printSelected.add(fid);
  const card = document.getElementById('pcard-' + fid);
  if (card) card.classList.toggle('print-selected', printSelected.has(fid));
  const check = document.getElementById('pcheck-' + fid);
  if (check) check.textContent = printSelected.has(fid) ? 'âœ“' : '';
  updatePrintSelectCount();
}

function updatePrintSelectCount() {
  const n = printSelected.size;
  const el = document.getElementById('print-selected-count');
  if (el) el.textContent = n + ' selected';
  const btn = document.getElementById('print-action-btn');
  if (btn && printSelectMode) btn.textContent = `ğŸ–¨ Print Selected (${n})`;
}

function selectAllForPrint() {
  fixtures.forEach(f => printSelected.add(f.id));
  document.querySelectorAll('.print-card').forEach(c => {
    c.classList.add('print-selected');
    const id = c.id.replace('pcard-', '');
    const ch = document.getElementById('pcheck-' + id);
    if (ch) ch.textContent = 'âœ“';
  });
  updatePrintSelectCount();
}

function clearPrintSelection() {
  printSelected.clear();
  document.querySelectorAll('.print-card').forEach(c => { c.classList.remove('print-selected'); });
  document.querySelectorAll('.pcheck').forEach(c => { c.textContent = ''; });
  updatePrintSelectCount();
}

async function printSelectedQR() {
  if (!printSelected.size) { notify('No labels selected', 'error'); return; }
  const ids = [...printSelected];
  const overlay = document.createElement('div');
  overlay.id = 'print-single-overlay';
  overlay.style.cssText = 'display:none;position:fixed;inset:0;background:#fff;z-index:9999;font-family:Arial,sans-serif;';

  // Inject print styles programmatically to avoid </style> inside JS string
  const styleEl = document.createElement('style');
  styleEl.textContent = [
    '#print-single-overlay { display:flex !important; flex-wrap:wrap; align-items:flex-start; padding:8pt; gap:6pt; }',
    '.pso-label { display:flex;flex-direction:column;align-items:center;width:0.75in;page-break-inside:avoid; }',
    '.pso-qr { width:0.625in;height:0.625in;display:block; }',
    '.pso-id { font-size:5pt;font-family:monospace;color:#444;margin-top:2pt;text-align:center; }',
    '.pso-name { font-size:5pt;font-weight:bold;color:#111;margin-top:1pt;text-align:center;max-width:0.75in;overflow:hidden;text-overflow:ellipsis;white-space:nowrap; }',
    '@media print { body > *:not(#print-single-overlay) { display:none !important; } #pso-back { display:none !important; } }',
    '#pso-back { position:fixed;top:16px;left:16px;padding:8px 16px;background:#111;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;z-index:10000; }'
  ].join(' ');
  overlay.appendChild(styleEl);

  const backBtn = document.createElement('button');
  backBtn.id = 'pso-back';
  backBtn.textContent = '\u2190 Back';
  backBtn.onclick = () => overlay.remove();
  overlay.appendChild(backBtn);

  // Generate QR canvases
  const qrPromises = ids.map(fid => new Promise(resolve => {
    const f = fixtures.find(x => x.id === fid);
    if (!f) { resolve(null); return; }
    const tmp = document.createElement('div');
    document.body.appendChild(tmp);
    new QRCode(tmp, { text: fixtureUrl(f.id), width: 150, height: 150, colorDark: '#000', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
    setTimeout(() => {
      const canvas = tmp.querySelector('canvas');
      const imgSrc = canvas ? canvas.toDataURL() : '';
      document.body.removeChild(tmp);
      resolve({ f, imgSrc });
    }, 200);
  }));
  const items = await Promise.all(qrPromises);
  items.filter(Boolean).forEach(({ f, imgSrc }) => {
    const label = document.createElement('div');
    label.className = 'pso-label';
    if (imgSrc) { const img = document.createElement('img'); img.className = 'pso-qr'; img.src = imgSrc; label.appendChild(img); }
    const idEl = document.createElement('div'); idEl.className = 'pso-id'; idEl.textContent = f.id; label.appendChild(idEl);
    const nmEl = document.createElement('div'); nmEl.className = 'pso-name'; nmEl.textContent = f.name; label.appendChild(nmEl);
    overlay.appendChild(label);
  });

  overlay.style.display = 'flex';
  document.body.appendChild(overlay);
  window.addEventListener('afterprint', () => { const el = document.getElementById('print-single-overlay'); if (el) el.remove(); }, { once: true });
  setTimeout(() => window.print(), 300);
}

function printAllQR() { window.print(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTAINERS (Cases & Boxes)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let containers = JSON.parse(localStorage.getItem('luma:containers') || '[]');
let containerCounter = containers.length ? Math.max(...containers.map(c => parseInt(c.id.replace('BOX-',''))||0)) + 1 : 1;

function containerUrl(id) {
  const base = window.location.href.split('?')[0].split('#')[0];
  return base + '?box=' + encodeURIComponent(id);
}

async function saveContainers() {
  localStorage.setItem('luma:containers', JSON.stringify(containers));
  if (fbDb) {
    const sanitize = s => String(s).replace(/[.#$[\]/\s]/g, '_');
    const updates = {};
    containers.forEach(c => { updates['lumasamples/containers/' + sanitize(c.id)] = c; });
    try { await fbDb.ref().update(updates); } catch(e) {}
  }
}

async function loadContainers() {
  try {
    const r = localStorage.getItem('luma:containers');
    if (r) containers = JSON.parse(r);
  } catch { containers = []; }
}

function renderContainersPage() {
  const el = document.getElementById('containers-list');
  if (!el) return;
  if (!containers.length) {
    el.innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--text3);"><div style="font-size:48px;margin-bottom:16px;">ğŸ“¦</div><div style="font-size:16px;">No cases yet. Create one to start grouping fixtures.</div></div>';
    return;
  }
  el.innerHTML = containers.map(c => {
    const fixturesInBox = fixtures.filter(f => f.containerId === c.id);
    const out = fixturesInBox.filter(f => f.status === 'out').length;
    const isSel = casePrintSelected.has(c.id);
    if (casePrintMode) {
      // Compact selectable row for print-select mode
      return `
        <div class="case-print-card ${isSel ? 'cpc-selected' : ''}" id="cpc-${c.id}" onclick="toggleCasePrint('${c.id}')">
          <div class="cpc-check">${isSel ? 'âœ“' : ''}</div>
          <div id="cqr-thumb-${c.id}" style="background:#fff;border-radius:5px;padding:4px;flex-shrink:0;"></div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:14px;font-weight:600;">${c.name}</div>
            <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:2px;">${c.id} Â· ${fixturesInBox.length} fixture${fixturesInBox.length!==1?'s':''}</div>
          </div>
        </div>`;
    }
    return `
      <div class="container-card" onclick="openContainerDetail('${c.id}')">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
          <div>
            <div class="container-name">${c.name}</div>
            ${c.desc ? `<div class="container-meta" style="margin-top:2px;color:var(--text2);">${c.desc}</div>` : ''}
            <div class="container-meta" style="margin-top:4px;">
              <span class="fid">${c.id}</span>
              <span style="margin-left:8px;">${fixturesInBox.length} fixture${fixturesInBox.length!==1?'s':''}</span>
              ${out ? `<span style="margin-left:6px;color:var(--red);">${out} out</span>` : ''}
            </div>
          </div>
          <div id="cqr-thumb-${c.id}" style="background:#fff;border-radius:6px;padding:6px;flex-shrink:0;"></div>
        </div>
        ${fixturesInBox.length ? `
          <div class="container-fixtures">
            ${fixturesInBox.slice(0,8).map(f => `<span class="container-fixture-pill" style="${f.status==='out'?'color:var(--red);border-color:rgba(248,113,113,0.3);':''}">${f.id}</span>`).join('')}
            ${fixturesInBox.length > 8 ? `<span class="container-fixture-pill" style="color:var(--text3);">+${fixturesInBox.length-8} more</span>` : ''}
          </div>` : ''}
      </div>
    `;
  }).join('');
  // Render tiny QRs
  containers.forEach(c => {
    setTimeout(() => {
      const el = document.getElementById('cqr-thumb-' + c.id);
      if (el && !el.querySelector('canvas')) {
        new QRCode(el, { text: containerUrl(c.id), width: 50, height: 50, colorDark: '#111', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
      }
    }, 60);
  });
}

let ncSelectedFixtures = new Set();

function openAddContainerModal() {
  document.getElementById('nc-name').value = '';
  document.getElementById('nc-desc').value = '';
  document.getElementById('nc-fixture-search').value = '';
  ncSelectedFixtures.clear();
  openModal('add-container-modal');
  setTimeout(() => { renderNcFixturePicker(); document.getElementById('nc-name').focus(); }, 100);
}

function renderNcFixturePicker() {
  const q = (document.getElementById('nc-fixture-search').value || '').toLowerCase();
  // Only show fixtures not already in a case
  const avail = fixtures.filter(f => !f.containerId && [f.id,f.name,f.brand,f.location].join(' ').toLowerCase().includes(q));
  const list = document.getElementById('nc-fixture-list');
  const countEl = document.getElementById('nc-selected-count');
  if (!avail.length) {
    list.innerHTML = '<div style="padding:12px 14px;color:var(--text3);font-size:13px;">No unassigned fixtures found.</div>';
  } else {
    list.innerHTML = avail.map(f => {
      const sel = ncSelectedFixtures.has(f.id);
      return `<div onclick="toggleNcFixture('${f.id}')" style="display:flex;align-items:center;gap:10px;padding:9px 12px;border-bottom:1px solid var(--border);cursor:pointer;background:${sel?'rgba(245,200,66,0.06)':'none'};">
        <div style="width:18px;height:18px;border:2px solid ${sel?'var(--accent)':'var(--border2)'};border-radius:4px;background:${sel?'var(--accent)':'none'};display:flex;align-items:center;justify-content:center;font-size:11px;color:#000;flex-shrink:0;">${sel?'âœ“':''}</div>
        <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--accent);background:var(--accent-dim);padding:2px 6px;border-radius:4px;">${f.id}</span>
        <span style="flex:1;font-size:13px;font-weight:500;">${f.name}</span>
        ${f.location?`<span style="font-size:11px;color:var(--text3);">${f.location}</span>`:''}
      </div>`;
    }).join('');
  }
  countEl.textContent = ncSelectedFixtures.size + ' fixture' + (ncSelectedFixtures.size!==1?'s':'') + ' selected';
}

function toggleNcFixture(fid) {
  if (ncSelectedFixtures.has(fid)) ncSelectedFixtures.delete(fid);
  else ncSelectedFixtures.add(fid);
  renderNcFixturePicker();
}

async function addContainer() {
  const name = document.getElementById('nc-name').value.trim();
  if (!name) { notify('Case name is required', 'error'); return; }
  const id = 'BOX-' + String(containerCounter).padStart(4, '0');
  containerCounter++;
  const c = { id, name, desc: document.getElementById('nc-desc').value.trim(), createdAt: new Date().toISOString() };
  containers.push(c);
  // Assign selected fixtures to this case
  if (ncSelectedFixtures.size) {
    for (const fid of ncSelectedFixtures) {
      const f = fixtures.find(x => x.id === fid);
      if (f) { f.containerId = id; await saveData({ fixture: f }); }
    }
    ncSelectedFixtures.clear();
  }
  await saveContainers();
  closeModal('add-container-modal');
  renderContainersPage();
  notify('âœ“ Case created: ' + name, 'success');
  setTimeout(() => openContainerDetail(id), 200);
}

function openContainerDetail(cid) {
  const c = containers.find(x => x.id === cid);
  if (!c) return;
  const fixturesInBox = fixtures.filter(f => f.containerId === cid);
  const avail = fixturesInBox.filter(f => f.status === 'available').length;
  const out = fixturesInBox.filter(f => f.status === 'out').length;
  document.getElementById('cd-title').textContent = 'ğŸ“¦ ' + c.name;
  document.getElementById('cd-delete-btn').onclick = () => deleteContainer(cid);
  document.getElementById('cd-body').innerHTML = `
    <div style="margin-bottom:14px;">
      ${c.desc ? `<div style="font-size:13px;color:var(--text2);margin-bottom:8px;">${c.desc}</div>` : ''}
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;font-family:'DM Mono',monospace;">${c.id}</div>
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
        <span style="font-size:13px;"><strong>${fixturesInBox.length}</strong> <span style="color:var(--text3);">fixtures</span></span>
        <span style="font-size:13px;color:var(--green);"><strong>${avail}</strong> available</span>
        ${out ? `<span style="font-size:13px;color:var(--red);"><strong>${out}</strong> out</span>` : ''}
      </div>
      <div style="background:#fff;border-radius:10px;padding:14px;display:inline-block;margin-bottom:14px;" id="cd-qr-wrap-${cid}"></div>
      <div style="font-size:11px;color:var(--text3);margin-bottom:20px;">Scan this QR code to view all fixtures in this case</div>
    </div>
    ${fixturesInBox.length ? `
      <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:10px;">Fixtures in this case</div>
      ${fixturesInBox.map(f => `
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);">
          <span class="fid">${f.id}</span>
          <span style="flex:1;font-size:13px;font-weight:500;">${f.name}</span>
          <span class="sbadge ${f.status==='available'?'available':'out'}">${f.status==='available'?'In':'Out'}</span>
          <button class="btn btn-blue btn-sm" onclick="openDetailModal('${f.id}')">View</button>
        </div>
      `).join('')}
    ` : '<div style="color:var(--text3);font-size:13px;text-align:center;padding:20px 0;">No fixtures assigned to this case yet.<br><span style="font-size:12px;">Edit a fixture and set its Case/Box field.</span></div>'}
    <div style="margin-top:16px;">
      <button class="btn btn-secondary btn-sm" onclick="printContainerLabel('${cid}')">ğŸ–¨ Print Case Label</button>
    <button class="btn btn-secondary btn-sm" onclick="copyQRLink('container','${cid}')">ğŸ”— Copy Link</button>
    </div>
  `;
  openModal('container-detail-modal');
  setTimeout(() => {
    const el = document.getElementById('cd-qr-wrap-' + cid);
    if (el && !el.querySelector('canvas')) {
      new QRCode(el, { text: containerUrl(cid), width: 150, height: 150, colorDark: '#111', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
    }
  }, 80);
}

async function deleteContainer(cid) {
  if (!confirm('Delete this case? Fixtures will remain but will be unassigned.')) return;
  containers = containers.filter(c => c.id !== cid);
  // Unassign fixtures
  fixtures.forEach(f => { if (f.containerId === cid) { f.containerId = null; saveData({ fixture: f }); } });
  await saveContainers();
  closeModal('container-detail-modal');
  renderContainersPage();
  notify('Case deleted', 'info');
}

function printContainerLabel(cid) {
  const c = containers.find(x => x.id === cid);
  if (!c) return;
  const tmp = document.createElement('div');
  document.body.appendChild(tmp);
  new QRCode(tmp, { text: containerUrl(cid), width: 150, height: 150, colorDark: '#000', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
  setTimeout(() => {
    const canvas = tmp.querySelector('canvas');
    const imgSrc = canvas ? canvas.toDataURL() : '';
    document.body.removeChild(tmp);
    const overlay = document.createElement('div');
    overlay.id = 'print-single-overlay';
    overlay.style.cssText = 'display:none;position:fixed;inset:0;background:#fff;z-index:9999;flex-direction:column;align-items:center;justify-content:center;font-family:Arial,sans-serif;';
    const csEl = document.createElement('style');
    csEl.textContent = [
      '#print-single-overlay{display:flex!important;flex-direction:column;align-items:center;justify-content:center;}',
      '.pso-qr{width:1.25in;height:1.25in;display:block;margin:0 auto;}',
      '.pso-id{font-size:8pt;font-family:monospace;color:#444;margin-top:4pt;text-align:center;}',
      '.pso-name{font-size:10pt;font-weight:bold;color:#111;margin-top:2pt;text-align:center;}',
      '@media print{body > *:not(#print-single-overlay){display:none!important;}#pso-back{display:none!important;}}',
      '#pso-back{position:fixed;top:16px;left:16px;padding:8px 16px;background:#111;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;z-index:10000;}'
    ].join(' ');
    overlay.appendChild(csEl);
    const cbk = document.createElement('button'); cbk.id = 'pso-back'; cbk.textContent = '\u2190 Back'; cbk.onclick = () => overlay.remove(); overlay.appendChild(cbk);
    if (imgSrc) { const img = document.createElement('img'); img.className = 'pso-qr'; img.src = imgSrc; overlay.appendChild(img); }
    const cidDiv = document.createElement('div'); cidDiv.className = 'pso-id'; cidDiv.textContent = c.id; overlay.appendChild(cidDiv);
    const cnmDiv = document.createElement('div'); cnmDiv.className = 'pso-name'; cnmDiv.textContent = c.name; overlay.appendChild(cnmDiv);
    overlay.style.display = 'flex';
    document.body.appendChild(overlay);
    window.addEventListener('afterprint', () => { const el = document.getElementById('print-single-overlay'); if (el) el.remove(); }, { once: true });
    setTimeout(() => window.print(), 150);
  }, 250);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CASE PRINT SELECT MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let casePrintMode = false;
let casePrintSelected = new Set();

function toggleCasePrintMode() {
  casePrintMode = !casePrintMode;
  casePrintSelected.clear();
  const btn = document.getElementById('case-print-select-btn');
  const bar = document.getElementById('case-print-bar');
  const desc = document.getElementById('containers-desc');
  if (casePrintMode) {
    btn.textContent = '\u2715 Cancel';
    bar.style.display = 'flex';
    if (desc) desc.style.display = 'none';
  } else {
    btn.textContent = '\u2611 Select to Print';
    bar.style.display = 'none';
    if (desc) desc.style.display = '';
  }
  renderContainersPage();
}

function toggleCasePrint(cid) {
  haptic('light');
  if (casePrintSelected.has(cid)) casePrintSelected.delete(cid);
  else casePrintSelected.add(cid);
  const card = document.getElementById('cpc-' + cid);
  if (card) {
    card.classList.toggle('cpc-selected', casePrintSelected.has(cid));
    const chk = card.querySelector('.cpc-check');
    if (chk) chk.textContent = casePrintSelected.has(cid) ? '\u2713' : '';
  }
  const el = document.getElementById('case-print-count');
  if (el) el.textContent = casePrintSelected.size + ' selected';
}

function selectAllCases() {
  containers.forEach(c => casePrintSelected.add(c.id));
  renderContainersPage();
  const el = document.getElementById('case-print-count');
  if (el) el.textContent = casePrintSelected.size + ' selected';
}

function clearCaseSelection() {
  casePrintSelected.clear();
  renderContainersPage();
  const el = document.getElementById('case-print-count');
  if (el) el.textContent = '0 selected';
}

async function printSelectedCases() {
  if (!casePrintSelected.size) { notify('No cases selected', 'error'); return; }
  const ids = [...casePrintSelected];
  const overlay = document.createElement('div');
  overlay.id = 'print-single-overlay';
  overlay.style.cssText = 'display:none;position:fixed;inset:0;background:#fff;z-index:9999;font-family:Arial,sans-serif;';

  const sEl = document.createElement('style');
  sEl.textContent = [
    '#print-single-overlay { display:flex !important; flex-wrap:wrap; align-items:flex-start; padding:8pt; gap:6pt; }',
    '.pso-label { display:flex;flex-direction:column;align-items:center;width:1.3in;page-break-inside:avoid; }',
    '.pso-qr { width:1.25in;height:1.25in;display:block; }',
    '.pso-id { font-size:6pt;font-family:monospace;color:#444;margin-top:3pt;text-align:center; }',
    '.pso-name { font-size:7pt;font-weight:bold;color:#111;margin-top:1pt;text-align:center;max-width:1.3in;overflow:hidden;text-overflow:ellipsis;white-space:nowrap; }',
    '@media print { body > *:not(#print-single-overlay) { display:none !important; } #pso-back { display:none !important; } }',
    '#pso-back { position:fixed;top:16px;left:16px;padding:8px 16px;background:#111;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;z-index:10000; }'
  ].join(' ');
  overlay.appendChild(sEl);

  const bk = document.createElement('button');
  bk.id = 'pso-back'; bk.textContent = '\u2190 Back'; bk.onclick = () => overlay.remove();
  overlay.appendChild(bk);

  const qrPromises = ids.map(cid => new Promise(resolve => {
    const c = containers.find(x => x.id === cid);
    if (!c) { resolve(null); return; }
    const tmp = document.createElement('div');
    document.body.appendChild(tmp);
    new QRCode(tmp, { text: containerUrl(cid), width: 120, height: 120, colorDark: '#000', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
    setTimeout(() => {
      const canvas = tmp.querySelector('canvas');
      const imgSrc = canvas ? canvas.toDataURL() : '';
      document.body.removeChild(tmp);
      resolve({ c, imgSrc });
    }, 200);
  }));
  const items = await Promise.all(qrPromises);
  items.filter(Boolean).forEach(({ c, imgSrc }) => {
    const label = document.createElement('div');
    label.className = 'pso-label';
    if (imgSrc) { const img = document.createElement('img'); img.className = 'pso-qr'; img.src = imgSrc; label.appendChild(img); }
    const idEl = document.createElement('div'); idEl.className = 'pso-id'; idEl.textContent = c.id; label.appendChild(idEl);
    const nmEl = document.createElement('div'); nmEl.className = 'pso-name'; nmEl.textContent = c.name; label.appendChild(nmEl);
    overlay.appendChild(label);
  });

  overlay.style.display = 'flex';
  document.body.appendChild(overlay);
  window.addEventListener('afterprint', () => { const el = document.getElementById('print-single-overlay'); if (el) el.remove(); }, { once: true });
  setTimeout(() => window.print(), 300);
}

// Handle container QR scan landing
let _activeCaseLandingId = null;
async function handleContainerScanLanding(forceCid) {
  const cid = forceCid || _activeCaseLandingId || new URLSearchParams(window.location.search).get('box');
  if (!cid) return false;
  _activeCaseLandingId = cid; // remember it for back-button
  await loadData();
  await loadContainers();
  const c = containers.find(x => x.id === cid);
  document.getElementById('scan-landing').style.display = 'block';
  document.getElementById('login-screen').style.display = 'none';
  const dot = document.getElementById('scan-landing-sync-dot');
  if (fbDb) { dot.style.background = 'var(--green)'; }
  const body = document.getElementById('scan-landing-body');
  if (!c) {
    body.innerHTML = `<div style="text-align:center;padding:60px 20px;"><div style="font-size:48px;">ğŸ“¦</div><div style="margin-top:16px;color:var(--text);">Case not found: ${cid}</div></div>`;
    return true;
  }
  const fixturesInBox = fixtures.filter(f => f.containerId === cid);
  body.innerHTML = `
    <div style="margin-bottom:8px;font-family:'DM Mono',monospace;font-size:12px;color:var(--accent);">${c.id}</div>
    <div style="font-size:24px;font-weight:700;margin-bottom:${c.desc?'4':'16'}px;">${c.name}</div>
    ${c.desc ? `<div style="font-size:13px;color:var(--text2);margin-bottom:16px;">${c.desc}</div>` : ''}
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:20px;">
      <div style="font-size:12px;color:var(--text3);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;font-family:'DM Mono',monospace;">${fixturesInBox.length} Fixture${fixturesInBox.length!==1?'s':''}</div>
      ${fixturesInBox.length ? fixturesInBox.map(f => {
        const u = f.checkedOutBy ? users.find(x=>x.id===f.checkedOutBy) : null;
        return `<div onclick="scanLandingOpenFixture('${f.id}','${cid}')" style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer;-webkit-tap-highlight-color:rgba(245,200,66,0.1);">
          <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--accent);background:var(--accent-dim);padding:2px 6px;border-radius:4px;flex-shrink:0;">${f.id}</span>
          <span style="flex:1;font-size:13px;font-weight:500;">${f.name}</span>
          ${u ? `<span style="font-size:11px;color:var(--text2);">${u.avatar||'ğŸ‘¤'}</span>` : ''}
          <span class="sbadge ${f.status==='available'?'available':'out'}" style="flex-shrink:0;">${f.status==='available'?'In':'Out'}</span>
          <span style="color:var(--text3);font-size:14px;">â€º</span>
        </div>`;
      }).join('') : '<div style="color:var(--text3);font-size:13px;padding:12px 0;">No fixtures assigned to this case.</div>'}
    </div>
    <button class="btn btn-secondary" style="width:100%;justify-content:center;padding:12px;" onclick="goToAppFromScan('${cid}')">Open in App</button>
  `;
  cleanScanUrl();
  return true;
}

// Populate container dropdown in edit fixture modal
function populateContainerSelect() {
  const sel = document.getElementById('ef-container');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">â€” Not in a case â€”</option>' +
    containers.map(c => `<option value="${c.id}">${c.name} (${c.id})</option>`).join('');
  if (cur && containers.find(c => c.id === cur)) sel.value = cur;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEEP LINK / NATIVE CAMERA QR SCAN LANDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// State for the scan landing action flow
let scanActionFid = null;
let scanActionType = null; // 'checkout' | 'return' | 'swap'
let scanActionUser = null;

function getScanParam() {
  return new URLSearchParams(window.location.search).get('f');
}

function cleanScanUrl() {
  // Remove ?f= from URL without reload so back button works cleanly
  if (window.history && window.history.replaceState) {
    const clean = window.location.pathname + window.location.hash;
    window.history.replaceState({}, '', clean);
  }
}

async function handleScanLanding() {
  const fid = getScanParam();
  if (!fid) return false; // Not a scan link, normal startup

  // Show landing overlay immediately
  document.getElementById('scan-landing').style.display = 'block';
  document.getElementById('login-screen').style.display = 'none';

  // Sync dot on landing page
  const dot = document.getElementById('scan-landing-sync-dot');

  // Load data (Firebase or local)
  await loadData();

  // Update sync dot
  if (fbDb) { dot.style.background = 'var(--green)'; dot.title = 'Live'; }
  else { dot.style.background = 'var(--text3)'; dot.title = 'Offline'; }

  // Find fixture
  const f = fixtures.find(x => x.id === fid);
  renderScanLanding(f, fid);
  cleanScanUrl();
  return true;
}

function renderScanLanding(f, fid) {
  const body = document.getElementById('scan-landing-body');
  if (!f) {
    body.innerHTML = `
      <div style="text-align:center;padding:60px 20px;">
        <div style="font-size:48px;margin-bottom:16px;">ğŸ”</div>
        <div style="font-size:18px;font-weight:600;color:var(--text);margin-bottom:8px;">Fixture not found</div>
        <div style="font-size:14px;color:var(--text3);">ID: ${fid}</div>
        <button class="btn btn-secondary" style="margin-top:24px;" onclick="document.getElementById('scan-landing').style.display='none';document.getElementById('login-screen').style.display='';">â† Back</button>
      </div>`;
    return;
  }

  const co = f.checkedOutBy ? users.find(x => x.id === f.checkedOutBy) : null;
  const avail = f.status === 'available';
  const typeLabel = f.fixtureType || f.category || '';

  body.innerHTML = `
    <div style="margin-bottom:6px;display:flex;align-items:center;gap:10px;">
      <span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--accent);letter-spacing:1px;">${f.id}</span>
      <span class="sbadge ${avail ? 'available' : 'out'}">${avail ? 'Available' : 'Checked Out'}</span>
    </div>
    <div style="font-size:24px;font-weight:700;color:var(--text);margin-bottom:4px;line-height:1.2;">${f.name}</div>
    ${f.brand ? `<div style="font-size:14px;color:var(--text3);margin-bottom:16px;">${f.brand}${typeLabel ? ' Â· ' + typeLabel : ''}</div>` : ''}

    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:20px;">
      <table style="font-size:13px;border-collapse:collapse;width:100%;">
        ${f.wattage    ? `<tr><td style="padding:5px 0;color:var(--text3);width:100px;">Wattage</td><td style="padding:5px 0;">${f.wattage}</td></tr>` : ''}
        ${f.voltage    ? `<tr><td style="padding:5px 0;color:var(--text3);">Voltage</td><td style="padding:5px 0;">${f.voltage}</td></tr>` : ''}
        ${f.partNo     ? `<tr><td style="padding:5px 0;color:var(--text3);">Part #</td><td style="padding:5px 0;font-family:'DM Mono',monospace;font-size:12px;">${f.partNo}</td></tr>` : ''}
        ${f.location   ? `<tr><td style="padding:5px 0;color:var(--text3);">Location</td><td style="padding:5px 0;">ğŸ“ ${f.location}</td></tr>` : ''}
        ${f.finish     ? `<tr><td style="padding:5px 0;color:var(--text3);">Finish</td><td style="padding:5px 0;">${f.finish}</td></tr>` : ''}
        ${co           ? `<tr><td style="padding:8px 0 0;color:var(--text3);">With</td><td style="padding:8px 0 0;color:var(--red);font-weight:600;">${co.avatar} ${co.name} Â· ${timeAgo(f.checkedOutAt)}</td></tr>` : ''}
      </table>
      ${f.specSheet ? `<a href="${f.specSheet}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;color:var(--accent);font-size:13px;text-decoration:none;margin-top:10px;">ğŸ“„ View Spec Sheet â†—</a>` : ''}
    </div>

    <!-- Action buttons -->
    <div style="display:flex;flex-direction:column;gap:10px;">
      ${avail ? `
        <button class="btn btn-success" style="width:100%;justify-content:center;padding:14px;font-size:16px;" onclick="startScanAction('${f.id}','checkout')">
          â†— Check Out
        </button>
      ` : `
        <button class="btn btn-danger" style="width:100%;justify-content:center;padding:14px;font-size:16px;" onclick="startScanAction('${f.id}','return')">
          â†™ Return to Stock
        </button>
        <button class="btn btn-warning" style="width:100%;justify-content:center;padding:14px;font-size:15px;" onclick="startScanAction('${f.id}','swap')">
          â‡„ Swap / Take Over
        </button>
      `}
      <button class="btn btn-secondary" style="width:100%;justify-content:center;padding:12px;font-size:14px;margin-top:4px;" onclick="goToAppFromScan('${f.id}')">
        Open in App
      </button>
    </div>
  `;
}

function goToAppFromScan(fid) {
  document.getElementById('scan-landing').style.display = 'none';
  sessionStorage.setItem('pendingScanFid', fid);
  // If user already authenticated via PIN this session, skip login screen entirely
  if (scanActionUser) {
    sessionStorage.setItem('pendingScanUserId', scanActionUser.id);
    // Trigger direct login â€” data already loaded
    loginSuccess(scanActionUser);
    return;
  }
  // No auth yet â€” show login screen with user list
  document.getElementById('login-screen').style.display = '';
  renderLoginScreen();
}

// â”€â”€ Action sheet: pick user â†’ enter PIN â†’ execute â”€â”€

function startScanAction(fid, type) {
  scanActionFid = fid;
  scanActionType = type;
  scanActionUser = null;
  showScanUserPicker();
}

function showScanUserPicker() {
  const sheet = document.getElementById('scan-action-sheet');
  const content = document.getElementById('scan-action-content');
  const labels = { checkout: 'Who is checking this out?', return: 'Who is returning this?', swap: 'Who is taking over?' };
  content.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <div style="font-size:17px;font-weight:600;color:var(--text);">${labels[scanActionType]}</div>
      <button onclick="closeScanActionSheet()" style="background:none;border:none;color:var(--text3);font-size:22px;cursor:pointer;padding:0;">Ã—</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;">
      ${users.map(u => `
        <div onclick="selectScanUser('${u.id}')" style="display:flex;flex-direction:column;align-items:center;gap:6px;padding:14px 8px;background:var(--surface3);border:1px solid var(--border2);border-radius:12px;cursor:pointer;transition:all 0.15s;" onmousedown="this.style.borderColor='var(--accent)'" onmouseup="this.style.borderColor='var(--border2)'">
          <span style="font-size:28px;">${u.avatar}</span>
          <span style="font-size:12px;font-weight:500;color:var(--text);text-align:center;word-break:break-word;">${u.name}</span>
          <span style="font-size:9px;font-family:'DM Mono',monospace;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;">${u.role}</span>
        </div>
      `).join('')}
    </div>
  `;
  sheet.style.display = 'block';
}

function selectScanUser(uid) {
  scanActionUser = users.find(u => u.id === uid);
  if (!scanActionUser) return;
  showScanPinPad();
}

function showScanPinPad() {
  const content = document.getElementById('scan-action-content');

  // pinBuf lives on window._scanPinBuf so executeScanAction can reset it on wrong PIN
  window._scanPinBuf = '';

  content.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <button id="scan-pin-back" style="background:none;border:none;color:var(--text3);font-size:16px;cursor:pointer;padding:4px 8px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;">â† Back</button>
      <div style="font-size:17px;font-weight:600;color:var(--text);">Enter PIN</div>
      <button id="scan-pin-close" style="background:none;border:none;color:var(--text3);font-size:24px;cursor:pointer;padding:4px 8px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;">Ã—</button>
    </div>
    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:36px;margin-bottom:4px;">${scanActionUser.avatar}</div>
      <div style="font-size:16px;font-weight:600;color:var(--text);">${scanActionUser.name}</div>
      <div id="scan-pin-dots" style="font-size:24px;letter-spacing:10px;margin-top:16px;color:var(--accent);min-height:36px;">â—‹â—‹â—‹â—‹</div>
      <div id="scan-pin-error" style="font-size:14px;color:var(--red);margin-top:6px;min-height:20px;"></div>
    </div>
    <div class="pin-pad" style="max-width:300px;margin:0 auto;" id="scan-pin-grid"></div>
  `;

  document.getElementById('scan-pin-back').addEventListener('click', showScanUserPicker);
  document.getElementById('scan-pin-close').addEventListener('click', closeScanActionSheet);

  const updateDots = () => {
    const el = document.getElementById('scan-pin-dots');
    if (!el) return;
    const len = window._scanPinBuf.length;
    el.textContent = 'â—'.repeat(len) + 'â—‹'.repeat(Math.max(0, 4 - len));
  };

  const press = (d) => {
    if (d === 'del') {
      window._scanPinBuf = window._scanPinBuf.slice(0, -1);
      haptic('light');
      updateDots();
      return;
    }
    if (window._scanPinBuf.length >= 6) return;
    window._scanPinBuf += d;
    haptic('light');
    updateDots();
    if (window._scanPinBuf.length >= 4) {
      setTimeout(() => executeScanAction(window._scanPinBuf), 150);
    }
  };

  // Build keys using .pin-key CSS class â€” exactly matches main login pad,
  // has touch-action:manipulation and -webkit-tap-highlight-color:transparent built in.
  // touchend + preventDefault stops iOS from firing a delayed synthetic click (no double-fire).
  const grid = document.getElementById('scan-pin-grid');
  ['1','2','3','4','5','6','7','8','9','','0','del'].forEach(k => {
    if (k === '') { grid.appendChild(document.createElement('div')); return; }
    const btn = document.createElement('button');
    btn.className = 'pin-key' + (k === 'del' ? ' del' : '');
    btn.textContent = k === 'del' ? 'âŒ«' : k;
    btn.type = 'button';
    let didTouch = false;
    btn.addEventListener('touchend', (e) => {
      e.preventDefault(); // kills the synthetic mouse-click iOS would fire 300ms later
      didTouch = true;
      press(k);
      setTimeout(() => { didTouch = false; }, 600);
    }, { passive: false });
    btn.addEventListener('click', () => { if (!didTouch) press(k); }); // desktop fallback only
    grid.appendChild(btn);
  });
}


async function executeScanAction(pin) {
  if (pin !== scanActionUser.pin) {
    window._scanPinBuf = ''; // reset so user can try again without reopening
    const errEl = document.getElementById('scan-pin-error');
    if (errEl) errEl.textContent = 'Incorrect PIN â€” try again';
    const dots = document.getElementById('scan-pin-dots');
    if (dots) {
      dots.style.color = 'var(--red)';
      setTimeout(() => {
        dots.style.color = 'var(--accent)';
        dots.textContent = 'â—‹â—‹â—‹â—‹';
        if (errEl) errEl.textContent = '';
      }, 800);
    }
    return;
  }

  const f = fixtures.find(x => x.id === scanActionFid);
  if (!f) return;
  const user = scanActionUser;
  const ts = new Date().toISOString();
  if (!f.comments) f.comments = [];

  if (scanActionType === 'checkout') {
    f.status = 'out';
    f.checkedOutBy = user.id;
    f.checkedOutAt = ts;
    f.comments.push({ ts, userId: user.id, userName: user.name, text: '', action: 'checkout' });
    const ev = { ts, fixtureId: f.id, fixtureName: f.name, userId: user.id, userName: user.name, action: 'checkout' };
    history.unshift(ev);
    await saveData({ fixture: f, historyEntry: ev });

  } else if (scanActionType === 'return') {
    f.comments.push({ ts, userId: user.id, userName: user.name, text: '', action: 'return' });
    f.status = 'available';
    f.checkedOutBy = null;
    f.checkedOutAt = null;
    const ev = { ts, fixtureId: f.id, fixtureName: f.name, userId: user.id, userName: user.name, action: 'return' };
    history.unshift(ev);
    await saveData({ fixture: f, historyEntry: ev });

  } else if (scanActionType === 'swap') {
    const prev = users.find(x => x.id === f.checkedOutBy);
    f.comments.push({ ts, userId: user.id, userName: user.name, text: `taken from ${prev?.name||'unknown'}`, action: 'transfer' });
    f.checkedOutBy = user.id;
    f.checkedOutAt = ts;
    const ev = { ts, fixtureId: f.id, fixtureName: f.name, userId: user.id, userName: user.name, action: 'transfer' };
    history.unshift(ev);
    await saveData({ fixture: f, historyEntry: ev });
  }

  closeScanActionSheet();
  // Store the verified user so "Open in App" can auto-login
  sessionStorage.setItem('scanAuthUserId', user.id);
  // Re-render the landing with updated fixture state
  renderScanLanding(f, f.id);
  // Show success toast
  const msgs = { checkout: `âœ“ Checked out to ${user.name}`, return: `âœ“ Returned by ${user.name}`, swap: `âœ“ Transferred to ${user.name}` };
  const toast = document.createElement('div');
  toast.style.cssText = 'position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:var(--green);color:#000;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:600;z-index:9999;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
  toast.textContent = msgs[scanActionType];
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function closeScanActionSheet() {
  document.getElementById('scan-action-sheet').style.display = 'none';
}

// â”€â”€â”€ Handle pending scan after login (from "Open in App" button) â”€â”€â”€
function checkPendingScan() {
  const fid = sessionStorage.getItem('pendingScanFid');
  if (fid) {
    sessionStorage.removeItem('pendingScanFid');
    sessionStorage.removeItem('pendingScanUserId'); // already consumed via goToAppFromScan
    setTimeout(() => openDetailModal(fid), 400);
  }
}

// Returns the URL that encodes a fixture scan link
function fixtureUrl(id) {
  const base = window.location.href.split('?')[0].split('#')[0];
  return base + '?f=' + encodeURIComponent(id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEBOUNCE UTILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _debTimers = {};
function debounce(key, fn, delay) {
  return function(...args) {
    clearTimeout(_debTimers[key]);
    _debTimers[key] = setTimeout(() => fn.apply(this, args), delay);
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME TOGGLE (dark / light)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyTheme(mode) {
  document.body.classList.toggle('light-mode', mode === 'light');
  localStorage.setItem('luma:theme', mode);
  // Update all theme buttons
  const label = mode === 'light' ? 'ğŸŒ™ Dark Mode' : 'â˜€ Light Mode';
  ['admin-theme-btn','settings-theme-btn','header-theme-btn'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = label;
  });
  // Fix login halo for light mode
  const ls = document.getElementById('login-screen');
  if (ls) ls.style.background = mode === 'light' ? '' : '';
}

function toggleTheme() {
  const current = localStorage.getItem('luma:theme') || 'dark';
  applyTheme(current === 'dark' ? 'light' : 'dark');
}

function initTheme() {
  const saved = localStorage.getItem('luma:theme') || 'dark';
  applyTheme(saved);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COPY QR LINK TO CLIPBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function copyQRLink(type, id) {
  const url = type === 'container' ? containerUrl(id) : fixtureUrl(id);
  try {
    await navigator.clipboard.writeText(url);
    haptic('success');
    notify('ğŸ”— Link copied to clipboard', 'success');
  } catch(e) {
    // Fallback for older browsers/iOS
    const ta = document.createElement('textarea');
    ta.value = url;
    ta.style.cssText = 'position:fixed;opacity:0;';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); notify('ğŸ”— Link copied', 'success'); haptic('success'); }
    catch(e2) { notify('Could not copy: ' + url, 'info'); }
    document.body.removeChild(ta);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BATCH ADD FIXTURES TO CASE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bafcSelectedCase = null;
let bafcSelectedFixtures = new Set();

function openBatchAddFixturesToCase() {
  bafcSelectedCase = null;
  bafcSelectedFixtures.clear();
  // Build modal dynamically
  let existing = document.getElementById('bafc-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.id = 'bafc-modal';
  modal.innerHTML = `
    <div class="modal" style="max-width:580px;">
      <div class="modal-header">
        <div class="modal-title">ğŸ“¦ Add Fixtures to a Case</div>
        <button class="modal-close" onclick="document.getElementById('bafc-modal').remove()">Ã—</button>
      </div>
      <div class="modal-body" style="max-height:75vh;overflow-y:auto;">
        <div class="form-group">
          <label class="form-label">Select Case</label>
          <div style="position:relative;">
            <select class="form-input" id="bafc-case-select" onchange="bafcOnCaseChange()"
              style="-webkit-appearance:none;appearance:none;background:var(--surface2);cursor:pointer;padding-right:32px;">
              <option value="">â€” Choose a case â€”</option>
              ${containers.map(c => {
                const n = fixtures.filter(f => f.containerId === c.id).length;
                return `<option value="${c.id}">${c.name} (${c.id}) Â· ${n} fixture${n!==1?'s':''}</option>`;
              }).join('')}
            </select>
            <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none;font-size:12px;">â–¾</span>
          </div>
        </div>
        <div class="form-group" id="bafc-fixtures-group" style="display:none;">
          <label class="form-label">Available Unassigned Fixtures</label>
          <div class="search-box" style="margin-bottom:8px;">
            <span style="color:var(--text3);">ğŸ”</span>
            <input type="text" id="bafc-search" style="flex:1;background:none;border:none;outline:none;color:var(--text);font-size:14px;padding:8px 0;" placeholder="Search..." oninput="renderBafcList()">
          </div>
          <div id="bafc-fixture-list" style="max-height:240px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm);"></div>
          <div id="bafc-selected-count" style="font-size:12px;color:var(--text3);margin-top:6px;">0 fixtures selected</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('bafc-modal').remove()">Cancel</button>
        <button class="btn btn-primary" id="bafc-add-btn" onclick="bafcConfirm()" style="display:none;">Add to Case</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.style.display = 'flex';
}

function bafcOnCaseChange() {
  const sel = document.getElementById('bafc-case-select');
  bafcSelectedCase = sel.value || null;
  bafcSelectedFixtures.clear();
  const group = document.getElementById('bafc-fixtures-group');
  const addBtn = document.getElementById('bafc-add-btn');
  if (bafcSelectedCase) {
    group.style.display = '';
    renderBafcList();
  } else {
    group.style.display = 'none';
    if (addBtn) addBtn.style.display = 'none';
  }
}

function renderBafcList() {
  const q = (document.getElementById('bafc-search')?.value || '').toLowerCase();
  const avail = fixtures.filter(f =>
    !f.containerId && f.status === 'available' &&
    [f.id, f.name, f.brand, f.location, f.fixtureType].join(' ').toLowerCase().includes(q)
  );
  const list = document.getElementById('bafc-fixture-list');
  const countEl = document.getElementById('bafc-selected-count');
  const addBtn = document.getElementById('bafc-add-btn');
  if (!avail.length) {
    list.innerHTML = '<div style="padding:14px;color:var(--text3);font-size:13px;text-align:center;">No unassigned available fixtures found.</div>';
  } else {
    list.innerHTML = avail.map(f => {
      const sel = bafcSelectedFixtures.has(f.id);
      return `<div onclick="bafcToggle('${f.id}')" style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;background:${sel?'rgba(245,200,66,0.06)':'none'};">
        <div style="width:18px;height:18px;border:2px solid ${sel?'var(--accent)':'var(--border2)'};border-radius:4px;background:${sel?'var(--accent)':'none'};display:flex;align-items:center;justify-content:center;font-size:11px;color:#000;flex-shrink:0;">${sel?'âœ“':''}</div>
        <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--accent);background:var(--accent-dim);padding:2px 6px;border-radius:4px;">${f.id}</span>
        <span style="flex:1;font-size:13px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${f.name}</span>
        ${f.location ? `<span style="font-size:11px;color:var(--text3);white-space:nowrap;">ğŸ“${f.location}</span>` : ''}
      </div>`;
    }).join('');
  }
  if (countEl) countEl.textContent = bafcSelectedFixtures.size + ' fixture' + (bafcSelectedFixtures.size !== 1 ? 's' : '') + ' selected';
  if (addBtn) addBtn.style.display = bafcSelectedFixtures.size > 0 ? '' : 'none';
  if (addBtn) addBtn.textContent = `Add ${bafcSelectedFixtures.size || ''} to Case`;
}

function bafcToggle(fid) {
  haptic('light');
  if (bafcSelectedFixtures.has(fid)) bafcSelectedFixtures.delete(fid);
  else bafcSelectedFixtures.add(fid);
  renderBafcList();
}

async function bafcConfirm() {
  if (!bafcSelectedCase || !bafcSelectedFixtures.size) return;
  const c = containers.find(x => x.id === bafcSelectedCase);
  let count = 0;
  for (const fid of bafcSelectedFixtures) {
    const f = fixtures.find(x => x.id === fid);
    if (f) { f.containerId = bafcSelectedCase; await saveData({ fixture: f }); count++; }
  }
  const modal = document.getElementById('bafc-modal');
  if (modal) modal.remove();
  renderContainersPage();
  haptic('success');
  notify(`âœ“ Added ${count} fixture${count!==1?'s':''} to ${c?.name || bafcSelectedCase}`, 'success');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIN PAGE QUICK SCAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loginPageQuickScan() {
  // Use native camera via hidden file input â€” instant, no permission loop, iOS native quality
  let inp = document.getElementById('login-camera-input');
  if (!inp) {
    inp = document.createElement('input');
    inp.id = 'login-camera-input';
    inp.type = 'file';
    inp.accept = 'image/*';
    inp.capture = 'environment';
    inp.style.display = 'none';
    inp.addEventListener('change', async function() {
      const file = this.files && this.files[0];
      if (!file) return;
      this.value = '';
      // Show processing indicator
      const btn = document.getElementById('login-scan-btn');
      const origText = btn ? btn.innerHTML : '';
      if (btn) btn.innerHTML = '<span style="font-size:16px;">â³</span> Readingâ€¦';
      try {
        const bitmap = await createImageBitmap(file);
        const canvas = document.createElement('canvas');
        const MAX = 1024;
        const scale = Math.min(1, MAX / Math.max(bitmap.width, bitmap.height));
        canvas.width  = Math.round(bitmap.width  * scale);
        canvas.height = Math.round(bitmap.height * scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'dontInvert' });
        if (!code) code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'onlyInvert' });

        if (btn) btn.innerHTML = origText;

        if (code) {
          // Navigate to the deep-link landing page
          let raw = code.data.trim();
          let redirect = '';
          try {
            const url = new URL(raw);
            const fParam = url.searchParams.get('f');
            const boxParam = url.searchParams.get('box');
            if (fParam) redirect = '?f=' + encodeURIComponent(fParam);
            else if (boxParam) redirect = '?box=' + encodeURIComponent(boxParam);
          } catch(e) {
            if (raw.startsWith('BOX-')) redirect = '?box=' + encodeURIComponent(raw);
            else redirect = '?f=' + encodeURIComponent(raw);
          }
          if (redirect) window.location.href = window.location.pathname + redirect;
        } else {
          if (btn) btn.innerHTML = origText;
          alert('No QR code found in photo. Try again with better lighting.');
        }
      } catch(e) {
        if (btn) btn.innerHTML = origText;
      }
    });
    document.body.appendChild(inp);
  }
  inp.value = '';
  inp.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CASE SCAN LANDING â€” FIXTURE DETAIL PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scanLandingOpenFixture(fid, cid) {
  const f = fixtures.find(x => x.id === fid);
  if (!f) return;
  const u = f.checkedOutBy ? users.find(x => x.id === f.checkedOutBy) : null;
  
  // Build detail panel over scan-landing-body
  const body = document.getElementById('scan-landing-body');
  const savedScrollY = document.getElementById('scan-landing').scrollTop;
  body.setAttribute('data-case-scroll', savedScrollY);
  body.setAttribute('data-case-id', cid);
  
  body.innerHTML = `
    <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--accent);background:var(--accent-dim);display:inline-block;padding:3px 8px;border-radius:5px;margin-bottom:8px;">${f.id}</div>
    <div style="font-size:22px;font-weight:700;margin-bottom:4px;">${f.name}</div>
    ${f.brand ? `<div style="font-size:13px;color:var(--text2);margin-bottom:12px;">${f.brand}</div>` : ''}
    <div style="margin-bottom:16px;">
      <span class="sbadge ${f.status==='available'?'available':'out'}" style="font-size:12px;">${f.status==='available'?'Available':'Checked Out'}</span>
      ${u ? `<span style="font-size:13px;color:var(--text2);margin-left:10px;">${u.avatar||'ğŸ‘¤'} ${u.name}</span>` : ''}
    </div>
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:20px;">
      ${f.fixtureType||f.category ? `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span style="color:var(--text3);font-size:13px;">Type</span><span style="font-size:13px;">${f.fixtureType||f.category}</span></div>` : ''}
      ${f.wattage ? `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span style="color:var(--text3);font-size:13px;">Wattage</span><span style="font-size:13px;">${f.wattage}</span></div>` : ''}
      ${f.location ? `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span style="color:var(--text3);font-size:13px;">Location</span><span style="font-size:13px;">${f.location}</span></div>` : ''}
      ${f.partNo ? `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span style="color:var(--text3);font-size:13px;">Part #</span><span style="font-size:13px;font-family:'DM Mono',monospace;">${f.partNo}</span></div>` : ''}
      ${f.specSheet ? `<div style="padding:8px 0;"><a href="${f.specSheet}" target="_blank" style="color:var(--accent);text-decoration:none;font-size:13px;">ğŸ“„ View Spec Sheet â†—</a></div>` : ''}
    </div>
    <button onclick="scanLandingBackToCase()" class="btn btn-secondary" style="width:100%;justify-content:center;padding:13px;">â† Back to Case</button>
  `;
  document.getElementById('scan-landing').scrollTop = 0;
}

function scanLandingBackToCase() {
  const body = document.getElementById('scan-landing-body');
  const cid = body.getAttribute('data-case-id') || _activeCaseLandingId;
  const scrollY = parseInt(body.getAttribute('data-case-scroll') || '0');
  if (cid) {
    handleContainerScanLanding(cid).then(() => {
      setTimeout(() => { document.getElementById('scan-landing').scrollTop = scrollY; }, 50);
    });
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN INLINE FIREBASE CONNECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function adminConnectFirebase() {
  const input = document.getElementById('admin-project-id');
  const feedback = document.getElementById('admin-connect-feedback');
  const pid = (input?.value || '').trim();
  if (!pid) { notify('Enter a Firebase Project ID', 'error'); return; }
  // Mirror to setup field and reuse connectFromSetup logic
  const setupInput = document.getElementById('setup-project-id');
  if (setupInput) setupInput.value = pid;
  feedback.style.display = 'block';
  feedback.style.background = 'var(--surface3)';
  feedback.textContent = 'Connectingâ€¦';
  try {
    await connectFromSetup();
    feedback.style.display = 'none';
  } catch(e) {
    feedback.style.background = 'var(--red-dim)';
    feedback.textContent = 'Connection failed: ' + e.message;
  }
}

function adminDisconnectFirebase() {
  disconnectFromSetup();
  renderGsStatus();
}




async function init() {
  initTheme();
  detectAndApplyLayout();
  window.addEventListener('resize', detectAndApplyLayout);
  // Check for container scan (?box=BOX-xxxx)
  const isContainerScan = await handleContainerScanLanding();
  if (isContainerScan) return;
  // Check for native camera QR scan link (?f=FL-xxxx)
  const isDeepLink = await handleScanLanding();
  if (isDeepLink) return;
  await loadData();
  await loadContainers();
  renderLoginScreen();
}

init();
</script>
</body>
</html>
